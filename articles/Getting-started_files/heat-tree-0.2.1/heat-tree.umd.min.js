!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).HeatTree={})}(this,function(t){"use strict";var e={value:()=>{}};function n(){for(var t,e=0,n=arguments.length,a={};e<n;++e){if(!(t=arguments[e]+"")||t in a||/[\s.]/.test(t))throw new Error("illegal type: "+t);a[t]=[]}return new i(a)}function i(t){this._=t}function a(t,e){for(var n,i=0,a=t.length;i<a;++i)if((n=t[i]).name===e)return n.value}function o(t,n,i){for(var a=0,o=t.length;a<o;++a)if(t[a].name===n){t[a]=e,t=t.slice(0,a).concat(t.slice(a+1));break}return null!=i&&t.push({name:n,value:i}),t}i.prototype=n.prototype={constructor:i,on:function(t,e){var n,i,s=this._,r=(i=s,(t+"").trim().split(/^|\s+/).map(function(t){var e="",n=t.indexOf(".");if(n>=0&&(e=t.slice(n+1),t=t.slice(0,n)),t&&!i.hasOwnProperty(t))throw new Error("unknown type: "+t);return{type:t,name:e}})),l=-1,h=r.length;if(!(arguments.length<2)){if(null!=e&&"function"!=typeof e)throw new Error("invalid callback: "+e);for(;++l<h;)if(n=(t=r[l]).type)s[n]=o(s[n],t.name,e);else if(null==e)for(n in s)s[n]=o(s[n],t.name,null);return this}for(;++l<h;)if((n=(t=r[l]).type)&&(n=a(s[n],t.name)))return n},copy:function(){var t={},e=this._;for(var n in e)t[n]=e[n].slice();return new i(t)},call:function(t,e){if((n=arguments.length-2)>0)for(var n,i,a=new Array(n),o=0;o<n;++o)a[o]=arguments[o+2];if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(o=0,n=(i=this._[t]).length;o<n;++o)i[o].value.apply(e,a)},apply:function(t,e,n){if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(var i=this._[t],a=0,o=i.length;a<o;++a)i[a].value.apply(e,n)}};var s="http://www.w3.org/1999/xhtml";const r={svg:"http://www.w3.org/2000/svg",xhtml:s,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function l(t){var e=t+="",n=e.indexOf(":");return n>=0&&"xmlns"!==(e=t.slice(0,n))&&(t=t.slice(n+1)),r.hasOwnProperty(e)?{space:r[e],local:t}:t}function h(t){return function(){var e=this.ownerDocument,n=this.namespaceURI;return n===s&&e.documentElement.namespaceURI===s?e.createElement(t):e.createElementNS(n,t)}}function c(t){return function(){return this.ownerDocument.createElementNS(t.space,t.local)}}function u(t){var e=l(t);return(e.local?c:h)(e)}function d(){}function p(t){return null==t?d:function(){return this.querySelector(t)}}function f(){return[]}function g(t){return null==t?f:function(){return this.querySelectorAll(t)}}function m(t){return function(){return null==(e=t.apply(this,arguments))?[]:Array.isArray(e)?e:Array.from(e);var e}}function y(t){return function(){return this.matches(t)}}function b(t){return function(e){return e.matches(t)}}var x=Array.prototype.find;function v(){return this.firstElementChild}var w=Array.prototype.filter;function _(){return Array.from(this.children)}function C(t){return new Array(t.length)}function k(t,e){this.ownerDocument=t.ownerDocument,this.namespaceURI=t.namespaceURI,this._next=null,this._parent=t,this.__data__=e}function S(t,e,n,i,a,o){for(var s,r=0,l=e.length,h=o.length;r<h;++r)(s=e[r])?(s.__data__=o[r],i[r]=s):n[r]=new k(t,o[r]);for(;r<l;++r)(s=e[r])&&(a[r]=s)}function L(t,e,n,i,a,o,s){var r,l,h,c=new Map,u=e.length,d=o.length,p=new Array(u);for(r=0;r<u;++r)(l=e[r])&&(p[r]=h=s.call(l,l.__data__,r,e)+"",c.has(h)?a[r]=l:c.set(h,l));for(r=0;r<d;++r)h=s.call(t,o[r],r,o)+"",(l=c.get(h))?(i[r]=l,l.__data__=o[r],c.delete(h)):n[r]=new k(t,o[r]);for(r=0;r<u;++r)(l=e[r])&&c.get(p[r])===l&&(a[r]=l)}function P(t){return t.__data__}function M(t){return"object"==typeof t&&"length"in t?t:Array.from(t)}function T(t,e){return t<e?-1:t>e?1:t>=e?0:NaN}function E(t){return function(){this.removeAttribute(t)}}function z(t){return function(){this.removeAttributeNS(t.space,t.local)}}function $(t,e){return function(){this.setAttribute(t,e)}}function N(t,e){return function(){this.setAttributeNS(t.space,t.local,e)}}function A(t,e){return function(){var n=e.apply(this,arguments);null==n?this.removeAttribute(t):this.setAttribute(t,n)}}function R(t,e){return function(){var n=e.apply(this,arguments);null==n?this.removeAttributeNS(t.space,t.local):this.setAttributeNS(t.space,t.local,n)}}function H(t){return t.ownerDocument&&t.ownerDocument.defaultView||t.document&&t||t.defaultView}function B(t){return function(){this.style.removeProperty(t)}}function D(t,e,n){return function(){this.style.setProperty(t,e,n)}}function F(t,e,n){return function(){var i=e.apply(this,arguments);null==i?this.style.removeProperty(t):this.style.setProperty(t,i,n)}}function I(t,e){return t.style.getPropertyValue(e)||H(t).getComputedStyle(t,null).getPropertyValue(e)}function V(t){return function(){delete this[t]}}function q(t,e){return function(){this[t]=e}}function X(t,e){return function(){var n=e.apply(this,arguments);null==n?delete this[t]:this[t]=n}}function O(t){return t.trim().split(/^|\s+/)}function Y(t){return t.classList||new j(t)}function j(t){this._node=t,this._names=O(t.getAttribute("class")||"")}function G(t,e){for(var n=Y(t),i=-1,a=e.length;++i<a;)n.add(e[i])}function Z(t,e){for(var n=Y(t),i=-1,a=e.length;++i<a;)n.remove(e[i])}function U(t){return function(){G(this,t)}}function W(t){return function(){Z(this,t)}}function K(t,e){return function(){(e.apply(this,arguments)?G:Z)(this,t)}}function Q(){this.textContent=""}function J(t){return function(){this.textContent=t}}function tt(t){return function(){var e=t.apply(this,arguments);this.textContent=null==e?"":e}}function et(){this.innerHTML=""}function nt(t){return function(){this.innerHTML=t}}function it(t){return function(){var e=t.apply(this,arguments);this.innerHTML=null==e?"":e}}function at(){this.nextSibling&&this.parentNode.appendChild(this)}function ot(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function st(){return null}function rt(){var t=this.parentNode;t&&t.removeChild(this)}function lt(){var t=this.cloneNode(!1),e=this.parentNode;return e?e.insertBefore(t,this.nextSibling):t}function ht(){var t=this.cloneNode(!0),e=this.parentNode;return e?e.insertBefore(t,this.nextSibling):t}function ct(t){return function(){var e=this.__on;if(e){for(var n,i=0,a=-1,o=e.length;i<o;++i)n=e[i],t.type&&n.type!==t.type||n.name!==t.name?e[++a]=n:this.removeEventListener(n.type,n.listener,n.options);++a?e.length=a:delete this.__on}}}function ut(t,e,n){return function(){var i,a=this.__on,o=function(t){return function(e){t.call(this,e,this.__data__)}}(e);if(a)for(var s=0,r=a.length;s<r;++s)if((i=a[s]).type===t.type&&i.name===t.name)return this.removeEventListener(i.type,i.listener,i.options),this.addEventListener(i.type,i.listener=o,i.options=n),void(i.value=e);this.addEventListener(t.type,o,n),i={type:t.type,name:t.name,value:e,listener:o,options:n},a?a.push(i):this.__on=[i]}}function dt(t,e,n){var i=H(t),a=i.CustomEvent;"function"==typeof a?a=new a(e,n):(a=i.document.createEvent("Event"),n?(a.initEvent(e,n.bubbles,n.cancelable),a.detail=n.detail):a.initEvent(e,!1,!1)),t.dispatchEvent(a)}function pt(t,e){return function(){return dt(this,t,e)}}function ft(t,e){return function(){return dt(this,t,e.apply(this,arguments))}}k.prototype={constructor:k,appendChild:function(t){return this._parent.insertBefore(t,this._next)},insertBefore:function(t,e){return this._parent.insertBefore(t,e)},querySelector:function(t){return this._parent.querySelector(t)},querySelectorAll:function(t){return this._parent.querySelectorAll(t)}},j.prototype={add:function(t){this._names.indexOf(t)<0&&(this._names.push(t),this._node.setAttribute("class",this._names.join(" ")))},remove:function(t){var e=this._names.indexOf(t);e>=0&&(this._names.splice(e,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(t){return this._names.indexOf(t)>=0}};var gt=[null];function mt(t,e){this._groups=t,this._parents=e}function yt(){return new mt([[document.documentElement]],gt)}function bt(t){return"string"==typeof t?new mt([[document.querySelector(t)]],[document.documentElement]):new mt([[t]],gt)}function xt(t,e){if(t=function(t){let e;for(;e=t.sourceEvent;)t=e;return t}(t),void 0===e&&(e=t.currentTarget),e){var n=e.ownerSVGElement||e;if(n.createSVGPoint){var i=n.createSVGPoint();return i.x=t.clientX,i.y=t.clientY,[(i=i.matrixTransform(e.getScreenCTM().inverse())).x,i.y]}if(e.getBoundingClientRect){var a=e.getBoundingClientRect();return[t.clientX-a.left-e.clientLeft,t.clientY-a.top-e.clientTop]}}return[t.pageX,t.pageY]}mt.prototype=yt.prototype={constructor:mt,select:function(t){"function"!=typeof t&&(t=p(t));for(var e=this._groups,n=e.length,i=new Array(n),a=0;a<n;++a)for(var o,s,r=e[a],l=r.length,h=i[a]=new Array(l),c=0;c<l;++c)(o=r[c])&&(s=t.call(o,o.__data__,c,r))&&("__data__"in o&&(s.__data__=o.__data__),h[c]=s);return new mt(i,this._parents)},selectAll:function(t){t="function"==typeof t?m(t):g(t);for(var e=this._groups,n=e.length,i=[],a=[],o=0;o<n;++o)for(var s,r=e[o],l=r.length,h=0;h<l;++h)(s=r[h])&&(i.push(t.call(s,s.__data__,h,r)),a.push(s));return new mt(i,a)},selectChild:function(t){return this.select(null==t?v:function(t){return function(){return x.call(this.children,t)}}("function"==typeof t?t:b(t)))},selectChildren:function(t){return this.selectAll(null==t?_:function(t){return function(){return w.call(this.children,t)}}("function"==typeof t?t:b(t)))},filter:function(t){"function"!=typeof t&&(t=y(t));for(var e=this._groups,n=e.length,i=new Array(n),a=0;a<n;++a)for(var o,s=e[a],r=s.length,l=i[a]=[],h=0;h<r;++h)(o=s[h])&&t.call(o,o.__data__,h,s)&&l.push(o);return new mt(i,this._parents)},data:function(t,e){if(!arguments.length)return Array.from(this,P);var n,i=e?L:S,a=this._parents,o=this._groups;"function"!=typeof t&&(n=t,t=function(){return n});for(var s=o.length,r=new Array(s),l=new Array(s),h=new Array(s),c=0;c<s;++c){var u=a[c],d=o[c],p=d.length,f=M(t.call(u,u&&u.__data__,c,a)),g=f.length,m=l[c]=new Array(g),y=r[c]=new Array(g);i(u,d,m,y,h[c]=new Array(p),f,e);for(var b,x,v=0,w=0;v<g;++v)if(b=m[v]){for(v>=w&&(w=v+1);!(x=y[w])&&++w<g;);b._next=x||null}}return(r=new mt(r,a))._enter=l,r._exit=h,r},enter:function(){return new mt(this._enter||this._groups.map(C),this._parents)},exit:function(){return new mt(this._exit||this._groups.map(C),this._parents)},join:function(t,e,n){var i=this.enter(),a=this,o=this.exit();return"function"==typeof t?(i=t(i))&&(i=i.selection()):i=i.append(t+""),null!=e&&(a=e(a))&&(a=a.selection()),null==n?o.remove():n(o),i&&a?i.merge(a).order():a},merge:function(t){for(var e=t.selection?t.selection():t,n=this._groups,i=e._groups,a=n.length,o=i.length,s=Math.min(a,o),r=new Array(a),l=0;l<s;++l)for(var h,c=n[l],u=i[l],d=c.length,p=r[l]=new Array(d),f=0;f<d;++f)(h=c[f]||u[f])&&(p[f]=h);for(;l<a;++l)r[l]=n[l];return new mt(r,this._parents)},selection:function(){return this},order:function(){for(var t=this._groups,e=-1,n=t.length;++e<n;)for(var i,a=t[e],o=a.length-1,s=a[o];--o>=0;)(i=a[o])&&(s&&4^i.compareDocumentPosition(s)&&s.parentNode.insertBefore(i,s),s=i);return this},sort:function(t){function e(e,n){return e&&n?t(e.__data__,n.__data__):!e-!n}t||(t=T);for(var n=this._groups,i=n.length,a=new Array(i),o=0;o<i;++o){for(var s,r=n[o],l=r.length,h=a[o]=new Array(l),c=0;c<l;++c)(s=r[c])&&(h[c]=s);h.sort(e)}return new mt(a,this._parents).order()},call:function(){var t=arguments[0];return arguments[0]=this,t.apply(null,arguments),this},nodes:function(){return Array.from(this)},node:function(){for(var t=this._groups,e=0,n=t.length;e<n;++e)for(var i=t[e],a=0,o=i.length;a<o;++a){var s=i[a];if(s)return s}return null},size:function(){let t=0;for(const e of this)++t;return t},empty:function(){return!this.node()},each:function(t){for(var e=this._groups,n=0,i=e.length;n<i;++n)for(var a,o=e[n],s=0,r=o.length;s<r;++s)(a=o[s])&&t.call(a,a.__data__,s,o);return this},attr:function(t,e){var n=l(t);if(arguments.length<2){var i=this.node();return n.local?i.getAttributeNS(n.space,n.local):i.getAttribute(n)}return this.each((null==e?n.local?z:E:"function"==typeof e?n.local?R:A:n.local?N:$)(n,e))},style:function(t,e,n){return arguments.length>1?this.each((null==e?B:"function"==typeof e?F:D)(t,e,null==n?"":n)):I(this.node(),t)},property:function(t,e){return arguments.length>1?this.each((null==e?V:"function"==typeof e?X:q)(t,e)):this.node()[t]},classed:function(t,e){var n=O(t+"");if(arguments.length<2){for(var i=Y(this.node()),a=-1,o=n.length;++a<o;)if(!i.contains(n[a]))return!1;return!0}return this.each(("function"==typeof e?K:e?U:W)(n,e))},text:function(t){return arguments.length?this.each(null==t?Q:("function"==typeof t?tt:J)(t)):this.node().textContent},html:function(t){return arguments.length?this.each(null==t?et:("function"==typeof t?it:nt)(t)):this.node().innerHTML},raise:function(){return this.each(at)},lower:function(){return this.each(ot)},append:function(t){var e="function"==typeof t?t:u(t);return this.select(function(){return this.appendChild(e.apply(this,arguments))})},insert:function(t,e){var n="function"==typeof t?t:u(t),i=null==e?st:"function"==typeof e?e:p(e);return this.select(function(){return this.insertBefore(n.apply(this,arguments),i.apply(this,arguments)||null)})},remove:function(){return this.each(rt)},clone:function(t){return this.select(t?ht:lt)},datum:function(t){return arguments.length?this.property("__data__",t):this.node().__data__},on:function(t,e,n){var i,a,o=function(t){return t.trim().split(/^|\s+/).map(function(t){var e="",n=t.indexOf(".");return n>=0&&(e=t.slice(n+1),t=t.slice(0,n)),{type:t,name:e}})}(t+""),s=o.length;if(!(arguments.length<2)){for(r=e?ut:ct,i=0;i<s;++i)this.each(r(o[i],e,n));return this}var r=this.node().__on;if(r)for(var l,h=0,c=r.length;h<c;++h)for(i=0,l=r[h];i<s;++i)if((a=o[i]).type===l.type&&a.name===l.name)return l.value},dispatch:function(t,e){return this.each(("function"==typeof e?ft:pt)(t,e))},[Symbol.iterator]:function*(){for(var t=this._groups,e=0,n=t.length;e<n;++e)for(var i,a=t[e],o=0,s=a.length;o<s;++o)(i=a[o])&&(yield i)}};const vt={capture:!0,passive:!1};function wt(t){t.preventDefault(),t.stopImmediatePropagation()}function _t(t,e,n){t.prototype=e.prototype=n,n.constructor=t}function Ct(t,e){var n=Object.create(t.prototype);for(var i in e)n[i]=e[i];return n}function kt(){}var St=.7,Lt=1/St,Pt="\\s*([+-]?\\d+)\\s*",Mt="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",Tt="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",Et=/^#([0-9a-f]{3,8})$/,zt=new RegExp(`^rgb\\(${Pt},${Pt},${Pt}\\)$`),$t=new RegExp(`^rgb\\(${Tt},${Tt},${Tt}\\)$`),Nt=new RegExp(`^rgba\\(${Pt},${Pt},${Pt},${Mt}\\)$`),At=new RegExp(`^rgba\\(${Tt},${Tt},${Tt},${Mt}\\)$`),Rt=new RegExp(`^hsl\\(${Mt},${Tt},${Tt}\\)$`),Ht=new RegExp(`^hsla\\(${Mt},${Tt},${Tt},${Mt}\\)$`),Bt={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};function Dt(){return this.rgb().formatHex()}function Ft(){return this.rgb().formatRgb()}function It(t){var e,n;return t=(t+"").trim().toLowerCase(),(e=Et.exec(t))?(n=e[1].length,e=parseInt(e[1],16),6===n?Vt(e):3===n?new Ot(e>>8&15|e>>4&240,e>>4&15|240&e,(15&e)<<4|15&e,1):8===n?qt(e>>24&255,e>>16&255,e>>8&255,(255&e)/255):4===n?qt(e>>12&15|e>>8&240,e>>8&15|e>>4&240,e>>4&15|240&e,((15&e)<<4|15&e)/255):null):(e=zt.exec(t))?new Ot(e[1],e[2],e[3],1):(e=$t.exec(t))?new Ot(255*e[1]/100,255*e[2]/100,255*e[3]/100,1):(e=Nt.exec(t))?qt(e[1],e[2],e[3],e[4]):(e=At.exec(t))?qt(255*e[1]/100,255*e[2]/100,255*e[3]/100,e[4]):(e=Rt.exec(t))?Wt(e[1],e[2]/100,e[3]/100,1):(e=Ht.exec(t))?Wt(e[1],e[2]/100,e[3]/100,e[4]):Bt.hasOwnProperty(t)?Vt(Bt[t]):"transparent"===t?new Ot(NaN,NaN,NaN,0):null}function Vt(t){return new Ot(t>>16&255,t>>8&255,255&t,1)}function qt(t,e,n,i){return i<=0&&(t=e=n=NaN),new Ot(t,e,n,i)}function Xt(t,e,n,i){return 1===arguments.length?((a=t)instanceof kt||(a=It(a)),a?new Ot((a=a.rgb()).r,a.g,a.b,a.opacity):new Ot):new Ot(t,e,n,null==i?1:i);var a}function Ot(t,e,n,i){this.r=+t,this.g=+e,this.b=+n,this.opacity=+i}function Yt(){return`#${Ut(this.r)}${Ut(this.g)}${Ut(this.b)}`}function jt(){const t=Gt(this.opacity);return`${1===t?"rgb(":"rgba("}${Zt(this.r)}, ${Zt(this.g)}, ${Zt(this.b)}${1===t?")":`, ${t})`}`}function Gt(t){return isNaN(t)?1:Math.max(0,Math.min(1,t))}function Zt(t){return Math.max(0,Math.min(255,Math.round(t)||0))}function Ut(t){return((t=Zt(t))<16?"0":"")+t.toString(16)}function Wt(t,e,n,i){return i<=0?t=e=n=NaN:n<=0||n>=1?t=e=NaN:e<=0&&(t=NaN),new Qt(t,e,n,i)}function Kt(t){if(t instanceof Qt)return new Qt(t.h,t.s,t.l,t.opacity);if(t instanceof kt||(t=It(t)),!t)return new Qt;if(t instanceof Qt)return t;var e=(t=t.rgb()).r/255,n=t.g/255,i=t.b/255,a=Math.min(e,n,i),o=Math.max(e,n,i),s=NaN,r=o-a,l=(o+a)/2;return r?(s=e===o?(n-i)/r+6*(n<i):n===o?(i-e)/r+2:(e-n)/r+4,r/=l<.5?o+a:2-o-a,s*=60):r=l>0&&l<1?0:s,new Qt(s,r,l,t.opacity)}function Qt(t,e,n,i){this.h=+t,this.s=+e,this.l=+n,this.opacity=+i}function Jt(t){return(t=(t||0)%360)<0?t+360:t}function te(t){return Math.max(0,Math.min(1,t||0))}function ee(t,e,n){return 255*(t<60?e+(n-e)*t/60:t<180?n:t<240?e+(n-e)*(240-t)/60:e)}_t(kt,It,{copy(t){return Object.assign(new this.constructor,this,t)},displayable(){return this.rgb().displayable()},hex:Dt,formatHex:Dt,formatHex8:function(){return this.rgb().formatHex8()},formatHsl:function(){return Kt(this).formatHsl()},formatRgb:Ft,toString:Ft}),_t(Ot,Xt,Ct(kt,{brighter(t){return t=null==t?Lt:Math.pow(Lt,t),new Ot(this.r*t,this.g*t,this.b*t,this.opacity)},darker(t){return t=null==t?St:Math.pow(St,t),new Ot(this.r*t,this.g*t,this.b*t,this.opacity)},rgb(){return this},clamp(){return new Ot(Zt(this.r),Zt(this.g),Zt(this.b),Gt(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:Yt,formatHex:Yt,formatHex8:function(){return`#${Ut(this.r)}${Ut(this.g)}${Ut(this.b)}${Ut(255*(isNaN(this.opacity)?1:this.opacity))}`},formatRgb:jt,toString:jt})),_t(Qt,function(t,e,n,i){return 1===arguments.length?Kt(t):new Qt(t,e,n,null==i?1:i)},Ct(kt,{brighter(t){return t=null==t?Lt:Math.pow(Lt,t),new Qt(this.h,this.s,this.l*t,this.opacity)},darker(t){return t=null==t?St:Math.pow(St,t),new Qt(this.h,this.s,this.l*t,this.opacity)},rgb(){var t=this.h%360+360*(this.h<0),e=isNaN(t)||isNaN(this.s)?0:this.s,n=this.l,i=n+(n<.5?n:1-n)*e,a=2*n-i;return new Ot(ee(t>=240?t-240:t+120,a,i),ee(t,a,i),ee(t<120?t+240:t-120,a,i),this.opacity)},clamp(){return new Qt(Jt(this.h),te(this.s),te(this.l),Gt(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const t=Gt(this.opacity);return`${1===t?"hsl(":"hsla("}${Jt(this.h)}, ${100*te(this.s)}%, ${100*te(this.l)}%${1===t?")":`, ${t})`}`}}));const ne=t=>()=>t;function ie(t){return 1===(t=+t)?ae:function(e,n){return n-e?function(t,e,n){return t=Math.pow(t,n),e=Math.pow(e,n)-t,n=1/n,function(i){return Math.pow(t+i*e,n)}}(e,n,t):ne(isNaN(e)?n:e)}}function ae(t,e){var n=e-t;return n?function(t,e){return function(n){return t+n*e}}(t,n):ne(isNaN(t)?e:t)}const oe=function t(e){var n=ie(e);function i(t,e){var i=n((t=Xt(t)).r,(e=Xt(e)).r),a=n(t.g,e.g),o=n(t.b,e.b),s=ae(t.opacity,e.opacity);return function(e){return t.r=i(e),t.g=a(e),t.b=o(e),t.opacity=s(e),t+""}}return i.gamma=t,i}(1);function se(t,e){return t=+t,e=+e,function(n){return t*(1-n)+e*n}}var re=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,le=new RegExp(re.source,"g");function he(t,e){var n,i,a,o=re.lastIndex=le.lastIndex=0,s=-1,r=[],l=[];for(t+="",e+="";(n=re.exec(t))&&(i=le.exec(e));)(a=i.index)>o&&(a=e.slice(o,a),r[s]?r[s]+=a:r[++s]=a),(n=n[0])===(i=i[0])?r[s]?r[s]+=i:r[++s]=i:(r[++s]=null,l.push({i:s,x:se(n,i)})),o=le.lastIndex;return o<e.length&&(a=e.slice(o),r[s]?r[s]+=a:r[++s]=a),r.length<2?l[0]?function(t){return function(e){return t(e)+""}}(l[0].x):function(t){return function(){return t}}(e):(e=l.length,function(t){for(var n,i=0;i<e;++i)r[(n=l[i]).i]=n.x(t);return r.join("")})}var ce,ue=180/Math.PI,de={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function pe(t,e,n,i,a,o){var s,r,l;return(s=Math.sqrt(t*t+e*e))&&(t/=s,e/=s),(l=t*n+e*i)&&(n-=t*l,i-=e*l),(r=Math.sqrt(n*n+i*i))&&(n/=r,i/=r,l/=r),t*i<e*n&&(t=-t,e=-e,l=-l,s=-s),{translateX:a,translateY:o,rotate:Math.atan2(e,t)*ue,skewX:Math.atan(l)*ue,scaleX:s,scaleY:r}}function fe(t,e,n,i){function a(t){return t.length?t.pop()+" ":""}return function(o,s){var r=[],l=[];return o=t(o),s=t(s),function(t,i,a,o,s,r){if(t!==a||i!==o){var l=s.push("translate(",null,e,null,n);r.push({i:l-4,x:se(t,a)},{i:l-2,x:se(i,o)})}else(a||o)&&s.push("translate("+a+e+o+n)}(o.translateX,o.translateY,s.translateX,s.translateY,r,l),function(t,e,n,o){t!==e?(t-e>180?e+=360:e-t>180&&(t+=360),o.push({i:n.push(a(n)+"rotate(",null,i)-2,x:se(t,e)})):e&&n.push(a(n)+"rotate("+e+i)}(o.rotate,s.rotate,r,l),function(t,e,n,o){t!==e?o.push({i:n.push(a(n)+"skewX(",null,i)-2,x:se(t,e)}):e&&n.push(a(n)+"skewX("+e+i)}(o.skewX,s.skewX,r,l),function(t,e,n,i,o,s){if(t!==n||e!==i){var r=o.push(a(o)+"scale(",null,",",null,")");s.push({i:r-4,x:se(t,n)},{i:r-2,x:se(e,i)})}else 1===n&&1===i||o.push(a(o)+"scale("+n+","+i+")")}(o.scaleX,o.scaleY,s.scaleX,s.scaleY,r,l),o=s=null,function(t){for(var e,n=-1,i=l.length;++n<i;)r[(e=l[n]).i]=e.x(t);return r.join("")}}}var ge=fe(function(t){const e=new("function"==typeof DOMMatrix?DOMMatrix:WebKitCSSMatrix)(t+"");return e.isIdentity?de:pe(e.a,e.b,e.c,e.d,e.e,e.f)},"px, ","px)","deg)"),me=fe(function(t){return null==t?de:(ce||(ce=document.createElementNS("http://www.w3.org/2000/svg","g")),ce.setAttribute("transform",t),(t=ce.transform.baseVal.consolidate())?pe((t=t.matrix).a,t.b,t.c,t.d,t.e,t.f):de)},", ",")",")");function ye(t){return((t=Math.exp(t))+1/t)/2}const be=function t(e,n,i){function a(t,a){var o,s,r=t[0],l=t[1],h=t[2],c=a[0],u=a[1],d=a[2],p=c-r,f=u-l,g=p*p+f*f;if(g<1e-12)s=Math.log(d/h)/e,o=function(t){return[r+t*p,l+t*f,h*Math.exp(e*t*s)]};else{var m=Math.sqrt(g),y=(d*d-h*h+i*g)/(2*h*n*m),b=(d*d-h*h-i*g)/(2*d*n*m),x=Math.log(Math.sqrt(y*y+1)-y),v=Math.log(Math.sqrt(b*b+1)-b);s=(v-x)/e,o=function(t){var i,a=t*s,o=ye(x),c=h/(n*m)*(o*(i=e*a+x,((i=Math.exp(2*i))-1)/(i+1))-function(t){return((t=Math.exp(t))-1/t)/2}(x));return[r+c*p,l+c*f,h*o/ye(e*a+x)]}}return o.duration=1e3*s*e/Math.SQRT2,o}return a.rho=function(e){var n=Math.max(.001,+e),i=n*n;return t(n,i,i*i)},a}(Math.SQRT2,2,4);var xe,ve,we=0,_e=0,Ce=0,ke=0,Se=0,Le=0,Pe="object"==typeof performance&&performance.now?performance:Date,Me="object"==typeof window&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(t){setTimeout(t,17)};function Te(){return Se||(Me(Ee),Se=Pe.now()+Le)}function Ee(){Se=0}function ze(){this._call=this._time=this._next=null}function $e(t,e,n){var i=new ze;return i.restart(t,e,n),i}function Ne(){Se=(ke=Pe.now())+Le,we=_e=0;try{!function(){Te(),++we;for(var t,e=xe;e;)(t=Se-e._time)>=0&&e._call.call(void 0,t),e=e._next;--we}()}finally{we=0,function(){var t,e,n=xe,i=1/0;for(;n;)n._call?(i>n._time&&(i=n._time),t=n,n=n._next):(e=n._next,n._next=null,n=t?t._next=e:xe=e);ve=t,Re(i)}(),Se=0}}function Ae(){var t=Pe.now(),e=t-ke;e>1e3&&(Le-=e,ke=t)}function Re(t){we||(_e&&(_e=clearTimeout(_e)),t-Se>24?(t<1/0&&(_e=setTimeout(Ne,t-Pe.now()-Le)),Ce&&(Ce=clearInterval(Ce))):(Ce||(ke=Pe.now(),Ce=setInterval(Ae,1e3)),we=1,Me(Ne)))}function He(t,e,n){var i=new ze;return e=null==e?0:+e,i.restart(n=>{i.stop(),t(n+e)},e,n),i}ze.prototype=$e.prototype={constructor:ze,restart:function(t,e,n){if("function"!=typeof t)throw new TypeError("callback is not a function");n=(null==n?Te():+n)+(null==e?0:+e),this._next||ve===this||(ve?ve._next=this:xe=this,ve=this),this._call=t,this._time=n,Re()},stop:function(){this._call&&(this._call=null,this._time=1/0,Re())}};var Be=n("start","end","cancel","interrupt"),De=[];function Fe(t,e,n,i,a,o){var s=t.__transition;if(s){if(n in s)return}else t.__transition={};!function(t,e,n){var i,a=t.__transition;function o(t){n.state=1,n.timer.restart(s,n.delay,n.time),n.delay<=t&&s(t-n.delay)}function s(o){var h,c,u,d;if(1!==n.state)return l();for(h in a)if((d=a[h]).name===n.name){if(3===d.state)return He(s);4===d.state?(d.state=6,d.timer.stop(),d.on.call("interrupt",t,t.__data__,d.index,d.group),delete a[h]):+h<e&&(d.state=6,d.timer.stop(),d.on.call("cancel",t,t.__data__,d.index,d.group),delete a[h])}if(He(function(){3===n.state&&(n.state=4,n.timer.restart(r,n.delay,n.time),r(o))}),n.state=2,n.on.call("start",t,t.__data__,n.index,n.group),2===n.state){for(n.state=3,i=new Array(u=n.tween.length),h=0,c=-1;h<u;++h)(d=n.tween[h].value.call(t,t.__data__,n.index,n.group))&&(i[++c]=d);i.length=c+1}}function r(e){for(var a=e<n.duration?n.ease.call(null,e/n.duration):(n.timer.restart(l),n.state=5,1),o=-1,s=i.length;++o<s;)i[o].call(t,a);5===n.state&&(n.on.call("end",t,t.__data__,n.index,n.group),l())}function l(){for(var i in n.state=6,n.timer.stop(),delete a[e],a)return;delete t.__transition}a[e]=n,n.timer=$e(o,0,n.time)}(t,n,{name:e,index:i,group:a,on:Be,tween:De,time:o.time,delay:o.delay,duration:o.duration,ease:o.ease,timer:null,state:0})}function Ie(t,e){var n=qe(t,e);if(n.state>0)throw new Error("too late; already scheduled");return n}function Ve(t,e){var n=qe(t,e);if(n.state>3)throw new Error("too late; already running");return n}function qe(t,e){var n=t.__transition;if(!n||!(n=n[e]))throw new Error("transition not found");return n}function Xe(t,e){var n,i,a,o=t.__transition,s=!0;if(o){for(a in e=null==e?null:e+"",o)(n=o[a]).name===e?(i=n.state>2&&n.state<5,n.state=6,n.timer.stop(),n.on.call(i?"interrupt":"cancel",t,t.__data__,n.index,n.group),delete o[a]):s=!1;s&&delete t.__transition}}function Oe(t,e){var n,i;return function(){var a=Ve(this,t),o=a.tween;if(o!==n)for(var s=0,r=(i=n=o).length;s<r;++s)if(i[s].name===e){(i=i.slice()).splice(s,1);break}a.tween=i}}function Ye(t,e,n){var i,a;if("function"!=typeof n)throw new Error;return function(){var o=Ve(this,t),s=o.tween;if(s!==i){a=(i=s).slice();for(var r={name:e,value:n},l=0,h=a.length;l<h;++l)if(a[l].name===e){a[l]=r;break}l===h&&a.push(r)}o.tween=a}}function je(t,e,n){var i=t._id;return t.each(function(){var t=Ve(this,i);(t.value||(t.value={}))[e]=n.apply(this,arguments)}),function(t){return qe(t,i).value[e]}}function Ge(t,e){var n;return("number"==typeof e?se:e instanceof It?oe:(n=It(e))?(e=n,oe):he)(t,e)}function Ze(t){return function(){this.removeAttribute(t)}}function Ue(t){return function(){this.removeAttributeNS(t.space,t.local)}}function We(t,e,n){var i,a,o=n+"";return function(){var s=this.getAttribute(t);return s===o?null:s===i?a:a=e(i=s,n)}}function Ke(t,e,n){var i,a,o=n+"";return function(){var s=this.getAttributeNS(t.space,t.local);return s===o?null:s===i?a:a=e(i=s,n)}}function Qe(t,e,n){var i,a,o;return function(){var s,r,l=n(this);if(null!=l)return(s=this.getAttribute(t))===(r=l+"")?null:s===i&&r===a?o:(a=r,o=e(i=s,l));this.removeAttribute(t)}}function Je(t,e,n){var i,a,o;return function(){var s,r,l=n(this);if(null!=l)return(s=this.getAttributeNS(t.space,t.local))===(r=l+"")?null:s===i&&r===a?o:(a=r,o=e(i=s,l));this.removeAttributeNS(t.space,t.local)}}function tn(t,e){var n,i;function a(){var a=e.apply(this,arguments);return a!==i&&(n=(i=a)&&function(t,e){return function(n){this.setAttributeNS(t.space,t.local,e.call(this,n))}}(t,a)),n}return a._value=e,a}function en(t,e){var n,i;function a(){var a=e.apply(this,arguments);return a!==i&&(n=(i=a)&&function(t,e){return function(n){this.setAttribute(t,e.call(this,n))}}(t,a)),n}return a._value=e,a}function nn(t,e){return function(){Ie(this,t).delay=+e.apply(this,arguments)}}function an(t,e){return e=+e,function(){Ie(this,t).delay=e}}function on(t,e){return function(){Ve(this,t).duration=+e.apply(this,arguments)}}function sn(t,e){return e=+e,function(){Ve(this,t).duration=e}}var rn=yt.prototype.constructor;function ln(t){return function(){this.style.removeProperty(t)}}var hn=0;function cn(t,e,n,i){this._groups=t,this._parents=e,this._name=n,this._id=i}function un(){return++hn}var dn=yt.prototype;cn.prototype={constructor:cn,select:function(t){var e=this._name,n=this._id;"function"!=typeof t&&(t=p(t));for(var i=this._groups,a=i.length,o=new Array(a),s=0;s<a;++s)for(var r,l,h=i[s],c=h.length,u=o[s]=new Array(c),d=0;d<c;++d)(r=h[d])&&(l=t.call(r,r.__data__,d,h))&&("__data__"in r&&(l.__data__=r.__data__),u[d]=l,Fe(u[d],e,n,d,u,qe(r,n)));return new cn(o,this._parents,e,n)},selectAll:function(t){var e=this._name,n=this._id;"function"!=typeof t&&(t=g(t));for(var i=this._groups,a=i.length,o=[],s=[],r=0;r<a;++r)for(var l,h=i[r],c=h.length,u=0;u<c;++u)if(l=h[u]){for(var d,p=t.call(l,l.__data__,u,h),f=qe(l,n),m=0,y=p.length;m<y;++m)(d=p[m])&&Fe(d,e,n,m,p,f);o.push(p),s.push(l)}return new cn(o,s,e,n)},selectChild:dn.selectChild,selectChildren:dn.selectChildren,filter:function(t){"function"!=typeof t&&(t=y(t));for(var e=this._groups,n=e.length,i=new Array(n),a=0;a<n;++a)for(var o,s=e[a],r=s.length,l=i[a]=[],h=0;h<r;++h)(o=s[h])&&t.call(o,o.__data__,h,s)&&l.push(o);return new cn(i,this._parents,this._name,this._id)},merge:function(t){if(t._id!==this._id)throw new Error;for(var e=this._groups,n=t._groups,i=e.length,a=n.length,o=Math.min(i,a),s=new Array(i),r=0;r<o;++r)for(var l,h=e[r],c=n[r],u=h.length,d=s[r]=new Array(u),p=0;p<u;++p)(l=h[p]||c[p])&&(d[p]=l);for(;r<i;++r)s[r]=e[r];return new cn(s,this._parents,this._name,this._id)},selection:function(){return new rn(this._groups,this._parents)},transition:function(){for(var t=this._name,e=this._id,n=un(),i=this._groups,a=i.length,o=0;o<a;++o)for(var s,r=i[o],l=r.length,h=0;h<l;++h)if(s=r[h]){var c=qe(s,e);Fe(s,t,n,h,r,{time:c.time+c.delay+c.duration,delay:0,duration:c.duration,ease:c.ease})}return new cn(i,this._parents,t,n)},call:dn.call,nodes:dn.nodes,node:dn.node,size:dn.size,empty:dn.empty,each:dn.each,on:function(t,e){var n=this._id;return arguments.length<2?qe(this.node(),n).on.on(t):this.each(function(t,e,n){var i,a,o=function(t){return(t+"").trim().split(/^|\s+/).every(function(t){var e=t.indexOf(".");return e>=0&&(t=t.slice(0,e)),!t||"start"===t})}(e)?Ie:Ve;return function(){var s=o(this,t),r=s.on;r!==i&&(a=(i=r).copy()).on(e,n),s.on=a}}(n,t,e))},attr:function(t,e){var n=l(t),i="transform"===n?me:Ge;return this.attrTween(t,"function"==typeof e?(n.local?Je:Qe)(n,i,je(this,"attr."+t,e)):null==e?(n.local?Ue:Ze)(n):(n.local?Ke:We)(n,i,e))},attrTween:function(t,e){var n="attr."+t;if(arguments.length<2)return(n=this.tween(n))&&n._value;if(null==e)return this.tween(n,null);if("function"!=typeof e)throw new Error;var i=l(t);return this.tween(n,(i.local?tn:en)(i,e))},style:function(t,e,n){var i="transform"==(t+="")?ge:Ge;return null==e?this.styleTween(t,function(t,e){var n,i,a;return function(){var o=I(this,t),s=(this.style.removeProperty(t),I(this,t));return o===s?null:o===n&&s===i?a:a=e(n=o,i=s)}}(t,i)).on("end.style."+t,ln(t)):"function"==typeof e?this.styleTween(t,function(t,e,n){var i,a,o;return function(){var s=I(this,t),r=n(this),l=r+"";return null==r&&(this.style.removeProperty(t),l=r=I(this,t)),s===l?null:s===i&&l===a?o:(a=l,o=e(i=s,r))}}(t,i,je(this,"style."+t,e))).each(function(t,e){var n,i,a,o,s="style."+e,r="end."+s;return function(){var l=Ve(this,t),h=l.on,c=null==l.value[s]?o||(o=ln(e)):void 0;h===n&&a===c||(i=(n=h).copy()).on(r,a=c),l.on=i}}(this._id,t)):this.styleTween(t,function(t,e,n){var i,a,o=n+"";return function(){var s=I(this,t);return s===o?null:s===i?a:a=e(i=s,n)}}(t,i,e),n).on("end.style."+t,null)},styleTween:function(t,e,n){var i="style."+(t+="");if(arguments.length<2)return(i=this.tween(i))&&i._value;if(null==e)return this.tween(i,null);if("function"!=typeof e)throw new Error;return this.tween(i,function(t,e,n){var i,a;function o(){var o=e.apply(this,arguments);return o!==a&&(i=(a=o)&&function(t,e,n){return function(i){this.style.setProperty(t,e.call(this,i),n)}}(t,o,n)),i}return o._value=e,o}(t,e,null==n?"":n))},text:function(t){return this.tween("text","function"==typeof t?function(t){return function(){var e=t(this);this.textContent=null==e?"":e}}(je(this,"text",t)):function(t){return function(){this.textContent=t}}(null==t?"":t+""))},textTween:function(t){var e="text";if(arguments.length<1)return(e=this.tween(e))&&e._value;if(null==t)return this.tween(e,null);if("function"!=typeof t)throw new Error;return this.tween(e,function(t){var e,n;function i(){var i=t.apply(this,arguments);return i!==n&&(e=(n=i)&&function(t){return function(e){this.textContent=t.call(this,e)}}(i)),e}return i._value=t,i}(t))},remove:function(){return this.on("end.remove",(t=this._id,function(){var e=this.parentNode;for(var n in this.__transition)if(+n!==t)return;e&&e.removeChild(this)}));var t},tween:function(t,e){var n=this._id;if(t+="",arguments.length<2){for(var i,a=qe(this.node(),n).tween,o=0,s=a.length;o<s;++o)if((i=a[o]).name===t)return i.value;return null}return this.each((null==e?Oe:Ye)(n,t,e))},delay:function(t){var e=this._id;return arguments.length?this.each(("function"==typeof t?nn:an)(e,t)):qe(this.node(),e).delay},duration:function(t){var e=this._id;return arguments.length?this.each(("function"==typeof t?on:sn)(e,t)):qe(this.node(),e).duration},ease:function(t){var e=this._id;return arguments.length?this.each(function(t,e){if("function"!=typeof e)throw new Error;return function(){Ve(this,t).ease=e}}(e,t)):qe(this.node(),e).ease},easeVarying:function(t){if("function"!=typeof t)throw new Error;return this.each(function(t,e){return function(){var n=e.apply(this,arguments);if("function"!=typeof n)throw new Error;Ve(this,t).ease=n}}(this._id,t))},end:function(){var t,e,n=this,i=n._id,a=n.size();return new Promise(function(o,s){var r={value:s},l={value:function(){0===--a&&o()}};n.each(function(){var n=Ve(this,i),a=n.on;a!==t&&((e=(t=a).copy())._.cancel.push(r),e._.interrupt.push(r),e._.end.push(l)),n.on=e}),0===a&&o()})},[Symbol.iterator]:dn[Symbol.iterator]};var pn={time:null,delay:0,duration:250,ease:function(t){return((t*=2)<=1?t*t*t:(t-=2)*t*t+2)/2}};function fn(t,e){for(var n;!(n=t.__transition)||!(n=n[e]);)if(!(t=t.parentNode))throw new Error(`transition ${e} not found`);return n}yt.prototype.interrupt=function(t){return this.each(function(){Xe(this,t)})},yt.prototype.transition=function(t){var e,n;t instanceof cn?(e=t._id,t=t._name):(e=un(),(n=pn).time=Te(),t=null==t?null:t+"");for(var i=this._groups,a=i.length,o=0;o<a;++o)for(var s,r=i[o],l=r.length,h=0;h<l;++h)(s=r[h])&&Fe(s,t,e,h,r,n||fn(s,e));return new cn(i,this._parents,t,e)};const gn=Math.PI,mn=2*gn,yn=1e-6,bn=mn-yn;function xn(t){this._+=t[0];for(let e=1,n=t.length;e<n;++e)this._+=arguments[e]+t[e]}class vn{constructor(t){this._x0=this._y0=this._x1=this._y1=null,this._="",this._append=null==t?xn:function(t){let e=Math.floor(t);if(!(e>=0))throw new Error(`invalid digits: ${t}`);if(e>15)return xn;const n=10**e;return function(t){this._+=t[0];for(let e=1,i=t.length;e<i;++e)this._+=Math.round(arguments[e]*n)/n+t[e]}}(t)}moveTo(t,e){this._append`M${this._x0=this._x1=+t},${this._y0=this._y1=+e}`}closePath(){null!==this._x1&&(this._x1=this._x0,this._y1=this._y0,this._append`Z`)}lineTo(t,e){this._append`L${this._x1=+t},${this._y1=+e}`}quadraticCurveTo(t,e,n,i){this._append`Q${+t},${+e},${this._x1=+n},${this._y1=+i}`}bezierCurveTo(t,e,n,i,a,o){this._append`C${+t},${+e},${+n},${+i},${this._x1=+a},${this._y1=+o}`}arcTo(t,e,n,i,a){if(t=+t,e=+e,n=+n,i=+i,(a=+a)<0)throw new Error(`negative radius: ${a}`);let o=this._x1,s=this._y1,r=n-t,l=i-e,h=o-t,c=s-e,u=h*h+c*c;if(null===this._x1)this._append`M${this._x1=t},${this._y1=e}`;else if(u>yn)if(Math.abs(c*r-l*h)>yn&&a){let d=n-o,p=i-s,f=r*r+l*l,g=d*d+p*p,m=Math.sqrt(f),y=Math.sqrt(u),b=a*Math.tan((gn-Math.acos((f+u-g)/(2*m*y)))/2),x=b/y,v=b/m;Math.abs(x-1)>yn&&this._append`L${t+x*h},${e+x*c}`,this._append`A${a},${a},0,0,${+(c*d>h*p)},${this._x1=t+v*r},${this._y1=e+v*l}`}else this._append`L${this._x1=t},${this._y1=e}`;else;}arc(t,e,n,i,a,o){if(t=+t,e=+e,o=!!o,(n=+n)<0)throw new Error(`negative radius: ${n}`);let s=n*Math.cos(i),r=n*Math.sin(i),l=t+s,h=e+r,c=1^o,u=o?i-a:a-i;null===this._x1?this._append`M${l},${h}`:(Math.abs(this._x1-l)>yn||Math.abs(this._y1-h)>yn)&&this._append`L${l},${h}`,n&&(u<0&&(u=u%mn+mn),u>bn?this._append`A${n},${n},0,1,${c},${t-s},${e-r}A${n},${n},0,1,${c},${this._x1=l},${this._y1=h}`:u>yn&&this._append`A${n},${n},0,${+(u>=gn)},${c},${this._x1=t+n*Math.cos(a)},${this._y1=e+n*Math.sin(a)}`)}rect(t,e,n,i){this._append`M${this._x0=this._x1=+t},${this._y0=this._y1=+e}h${n=+n}v${+i}h${-n}Z`}toString(){return this._}}function wn(t,e){return t.parent===e.parent?1:2}function _n(t,e){return t+e.x}function Cn(t,e){return Math.max(t,e.y)}function kn(){var t=wn,e=1,n=1,i=!1;function a(a){var o,s=0;a.eachAfter(function(e){var n=e.children;n?(e.x=function(t){return t.reduce(_n,0)/t.length}(n),e.y=function(t){return 1+t.reduce(Cn,0)}(n)):(e.x=o?s+=t(e,o):0,e.y=0,o=e)});var r=function(t){for(var e;e=t.children;)t=e[0];return t}(a),l=function(t){for(var e;e=t.children;)t=e[e.length-1];return t}(a),h=r.x-t(r,l)/2,c=l.x+t(l,r)/2;return a.eachAfter(i?function(t){t.x=(t.x-a.x)*e,t.y=(a.y-t.y)*n}:function(t){t.x=(t.x-h)/(c-h)*e,t.y=(1-(a.y?t.y/a.y:1))*n})}return a.separation=function(e){return arguments.length?(t=e,a):t},a.size=function(t){return arguments.length?(i=!1,e=+t[0],n=+t[1],a):i?null:[e,n]},a.nodeSize=function(t){return arguments.length?(i=!0,e=+t[0],n=+t[1],a):i?[e,n]:null},a}function Sn(t){var e=0,n=t.children,i=n&&n.length;if(i)for(;--i>=0;)e+=n[i].value;else e=1;t.value=e}function Ln(t,e){t instanceof Map?(t=[void 0,t],void 0===e&&(e=Mn)):void 0===e&&(e=Pn);for(var n,i,a,o,s,r=new zn(t),l=[r];n=l.pop();)if((a=e(n.data))&&(s=(a=Array.from(a)).length))for(n.children=a,o=s-1;o>=0;--o)l.push(i=a[o]=new zn(a[o])),i.parent=n,i.depth=n.depth+1;return r.eachBefore(En)}function Pn(t){return t.children}function Mn(t){return Array.isArray(t)?t[1]:null}function Tn(t){void 0!==t.data.value&&(t.value=t.data.value),t.data=t.data.data}function En(t){var e=0;do{t.height=e}while((t=t.parent)&&t.height<++e)}function zn(t){this.data=t,this.depth=this.height=0,this.parent=null}function $n(t){return function(){return t}}zn.prototype=Ln.prototype={constructor:zn,count:function(){return this.eachAfter(Sn)},each:function(t,e){let n=-1;for(const i of this)t.call(e,i,++n,this);return this},eachAfter:function(t,e){for(var n,i,a,o=this,s=[o],r=[],l=-1;o=s.pop();)if(r.push(o),n=o.children)for(i=0,a=n.length;i<a;++i)s.push(n[i]);for(;o=r.pop();)t.call(e,o,++l,this);return this},eachBefore:function(t,e){for(var n,i,a=this,o=[a],s=-1;a=o.pop();)if(t.call(e,a,++s,this),n=a.children)for(i=n.length-1;i>=0;--i)o.push(n[i]);return this},find:function(t,e){let n=-1;for(const i of this)if(t.call(e,i,++n,this))return i},sum:function(t){return this.eachAfter(function(e){for(var n=+t(e.data)||0,i=e.children,a=i&&i.length;--a>=0;)n+=i[a].value;e.value=n})},sort:function(t){return this.eachBefore(function(e){e.children&&e.children.sort(t)})},path:function(t){for(var e=this,n=function(t,e){if(t===e)return t;var n=t.ancestors(),i=e.ancestors(),a=null;t=n.pop(),e=i.pop();for(;t===e;)a=t,t=n.pop(),e=i.pop();return a}(e,t),i=[e];e!==n;)e=e.parent,i.push(e);for(var a=i.length;t!==n;)i.splice(a,0,t),t=t.parent;return i},ancestors:function(){for(var t=this,e=[t];t=t.parent;)e.push(t);return e},descendants:function(){return Array.from(this)},leaves:function(){var t=[];return this.eachBefore(function(e){e.children||t.push(e)}),t},links:function(){var t=this,e=[];return t.each(function(n){n!==t&&e.push({source:n.parent,target:n})}),e},copy:function(){return Ln(this).eachBefore(Tn)},[Symbol.iterator]:function*(){var t,e,n,i,a=this,o=[a];do{for(t=o.reverse(),o=[];a=t.pop();)if(yield a,e=a.children)for(n=0,i=e.length;n<i;++n)o.push(e[n])}while(o.length)}};const Nn=Math.sqrt,An=Math.PI,Rn=2*An;const Hn={draw(t,e){const n=Nn(e/An);t.moveTo(n,0),t.arc(0,0,n,0,Rn)}},Bn=Nn(3),Dn={draw(t,e){const n=-Nn(e/(3*Bn));t.moveTo(0,2*n),t.lineTo(-Bn*n,-n),t.lineTo(Bn*n,-n),t.closePath()}};function Fn(t,e){let n=null,i=function(t){let e=3;return t.digits=function(n){if(!arguments.length)return e;if(null==n)e=null;else{const t=Math.floor(n);if(!(t>=0))throw new RangeError(`invalid digits: ${n}`);e=t}return t},()=>new vn(e)}(a);function a(){let a;if(n||(n=a=i()),t.apply(this,arguments).draw(n,+e.apply(this,arguments)),a)return n=null,a+""||null}return t="function"==typeof t?t:$n(t||Hn),e="function"==typeof e?e:$n(void 0===e?64:+e),a.type=function(e){return arguments.length?(t="function"==typeof e?e:$n(e),a):t},a.size=function(t){return arguments.length?(e="function"==typeof t?t:$n(+t),a):e},a.context=function(t){return arguments.length?(n=null==t?null:t,a):n},a}const In=t=>()=>t;function Vn(t,{sourceEvent:e,target:n,transform:i,dispatch:a}){Object.defineProperties(this,{type:{value:t,enumerable:!0,configurable:!0},sourceEvent:{value:e,enumerable:!0,configurable:!0},target:{value:n,enumerable:!0,configurable:!0},transform:{value:i,enumerable:!0,configurable:!0},_:{value:a}})}function qn(t,e,n){this.k=t,this.x=e,this.y=n}qn.prototype={constructor:qn,scale:function(t){return 1===t?this:new qn(this.k*t,this.x,this.y)},translate:function(t,e){return 0===t&0===e?this:new qn(this.k,this.x+this.k*t,this.y+this.k*e)},apply:function(t){return[t[0]*this.k+this.x,t[1]*this.k+this.y]},applyX:function(t){return t*this.k+this.x},applyY:function(t){return t*this.k+this.y},invert:function(t){return[(t[0]-this.x)/this.k,(t[1]-this.y)/this.k]},invertX:function(t){return(t-this.x)/this.k},invertY:function(t){return(t-this.y)/this.k},rescaleX:function(t){return t.copy().domain(t.range().map(this.invertX,this).map(t.invert,t))},rescaleY:function(t){return t.copy().domain(t.range().map(this.invertY,this).map(t.invert,t))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};var Xn=new qn(1,0,0);function On(t){t.stopImmediatePropagation()}function Yn(t){t.preventDefault(),t.stopImmediatePropagation()}function jn(t){return!(t.ctrlKey&&"wheel"!==t.type||t.button)}function Gn(){var t=this;return t instanceof SVGElement?(t=t.ownerSVGElement||t).hasAttribute("viewBox")?[[(t=t.viewBox.baseVal).x,t.y],[t.x+t.width,t.y+t.height]]:[[0,0],[t.width.baseVal.value,t.height.baseVal.value]]:[[0,0],[t.clientWidth,t.clientHeight]]}function Zn(){return this.__zoom||Xn}function Un(t){return-t.deltaY*(1===t.deltaMode?.05:t.deltaMode?1:.002)*(t.ctrlKey?10:1)}function Wn(){return navigator.maxTouchPoints||"ontouchstart"in this}function Kn(t,e,n){var i=t.invertX(e[0][0])-n[0][0],a=t.invertX(e[1][0])-n[1][0],o=t.invertY(e[0][1])-n[0][1],s=t.invertY(e[1][1])-n[1][1];return t.translate(a>i?(i+a)/2:Math.min(0,i)||Math.max(0,a),s>o?(o+s)/2:Math.min(0,o)||Math.max(0,s))}function Qn(){var t,e,i,a=jn,o=Gn,s=Kn,r=Un,l=Wn,h=[0,1/0],c=[[-1/0,-1/0],[1/0,1/0]],u=250,d=be,p=n("start","zoom","end"),f=0,g=10;function m(t){t.property("__zoom",Zn).on("wheel.zoom",C,{passive:!1}).on("mousedown.zoom",k).on("dblclick.zoom",S).filter(l).on("touchstart.zoom",L).on("touchmove.zoom",P).on("touchend.zoom touchcancel.zoom",M).style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function y(t,e){return(e=Math.max(h[0],Math.min(h[1],e)))===t.k?t:new qn(e,t.x,t.y)}function b(t,e,n){var i=e[0]-n[0]*t.k,a=e[1]-n[1]*t.k;return i===t.x&&a===t.y?t:new qn(t.k,i,a)}function x(t){return[(+t[0][0]+ +t[1][0])/2,(+t[0][1]+ +t[1][1])/2]}function v(t,e,n,i){t.on("start.zoom",function(){w(this,arguments).event(i).start()}).on("interrupt.zoom end.zoom",function(){w(this,arguments).event(i).end()}).tween("zoom",function(){var t=this,a=arguments,s=w(t,a).event(i),r=o.apply(t,a),l=null==n?x(r):"function"==typeof n?n.apply(t,a):n,h=Math.max(r[1][0]-r[0][0],r[1][1]-r[0][1]),c=t.__zoom,u="function"==typeof e?e.apply(t,a):e,p=d(c.invert(l).concat(h/c.k),u.invert(l).concat(h/u.k));return function(t){if(1===t)t=u;else{var e=p(t),n=h/e[2];t=new qn(n,l[0]-e[0]*n,l[1]-e[1]*n)}s.zoom(null,t)}})}function w(t,e,n){return!n&&t.__zooming||new _(t,e)}function _(t,e){this.that=t,this.args=e,this.active=0,this.sourceEvent=null,this.extent=o.apply(t,e),this.taps=0}function C(t,...e){if(a.apply(this,arguments)){var n=w(this,e).event(t),i=this.__zoom,o=Math.max(h[0],Math.min(h[1],i.k*Math.pow(2,r.apply(this,arguments)))),l=xt(t);if(n.wheel)n.mouse[0][0]===l[0]&&n.mouse[0][1]===l[1]||(n.mouse[1]=i.invert(n.mouse[0]=l)),clearTimeout(n.wheel);else{if(i.k===o)return;n.mouse=[l,i.invert(l)],Xe(this),n.start()}Yn(t),n.wheel=setTimeout(function(){n.wheel=null,n.end()},150),n.zoom("mouse",s(b(y(i,o),n.mouse[0],n.mouse[1]),n.extent,c))}}function k(t,...e){if(!i&&a.apply(this,arguments)){var n,o,r,l=t.currentTarget,h=w(this,e,!0).event(t),u=bt(t.view).on("mousemove.zoom",function(t){if(Yn(t),!h.moved){var e=t.clientX-p,n=t.clientY-g;h.moved=e*e+n*n>f}h.event(t).zoom("mouse",s(b(h.that.__zoom,h.mouse[0]=xt(t,l),h.mouse[1]),h.extent,c))},!0).on("mouseup.zoom",function(t){u.on("mousemove.zoom mouseup.zoom",null),e=t.view,n=h.moved,i=e.document.documentElement,a=bt(e).on("dragstart.drag",null),n&&(a.on("click.drag",wt,vt),setTimeout(function(){a.on("click.drag",null)},0)),"onselectstart"in i?a.on("selectstart.drag",null):(i.style.MozUserSelect=i.__noselect,delete i.__noselect),Yn(t),h.event(t).end();var e,n,i,a},!0),d=xt(t,l),p=t.clientX,g=t.clientY;n=t.view,o=n.document.documentElement,r=bt(n).on("dragstart.drag",wt,vt),"onselectstart"in o?r.on("selectstart.drag",wt,vt):(o.__noselect=o.style.MozUserSelect,o.style.MozUserSelect="none"),On(t),h.mouse=[d,this.__zoom.invert(d)],Xe(this),h.start()}}function S(t,...e){if(a.apply(this,arguments)){var n=this.__zoom,i=xt(t.changedTouches?t.changedTouches[0]:t,this),r=n.invert(i),l=n.k*(t.shiftKey?.5:2),h=s(b(y(n,l),i,r),o.apply(this,e),c);Yn(t),u>0?bt(this).transition().duration(u).call(v,h,i,t):bt(this).call(m.transform,h,i,t)}}function L(n,...i){if(a.apply(this,arguments)){var o,s,r,l,h=n.touches,c=h.length,u=w(this,i,n.changedTouches.length===c).event(n);for(On(n),s=0;s<c;++s)l=[l=xt(r=h[s],this),this.__zoom.invert(l),r.identifier],u.touch0?u.touch1||u.touch0[2]===l[2]||(u.touch1=l,u.taps=0):(u.touch0=l,o=!0,u.taps=1+!!t);t&&(t=clearTimeout(t)),o&&(u.taps<2&&(e=l[0],t=setTimeout(function(){t=null},500)),Xe(this),u.start())}}function P(t,...e){if(this.__zooming){var n,i,a,o,r=w(this,e).event(t),l=t.changedTouches,h=l.length;for(Yn(t),n=0;n<h;++n)a=xt(i=l[n],this),r.touch0&&r.touch0[2]===i.identifier?r.touch0[0]=a:r.touch1&&r.touch1[2]===i.identifier&&(r.touch1[0]=a);if(i=r.that.__zoom,r.touch1){var u=r.touch0[0],d=r.touch0[1],p=r.touch1[0],f=r.touch1[1],g=(g=p[0]-u[0])*g+(g=p[1]-u[1])*g,m=(m=f[0]-d[0])*m+(m=f[1]-d[1])*m;i=y(i,Math.sqrt(g/m)),a=[(u[0]+p[0])/2,(u[1]+p[1])/2],o=[(d[0]+f[0])/2,(d[1]+f[1])/2]}else{if(!r.touch0)return;a=r.touch0[0],o=r.touch0[1]}r.zoom("touch",s(b(i,a,o),r.extent,c))}}function M(t,...n){if(this.__zooming){var a,o,s=w(this,n).event(t),r=t.changedTouches,l=r.length;for(On(t),i&&clearTimeout(i),i=setTimeout(function(){i=null},500),a=0;a<l;++a)o=r[a],s.touch0&&s.touch0[2]===o.identifier?delete s.touch0:s.touch1&&s.touch1[2]===o.identifier&&delete s.touch1;if(s.touch1&&!s.touch0&&(s.touch0=s.touch1,delete s.touch1),s.touch0)s.touch0[1]=this.__zoom.invert(s.touch0[0]);else if(s.end(),2===s.taps&&(o=xt(o,this),Math.hypot(e[0]-o[0],e[1]-o[1])<g)){var h=bt(this).on("dblclick.zoom");h&&h.apply(this,arguments)}}}return m.transform=function(t,e,n,i){var a=t.selection?t.selection():t;a.property("__zoom",Zn),t!==a?v(t,e,n,i):a.interrupt().each(function(){w(this,arguments).event(i).start().zoom(null,"function"==typeof e?e.apply(this,arguments):e).end()})},m.scaleBy=function(t,e,n,i){m.scaleTo(t,function(){return this.__zoom.k*("function"==typeof e?e.apply(this,arguments):e)},n,i)},m.scaleTo=function(t,e,n,i){m.transform(t,function(){var t=o.apply(this,arguments),i=this.__zoom,a=null==n?x(t):"function"==typeof n?n.apply(this,arguments):n,r=i.invert(a),l="function"==typeof e?e.apply(this,arguments):e;return s(b(y(i,l),a,r),t,c)},n,i)},m.translateBy=function(t,e,n,i){m.transform(t,function(){return s(this.__zoom.translate("function"==typeof e?e.apply(this,arguments):e,"function"==typeof n?n.apply(this,arguments):n),o.apply(this,arguments),c)},null,i)},m.translateTo=function(t,e,n,i,a){m.transform(t,function(){var t=o.apply(this,arguments),a=this.__zoom,r=null==i?x(t):"function"==typeof i?i.apply(this,arguments):i;return s(Xn.translate(r[0],r[1]).scale(a.k).translate("function"==typeof e?-e.apply(this,arguments):-e,"function"==typeof n?-n.apply(this,arguments):-n),t,c)},i,a)},_.prototype={event:function(t){return t&&(this.sourceEvent=t),this},start:function(){return 1===++this.active&&(this.that.__zooming=this,this.emit("start")),this},zoom:function(t,e){return this.mouse&&"mouse"!==t&&(this.mouse[1]=e.invert(this.mouse[0])),this.touch0&&"touch"!==t&&(this.touch0[1]=e.invert(this.touch0[0])),this.touch1&&"touch"!==t&&(this.touch1[1]=e.invert(this.touch1[0])),this.that.__zoom=e,this.emit("zoom"),this},end:function(){return 0===--this.active&&(delete this.that.__zooming,this.emit("end")),this},emit:function(t){var e=bt(this.that).datum();p.call(t,this.that,new Vn(t,{sourceEvent:this.sourceEvent,target:m,transform:this.that.__zoom,dispatch:p}),e)}},m.wheelDelta=function(t){return arguments.length?(r="function"==typeof t?t:In(+t),m):r},m.filter=function(t){return arguments.length?(a="function"==typeof t?t:In(!!t),m):a},m.touchable=function(t){return arguments.length?(l="function"==typeof t?t:In(!!t),m):l},m.extent=function(t){return arguments.length?(o="function"==typeof t?t:In([[+t[0][0],+t[0][1]],[+t[1][0],+t[1][1]]]),m):o},m.scaleExtent=function(t){return arguments.length?(h[0]=+t[0],h[1]=+t[1],m):[h[0],h[1]]},m.translateExtent=function(t){return arguments.length?(c[0][0]=+t[0][0],c[1][0]=+t[1][0],c[0][1]=+t[0][1],c[1][1]=+t[1][1],m):[[c[0][0],c[0][1]],[c[1][0],c[1][1]]]},m.constrain=function(t){return arguments.length?(s=t,m):s},m.duration=function(t){return arguments.length?(u=+t,m):u},m.interpolate=function(t){return arguments.length?(d=t,m):d},m.on=function(){var t=p.on.apply(p,arguments);return t===p?m:t},m.clickDistance=function(t){return arguments.length?(f=(t=+t)*t,m):Math.sqrt(f)},m.tapDistance=function(t){return arguments.length?(g=+t,m):g},m}qn.prototype;function Jn(t){const e=Math.floor(Math.log10(t)),n=t/Math.pow(10,e);let i;return i=n<=1?1:n<=2?2:n<=5?5:10,i*Math.pow(10,e)}function ti(t,e,n){const i=2*n-1,a=t-(n-1)*e;let o=0;for(let l=1;l<=n;l++)o+=l;const s=a/o,r=[];for(let l=0;l<i;l++)l%2==0?r.push(s*(n-l/2)):r.push(e);return r.join(",")}function ei(t,e={}){const{capitalizeFirstOnly:n=!0,preserveAcronyms:i=!0}=e;let a=t;return a=a.replace(/[_]/g," "),a=i?a.replace(/([a-z])([A-Z])/g,"$1 $2"):a.replace(/([A-Z])/g," $1"),a=n?a.charAt(0).toUpperCase()+a.slice(1).toLowerCase():a.replace(/\b\w/g,t=>t.toUpperCase()),a.trim().replace(/\s+/g," ")}function ni(t,e,n=5){const i=e-t;if(0===i)return[t];const a=i/(n-1),o=Math.pow(10,Math.floor(Math.log10(a))),s=a/o;let r;r=s<=1?1:s<=2?2:s<=5?5:10;const l=r*o,h=[];let c=Math.floor(t/l)*l;for(;c<=e+.001*l;)c>=t-.001*l&&h.push(c),c+=l;return(0===h.length||h[0]>t)&&h.unshift(t),h[h.length-1]<e&&h.push(e),h}function ii(t,e){const n=Math.max(...e)-Math.min(...e),i=e.length>1?Math.abs(e[1]-e[0]):n;if(0===n)return t.toPrecision(3);const a=Math.floor(Math.log10(Math.abs(i)));if(a>=0)return Math.round(t).toString();{const e=Math.min(3,-a);return t.toFixed(e)}}class ai{constructor(){this.subscribers=new Map}subscribe(t,e){return this.subscribers.has(t)||this.subscribers.set(t,new Set),this.subscribers.get(t).add(e),()=>this.unsubscribe(t,e)}unsubscribe(t,e){this.subscribers.has(t)&&this.subscribers.get(t).delete(e)}notify(t,e){this.subscribers.has(t)&&this.subscribers.get(t).forEach(t=>{t(e)})}}class oi{constructor(t,e,n={}){this.container=t,this.callback=e,this.options={debounce:250,immediate:!1,...n},this.lastWidth=0,this.lastHeight=0,this.timeoutId=null,this.init()}init(){this.observer=new ResizeObserver(t=>{for(const e of t)this.handleResize(e)}),this.observer.observe(this.container);const t=this.container.getBoundingClientRect();this.lastWidth=t.width,this.lastHeight=t.height,this.options.immediate&&this.callback({width:this.lastWidth,height:this.lastHeight,target:this.container,contentRect:t})}handleResize(t){const{width:e,height:n}=t.contentRect;e===this.lastWidth&&n===this.lastHeight||(this.lastWidth=e,this.lastHeight=n,this.options.debounce>0?this.debouncedCallback(t):this.executeCallback(t))}debouncedCallback(t){clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.executeCallback(t)},this.options.debounce)}executeCallback(t){this.callback({width:t.contentRect.width,height:t.contentRect.height,target:t.target,contentRect:t.contentRect,borderBoxSize:t.borderBoxSize?.[0],contentBoxSize:t.contentBoxSize?.[0],devicePixelContentBoxSize:t.devicePixelContentBoxSize?.[0]})}destroy(){this.observer&&this.observer.disconnect(),clearTimeout(this.timeoutId)}}class si{constructor(t={}){this.state={...t},void 0===this.state.default&&console.error("A default value for a NullScale is needed.")}getValue(){return this.state.default}}class ri{constructor(t={}){this.state={default:null,outputValues:null,transformFn:null,...t},this.validValues=this.state.outputValues?new Set(this.state.outputValues):null}getValue(t){let e=this.state.transformFn?this.state.transformFn(t):t;return null===this.validValues||this.validValues.has(e)||(e=null),null!=e&&""!==e||(e=this.state.default),e}}class li{constructor(t,e={}){if(!Array.isArray(t)||0===t.length)throw new Error("values must be a non-empty array");this.state={outputValues:null,default:null,...e};const n=new Map;for(const o of t)null!=o&&""!==o&&(n.has(o)?n.set(o,n.get(o)+1):n.set(o,1));const i=new Map([...n.entries()].sort((t,e)=>t[0]-e[0]));i.length>this.state.outputValues.length?this.otheredCategories=i.keys().slice(this.state.outputValues.length-2,i.length):this.otheredCategories=[],this.categoryMap=new Map;const a=[...i.keys()];for(let o=0;o<a.length;o++)o<this.state.outputValues.length?this.categoryMap.set(a[o],this.state.outputValues[o]):this.categoryMap.set(a[o],this.state.outputValues[this.state.outputValues.length-1])}getValue(t){return null==t||""===t?this.state.default:this.categoryMap.get(t)}}class hi{constructor(t,e,n={}){this.state={outputRange:[.5,2],nullValue:1,...n},this.dataMin=t,this.dataMax=e}getValue(t){if(null==t||""===t)return this.state.nullValue;const e=Math.max(this.dataMin,Math.min(this.dataMax,t));if(this.dataMin===this.dataMax)return t===this.dataMax?(this.state.outputRange[0]+this.state.outputRange[1])/2:t<this.dataMin?this.state.outputRange[0]:this.state.outputRange[1];const n=(e-this.dataMin)/(this.dataMax-this.dataMin);return this.state.outputRange[0]+n*(this.state.outputRange[1]-this.state.outputRange[0])}}class ci{constructor(t,e,n={}){if(this.state={transformMin:0,transformMax:1,colorPalette:null,colorPositions:null,nullValue:"#808080",...n},this.dataMin=t,this.dataMax=e,null===this.state.colorPalette&&(this.state.colorPalette=["#440154","#31688e","#35b779","#fde724"]),this.state.colorPalette.length<1)throw new Error("At least 1 color is required");if(this.colors=this.state.colorPalette.map(t=>this._hexToRgb(t)),1!==this.colors.length)if(null===this.state.colorPositions)this.colorPositions=this.colors.map((t,e)=>e/(this.colors.length-1));else{if(this.state.colorPositions.length!==this.colors.length)throw new Error("colorPositions must have the same length as colors");const t=this.state.colorPositions.map((t,e)=>({pos:t,color:this.colors[e]}));t.sort((t,e)=>t.pos-e.pos),this.colorPositions=t.map(t=>t.pos),this.colors=t.map(t=>t.color);const e=this.colorPositions[0],n=this.colorPositions[this.colorPositions.length-1];this.colorPositions=e===n?this.colorPositions.map(()=>0):this.colorPositions.map(t=>(t-e)/(n-e))}else this.colorPositions=[0]}getValue(t){if(null==t||""===t)return this.state.nullValue;if(1===this.colors.length)return this._rgbToHex(this.colors[0].r,this.colors[0].g,this.colors[0].b);if(this.dataMin===this.dataMax){if(t<this.dataMin)return this._rgbToHex(this.colors[0].r,this.colors[0].g,this.colors[0].b);if(t>this.dataMax){const t=this.colors[this.colors.length-1];return this._rgbToHex(t.r,t.g,t.b)}{const t=Math.floor(this.colors.length/2),e=this.colors[t];return this._rgbToHex(e.r,e.g,e.b)}}const e=(Math.max(this.dataMin,Math.min(this.dataMax,t))-this.dataMin)/(this.dataMax-this.dataMin),n=this.state.transformMin+e*(this.state.transformMax-this.state.transformMin),i=Math.max(0,Math.min(1,n));if(i<=this.colorPositions[0])return this._rgbToHex(this.colors[0].r,this.colors[0].g,this.colors[0].b);if(i>=this.colorPositions[this.colorPositions.length-1]){const t=this.colors[this.colors.length-1];return this._rgbToHex(t.r,t.g,t.b)}let a=0;for(let r=0;r<this.colorPositions.length-1;r++)i>=this.colorPositions[r]&&(a=r);const o=Math.min(a+1,this.colors.length-1);if(i===this.colorPositions[a]){const t=this.colors[a];return this._rgbToHex(t.r,t.g,t.b)}if(i===this.colorPositions[o]){const t=this.colors[o];return this._rgbToHex(t.r,t.g,t.b)}const s=(i-this.colorPositions[a])/(this.colorPositions[o]-this.colorPositions[a]);return this._interpolateColor(this.colors[a],this.colors[o],s)}_interpolateColor(t,e,n){const i=Math.round(t.r+(e.r-t.r)*n),a=Math.round(t.g+(e.g-t.g)*n),o=Math.round(t.b+(e.b-t.b)*n);return this._rgbToHex(i,a,o)}_hexToRgb(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}_rgbToHex(t,e,n){return"#"+[t,e,n].map(t=>{const e=t.toString(16);return 1===e.length?"0"+e:e}).join("")}}class ui{defaultPalette=["#440154","#31688e","#35b779","#fde724"];constructor(t,e={}){if(!Array.isArray(t)||0===t.length)throw new Error("categoryData must be a non-empty array");this.state={transformMin:0,transformMax:1,colorPalette:null,colorPositions:null,maxCategories:10,nullValue:"#808080",...e},this.frequencyMap=new Map;for(const n of t)null!=n&&""!==n&&(this.frequencyMap.has(n)?this.frequencyMap.set(n,this.frequencyMap.get(n)+1):this.frequencyMap.set(n,1));if(this.categories=[...this.frequencyMap.entries()].sort((t,e)=>e[1]-t[1]).map(t=>t[0]),null===this.state.colorPalette&&(this.state.colorPalette=this.defaultPalette),this.state.colorPalette.length<1)throw new Error("At least 1 color is required");if(this.colors=this.state.colorPalette.map(t=>this._hexToRgb(t)),1===this.colors.length)return this.colorPositions=[0],void this._assignColors();if(null===this.state.colorPositions)this.colorPositions=this.colors.map((t,e)=>e/(this.colors.length-1));else{if(this.state.colorPositions.length!==this.colors.length)throw new Error("colorPositions must have the same length as colors");const t=this.state.colorPositions.map((t,e)=>({pos:t,color:this.colors[e]}));t.sort((t,e)=>t.pos-e.pos),this.colorPositions=t.map(t=>t.pos),this.colors=t.map(t=>t.color);const e=this.colorPositions[0],n=this.colorPositions[this.colorPositions.length-1];this.colorPositions=e===n?this.colorPositions.map(()=>0):this.colorPositions.map(t=>(t-e)/(n-e))}this._assignColors()}_assignColors(){if(this.categoryColorMap=new Map,1===this.colors.length){const t=this._rgbToHex(this.colors[0].r,this.colors[0].g,this.colors[0].b);for(const e of this.categories)this.categoryColorMap.set(e,t);return}if(0!==this.categories.length)if(1===this.categories.length){const t=this._getColorAtPosition(this.state.transformMin);this.categoryColorMap.set(this.categories[0],t)}else{const t=this.categories.length>this.state.maxCategories?this.state.maxCategories:this.categories.length;for(let e=0;e<this.categories.length;e++){const n=e>=t?1:e/(t-1),i=this.state.transformMin+n*(this.state.transformMax-this.state.transformMin),a=this._getColorAtPosition(i);this.categoryColorMap.set(this.categories[e],a)}}}_getColorAtPosition(t){if(t=Math.max(0,Math.min(1,t)),1===this.colors.length)return this._rgbToHex(this.colors[0].r,this.colors[0].g,this.colors[0].b);if(t<=this.colorPositions[0])return this._rgbToHex(this.colors[0].r,this.colors[0].g,this.colors[0].b);if(t>=this.colorPositions[this.colorPositions.length-1]){const t=this.colors[this.colors.length-1];return this._rgbToHex(t.r,t.g,t.b)}let e=0;for(let a=0;a<this.colorPositions.length-1;a++)t>=this.colorPositions[a]&&(e=a);const n=Math.min(e+1,this.colors.length-1);if(t===this.colorPositions[e]){const t=this.colors[e];return this._rgbToHex(t.r,t.g,t.b)}if(t===this.colorPositions[n]){const t=this.colors[n];return this._rgbToHex(t.r,t.g,t.b)}const i=(t-this.colorPositions[e])/(this.colorPositions[n]-this.colorPositions[e]);return this._interpolateColor(this.colors[e],this.colors[n],i)}getValue(t){if(null==t||""===t)return this.state.nullValue;if(this.categoryColorMap.has(t))return this.categoryColorMap.get(t);throw new Error(`Unknown category: ${t}`)}_interpolateColor(t,e,n){const i=Math.round(t.r+(e.r-t.r)*n),a=Math.round(t.g+(e.g-t.g)*n),o=Math.round(t.b+(e.b-t.b)*n);return this._rgbToHex(i,a,o)}_hexToRgb(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}_rgbToHex(t,e,n){return"#"+[t,e,n].map(t=>{const e=t.toString(16);return 1===e.length?"0"+e:e}).join("")}}
/*!
   * vanilla-picker v2.12.3
   * https://vanilla-picker.js.org
   *
   * Copyright 2017-2024 Andreas Borgen (https://github.com/Sphinxxxx), Adam Brooks (https://github.com/dissimulate)
   * Released under the ISC license.
   */var di=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},pi=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),fi=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,a=!1,o=void 0;try{for(var s,r=t[Symbol.iterator]();!(i=(s=r.next()).done)&&(n.push(s.value),!e||n.length!==e);i=!0);}catch(l){a=!0,o=l}finally{try{!i&&r.return&&r.return()}finally{if(a)throw o}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();String.prototype.startsWith=String.prototype.startsWith||function(t){return 0===this.indexOf(t)},String.prototype.padStart=String.prototype.padStart||function(t,e){for(var n=this;n.length<t;)n=e+n;return n};var gi={cb:"0f8ff",tqw:"aebd7",q:"-ffff",qmrn:"7fffd4",zr:"0ffff",bg:"5f5dc",bsq:"e4c4",bck:"---",nch:"ebcd",b:"--ff",bvt:"8a2be2",brwn:"a52a2a",brw:"deb887",ctb:"5f9ea0",hrt:"7fff-",chcT:"d2691e",cr:"7f50",rnw:"6495ed",crns:"8dc",crms:"dc143c",cn:"-ffff",Db:"--8b",Dcn:"-8b8b",Dgnr:"b8860b",Dgr:"a9a9a9",Dgrn:"-64-",Dkhk:"bdb76b",Dmgn:"8b-8b",Dvgr:"556b2f",Drng:"8c-",Drch:"9932cc",Dr:"8b--",Dsmn:"e9967a",Dsgr:"8fbc8f",DsTb:"483d8b",DsTg:"2f4f4f",Dtrq:"-ced1",Dvt:"94-d3",ppnk:"1493",pskb:"-bfff",mgr:"696969",grb:"1e90ff",rbrc:"b22222",rwht:"af0",stg:"228b22",chs:"-ff",gnsb:"dcdcdc",st:"8f8ff",g:"d7-",gnr:"daa520",gr:"808080",grn:"-8-0",grnw:"adff2f",hnw:"0fff0",htpn:"69b4",nnr:"cd5c5c",ng:"4b-82",vr:"0",khk:"0e68c",vnr:"e6e6fa",nrb:"0f5",wngr:"7cfc-",mnch:"acd",Lb:"add8e6",Lcr:"08080",Lcn:"e0ffff",Lgnr:"afad2",Lgr:"d3d3d3",Lgrn:"90ee90",Lpnk:"b6c1",Lsmn:"a07a",Lsgr:"20b2aa",Lskb:"87cefa",LsTg:"778899",Lstb:"b0c4de",Lw:"e0",m:"-ff-",mgrn:"32cd32",nn:"af0e6",mgnt:"-ff",mrn:"8--0",mqm:"66cdaa",mmb:"--cd",mmrc:"ba55d3",mmpr:"9370db",msg:"3cb371",mmsT:"7b68ee","":"-fa9a",mtr:"48d1cc",mmvt:"c71585",mnLb:"191970",ntc:"5fffa",mstr:"e4e1",mccs:"e4b5",vjw:"dead",nv:"--80",c:"df5e6",v:"808-0",vrb:"6b8e23",rng:"a5-",rngr:"45-",rch:"da70d6",pgnr:"eee8aa",pgrn:"98fb98",ptrq:"afeeee",pvtr:"db7093",ppwh:"efd5",pchp:"dab9",pr:"cd853f",pnk:"c0cb",pm:"dda0dd",pwrb:"b0e0e6",prp:"8-080",cc:"663399",r:"--",sbr:"bc8f8f",rb:"4169e1",sbrw:"8b4513",smn:"a8072",nbr:"4a460",sgrn:"2e8b57",ssh:"5ee",snn:"a0522d",svr:"c0c0c0",skb:"87ceeb",sTb:"6a5acd",sTgr:"708090",snw:"afa",n:"-ff7f",stb:"4682b4",tn:"d2b48c",t:"-8080",thst:"d8bfd8",tmT:"6347",trqs:"40e0d0",vt:"ee82ee",whT:"5deb3",wht:"",hts:"5f5f5",w:"-",wgrn:"9acd32"};function mi(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return(e>0?t.toFixed(e).replace(/0+$/,"").replace(/\.$/,""):t.toString())||"0"}var yi=function(){function t(e,n,i,a){di(this,t);var o=this;if(void 0===e);else if(Array.isArray(e))this.rgba=e;else if(void 0===i){var s=e&&""+e;s&&function(e){if(e.startsWith("hsl")){var n=e.match(/([\-\d\.e]+)/g).map(Number),i=fi(n,4),a=i[0],s=i[1],r=i[2],l=i[3];void 0===l&&(l=1),a/=360,s/=100,r/=100,o.hsla=[a,s,r,l]}else if(e.startsWith("rgb")){var h=e.match(/([\-\d\.e]+)/g).map(Number),c=fi(h,4),u=c[0],d=c[1],p=c[2],f=c[3];void 0===f&&(f=1),o.rgba=[u,d,p,f]}else e.startsWith("#")?o.rgba=t.hexToRgb(e):o.rgba=t.nameToRgb(e)||t.hexToRgb(e)}(s.toLowerCase())}else this.rgba=[e,n,i,void 0===a?1:a]}return pi(t,[{key:"printRGB",value:function(t){var e=(t?this.rgba:this.rgba.slice(0,3)).map(function(t,e){return mi(t,3===e?3:0)});return t?"rgba("+e+")":"rgb("+e+")"}},{key:"printHSL",value:function(t){var e=[360,100,100,1],n=["","%","%",""],i=(t?this.hsla:this.hsla.slice(0,3)).map(function(t,i){return mi(t*e[i],3===i?3:1)+n[i]});return t?"hsla("+i+")":"hsl("+i+")"}},{key:"printHex",value:function(t){var e=this.hex;return t?e:e.substring(0,7)}},{key:"rgba",get:function(){if(this._rgba)return this._rgba;if(!this._hsla)throw new Error("No color is set");return this._rgba=t.hslToRgb(this._hsla)},set:function(t){3===t.length&&(t[3]=1),this._rgba=t,this._hsla=null}},{key:"rgbString",get:function(){return this.printRGB()}},{key:"rgbaString",get:function(){return this.printRGB(!0)}},{key:"hsla",get:function(){if(this._hsla)return this._hsla;if(!this._rgba)throw new Error("No color is set");return this._hsla=t.rgbToHsl(this._rgba)},set:function(t){3===t.length&&(t[3]=1),this._hsla=t,this._rgba=null}},{key:"hslString",get:function(){return this.printHSL()}},{key:"hslaString",get:function(){return this.printHSL(!0)}},{key:"hex",get:function(){return"#"+this.rgba.map(function(t,e){return e<3?t.toString(16):Math.round(255*t).toString(16)}).map(function(t){return t.padStart(2,"0")}).join("")},set:function(e){this.rgba=t.hexToRgb(e)}}],[{key:"hexToRgb",value:function(t){var e=(t.startsWith("#")?t.slice(1):t).replace(/^(\w{3})$/,"$1F").replace(/^(\w)(\w)(\w)(\w)$/,"$1$1$2$2$3$3$4$4").replace(/^(\w{6})$/,"$1FF");if(!e.match(/^([0-9a-fA-F]{8})$/))throw new Error("Unknown hex color; "+t);var n=e.match(/^(\w\w)(\w\w)(\w\w)(\w\w)$/).slice(1).map(function(t){return parseInt(t,16)});return n[3]=n[3]/255,n}},{key:"nameToRgb",value:function(e){var n=e.toLowerCase().replace("at","T").replace(/[aeiouyldf]/g,"").replace("ght","L").replace("rk","D").slice(-5,4),i=gi[n];return void 0===i?i:t.hexToRgb(i.replace(/\-/g,"00").padStart(6,"f"))}},{key:"rgbToHsl",value:function(t){var e=fi(t,4),n=e[0],i=e[1],a=e[2],o=e[3];n/=255,i/=255,a/=255;var s=Math.max(n,i,a),r=Math.min(n,i,a),l=void 0,h=void 0,c=(s+r)/2;if(s===r)l=h=0;else{var u=s-r;switch(h=c>.5?u/(2-s-r):u/(s+r),s){case n:l=(i-a)/u+(i<a?6:0);break;case i:l=(a-n)/u+2;break;case a:l=(n-i)/u+4}l/=6}return[l,h,c,o]}},{key:"hslToRgb",value:function(t){var e=fi(t,4),n=e[0],i=e[1],a=e[2],o=e[3],s=void 0,r=void 0,l=void 0;if(0===i)s=r=l=a;else{var h=function(t,e,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+6*(e-t)*n:n<.5?e:n<2/3?t+(e-t)*(2/3-n)*6:t},c=a<.5?a*(1+i):a+i-a*i,u=2*a-c;s=h(u,c,n+1/3),r=h(u,c,n),l=h(u,c,n-1/3)}var d=[255*s,255*r,255*l].map(Math.round);return d[3]=o,d}}]),t}(),bi=function(){function t(){di(this,t),this._events=[]}return pi(t,[{key:"add",value:function(t,e,n){t.addEventListener(e,n,!1),this._events.push({target:t,type:e,handler:n})}},{key:"remove",value:function(e,n,i){this._events=this._events.filter(function(a){var o=!0;return e&&e!==a.target&&(o=!1),n&&n!==a.type&&(o=!1),i&&i!==a.handler&&(o=!1),o&&t._doRemove(a.target,a.type,a.handler),!o})}},{key:"destroy",value:function(){this._events.forEach(function(e){return t._doRemove(e.target,e.type,e.handler)}),this._events=[]}}],[{key:"_doRemove",value:function(t,e,n){t.removeEventListener(e,n,!1)}}]),t}();function xi(t,e,n){var i=!1;function a(t,e,n){return Math.max(e,Math.min(t,n))}function o(t,o,s){if(s&&(i=!0),i){t.preventDefault();var r=e.getBoundingClientRect(),l=r.width,h=r.height,c=o.clientX,u=o.clientY,d=a(c-r.left,0,l),p=a(u-r.top,0,h);n(d/l,p/h)}}function s(t,e){1===(void 0===t.buttons?t.which:t.buttons)?o(t,t,e):i=!1}function r(t,e){1===t.touches.length?o(t,t.touches[0],e):i=!1}t.add(e,"mousedown",function(t){s(t,!0)}),t.add(e,"touchstart",function(t){r(t,!0)}),t.add(window,"mousemove",s),t.add(e,"touchmove",r),t.add(window,"mouseup",function(t){i=!1}),t.add(e,"touchend",function(t){i=!1}),t.add(e,"touchcancel",function(t){i=!1})}var vi="keydown",wi="mousedown",_i="focusin";function Ci(t,e){return(e||document).querySelector(t)}function ki(t,e,n,i,a){t.add(e,vi,function(t){n.indexOf(t.key)>=0&&i(t)})}var Si=function(){function t(e){di(this,t),this.settings={popup:"right",layout:"default",alpha:!0,editor:!0,editorFormat:"hex",cancelButton:!1,defaultColor:"#0cf"},this._events=new bi,this.onChange=null,this.onDone=null,this.onOpen=null,this.onClose=null,this.setOptions(e)}return pi(t,[{key:"setOptions",value:function(t){var e=this;if(t){var n=this.settings;if(t instanceof HTMLElement)n.parent=t;else{n.parent&&t.parent&&n.parent!==t.parent&&(this._events.remove(n.parent),this._popupInited=!1),function(t,e){for(var n in t)e[n]=t[n]}(t,n),t.onChange&&(this.onChange=t.onChange),t.onDone&&(this.onDone=t.onDone),t.onOpen&&(this.onOpen=t.onOpen),t.onClose&&(this.onClose=t.onClose);var i=t.color||t.colour;i&&this._setColor(i)}var a=n.parent;if(a&&n.popup&&!this._popupInited){var o=function(t){return e.openHandler(t)};this._events.add(a,"click",o),ki(this._events,a,[" ","Spacebar","Enter"],o),this._popupInited=!0}else t.parent&&!n.popup&&this.show()}}},{key:"openHandler",value:function(t){if(this.show()){t&&t.preventDefault(),this.settings.parent.style.pointerEvents="none";var e=t&&t.type===vi?this._domEdit:this.domElement;setTimeout(function(){return e.focus()},100),this.onOpen&&this.onOpen(this.colour)}}},{key:"closeHandler",value:function(t){var e=t&&t.type,n=!1;if(t)if(e===wi||e===_i){var i=(this.__containedEvent||0)+100;t.timeStamp>i&&(n=!0)}else!function(t){t.preventDefault(),t.stopPropagation()}(t),n=!0;else n=!0;n&&this.hide()&&(this.settings.parent.style.pointerEvents="",e!==wi&&this.settings.parent.focus(),this.onClose&&this.onClose(this.colour))}},{key:"movePopup",value:function(t,e){this.closeHandler(),this.setOptions(t),e&&this.openHandler()}},{key:"setColor",value:function(t,e){this._setColor(t,{silent:e})}},{key:"_setColor",value:function(t,e){if("string"==typeof t&&(t=t.trim()),t){e=e||{};var n=void 0;try{n=new yi(t)}catch(a){if(e.failSilently)return;throw a}if(!this.settings.alpha){var i=n.hsla;i[3]=1,n.hsla=i}this.colour=this.color=n,this._setHSLA(null,null,null,null,e)}}},{key:"setColour",value:function(t,e){this.setColor(t,e)}},{key:"show",value:function(){if(!this.settings.parent)return!1;if(this.domElement){var t=this._toggleDOM(!0);return this._setPosition(),t}var e,n,i=this.settings.template||'<div class="picker_wrapper" tabindex="-1"><div class="picker_arrow"></div><div class="picker_hue picker_slider"><div class="picker_selector"></div></div><div class="picker_sl"><div class="picker_selector"></div></div><div class="picker_alpha picker_slider"><div class="picker_selector"></div></div><div class="picker_editor"><input aria-label="Type a color name or hex value"/></div><div class="picker_sample"></div><div class="picker_done"><button>Ok</button></div><div class="picker_cancel"><button>Cancel</button></div></div>',a=(e=i,(n=document.createElement("div")).innerHTML=e,n.firstElementChild);return this.domElement=a,this._domH=Ci(".picker_hue",a),this._domSL=Ci(".picker_sl",a),this._domA=Ci(".picker_alpha",a),this._domEdit=Ci(".picker_editor input",a),this._domSample=Ci(".picker_sample",a),this._domOkay=Ci(".picker_done button",a),this._domCancel=Ci(".picker_cancel button",a),a.classList.add("layout_"+this.settings.layout),this.settings.alpha||a.classList.add("no_alpha"),this.settings.editor||a.classList.add("no_editor"),this.settings.cancelButton||a.classList.add("no_cancel"),this._ifPopup(function(){return a.classList.add("popup")}),this._setPosition(),this.colour?this._updateUI():this._setColor(this.settings.defaultColor),this._bindEvents(),!0}},{key:"hide",value:function(){return this._toggleDOM(!1)}},{key:"destroy",value:function(){this._events.destroy(),this.domElement&&this.settings.parent.removeChild(this.domElement)}},{key:"_bindEvents",value:function(){var t=this,e=this,n=this.domElement,i=this._events;function a(t,e,n){i.add(t,e,n)}a(n,"click",function(t){return t.preventDefault()}),xi(i,this._domH,function(t,n){return e._setHSLA(t)}),xi(i,this._domSL,function(t,n){return e._setHSLA(null,t,1-n)}),this.settings.alpha&&xi(i,this._domA,function(t,n){return e._setHSLA(null,null,null,1-n)});var o=this._domEdit;a(o,"input",function(t){e._setColor(this.value,{fromEditor:!0,failSilently:!0})}),a(o,"focus",function(t){var e=this;e.selectionStart===e.selectionEnd&&e.select()}),this._ifPopup(function(){var e=function(e){return t.closeHandler(e)};a(window,wi,e),a(window,_i,e),ki(i,n,["Esc","Escape"],e);var o=function(e){t.__containedEvent=e.timeStamp};a(n,wi,o),a(n,_i,o),a(t._domCancel,"click",e)});var s=function(e){t._ifPopup(function(){return t.closeHandler(e)}),t.onDone&&t.onDone(t.colour)};a(this._domOkay,"click",s),ki(i,n,["Enter"],s)}},{key:"_setPosition",value:function(){var t=this.settings.parent,e=this.domElement;t!==e.parentNode&&t.appendChild(e),this._ifPopup(function(n){"static"===getComputedStyle(t).position&&(t.style.position="relative");var i=!0===n?"popup_right":"popup_"+n;["popup_top","popup_bottom","popup_left","popup_right"].forEach(function(t){t===i?e.classList.add(t):e.classList.remove(t)}),e.classList.add(i)})}},{key:"_setHSLA",value:function(t,e,n,i,a){a=a||{};var o=this.colour,s=o.hsla;[t,e,n,i].forEach(function(t,e){(t||0===t)&&(s[e]=t)}),o.hsla=s,this._updateUI(a),this.onChange&&!a.silent&&this.onChange(o)}},{key:"_updateUI",value:function(t){if(this.domElement){t=t||{};var e=this.colour,n=e.hsla,i="hsl("+360*n[0]+", 100%, 50%)",a=e.hslString,o=e.hslaString,s=this._domH,r=this._domSL,l=this._domA,h=Ci(".picker_selector",s),c=Ci(".picker_selector",r),u=Ci(".picker_selector",l);b(0,h,n[0]),this._domSL.style.backgroundColor=this._domH.style.color=i,b(0,c,n[1]),x(0,c,1-n[2]),r.style.color=a,x(0,u,1-n[3]);var d=a,p=d.replace("hsl","hsla").replace(")",", 0)"),f="linear-gradient("+[d,p]+")";if(this._domA.style.background=f+", linear-gradient(45deg, lightgrey 25%, transparent 25%, transparent 75%, lightgrey 75%) 0 0 / 2em 2em,\n                   linear-gradient(45deg, lightgrey 25%,       white 25%,       white 75%, lightgrey 75%) 1em 1em / 2em 2em",!t.fromEditor){var g=this.settings.editorFormat,m=this.settings.alpha,y=void 0;switch(g){case"rgb":y=e.printRGB(m);break;case"hsl":y=e.printHSL(m);break;default:y=e.printHex(m)}this._domEdit.value=y}this._domSample.style.color=o}function b(t,e,n){e.style.left=100*n+"%"}function x(t,e,n){e.style.top=100*n+"%"}}},{key:"_ifPopup",value:function(t,e){this.settings.parent&&this.settings.popup?t&&t(this.settings.popup):e&&e()}},{key:"_toggleDOM",value:function(t){var e=this.domElement;if(!e)return!1;var n=t?"":"none",i=e.style.display!==n;return i&&(e.style.display=n),i}}]),t}(),Li=document.createElement("style");Li.textContent='.picker_wrapper.no_alpha .picker_alpha{display:none}.picker_wrapper.no_editor .picker_editor{position:absolute;z-index:-1;opacity:0}.picker_wrapper.no_cancel .picker_cancel{display:none}.layout_default.picker_wrapper{display:flex;flex-flow:row wrap;justify-content:space-between;align-items:stretch;font-size:10px;width:25em;padding:.5em}.layout_default.picker_wrapper input,.layout_default.picker_wrapper button{font-size:1rem}.layout_default.picker_wrapper>*{margin:.5em}.layout_default.picker_wrapper::before{content:"";display:block;width:100%;height:0;order:1}.layout_default .picker_slider,.layout_default .picker_selector{padding:1em}.layout_default .picker_hue{width:100%}.layout_default .picker_sl{flex:1 1 auto}.layout_default .picker_sl::before{content:"";display:block;padding-bottom:100%}.layout_default .picker_editor{order:1;width:6.5rem}.layout_default .picker_editor input{width:100%;height:100%}.layout_default .picker_sample{order:1;flex:1 1 auto}.layout_default .picker_done,.layout_default .picker_cancel{order:1}.picker_wrapper{box-sizing:border-box;background:#f2f2f2;box-shadow:0 0 0 1px silver;cursor:default;font-family:sans-serif;color:#444;pointer-events:auto}.picker_wrapper:focus{outline:none}.picker_wrapper button,.picker_wrapper input{box-sizing:border-box;border:none;box-shadow:0 0 0 1px silver;outline:none}.picker_wrapper button:focus,.picker_wrapper button:active,.picker_wrapper input:focus,.picker_wrapper input:active{box-shadow:0 0 2px 1px #1e90ff}.picker_wrapper button{padding:.4em .6em;cursor:pointer;background-color:#f5f5f5;background-image:linear-gradient(0deg, gainsboro, transparent)}.picker_wrapper button:active{background-image:linear-gradient(0deg, transparent, gainsboro)}.picker_wrapper button:hover{background-color:#fff}.picker_selector{position:absolute;z-index:1;display:block;-webkit-transform:translate(-50%, -50%);transform:translate(-50%, -50%);border:2px solid #fff;border-radius:100%;box-shadow:0 0 3px 1px #67b9ff;background:currentColor;cursor:pointer}.picker_slider .picker_selector{border-radius:2px}.picker_hue{position:relative;background-image:linear-gradient(90deg, red, yellow, lime, cyan, blue, magenta, red);box-shadow:0 0 0 1px silver}.picker_sl{position:relative;box-shadow:0 0 0 1px silver;background-image:linear-gradient(180deg, white, rgba(255, 255, 255, 0) 50%),linear-gradient(0deg, black, rgba(0, 0, 0, 0) 50%),linear-gradient(90deg, #808080, rgba(128, 128, 128, 0))}.picker_alpha,.picker_sample{position:relative;background:linear-gradient(45deg, lightgrey 25%, transparent 25%, transparent 75%, lightgrey 75%) 0 0/2em 2em,linear-gradient(45deg, lightgrey 25%, white 25%, white 75%, lightgrey 75%) 1em 1em/2em 2em;box-shadow:0 0 0 1px silver}.picker_alpha .picker_selector,.picker_sample .picker_selector{background:none}.picker_editor input{font-family:monospace;padding:.2em .4em}.picker_sample::before{content:"";position:absolute;display:block;width:100%;height:100%;background:currentColor}.picker_arrow{position:absolute;z-index:-1}.picker_wrapper.popup{position:absolute;z-index:2;margin:1.5em}.picker_wrapper.popup,.picker_wrapper.popup .picker_arrow::before,.picker_wrapper.popup .picker_arrow::after{background:#f2f2f2;box-shadow:0 0 10px 1px rgba(0,0,0,.4)}.picker_wrapper.popup .picker_arrow{width:3em;height:3em;margin:0}.picker_wrapper.popup .picker_arrow::before,.picker_wrapper.popup .picker_arrow::after{content:"";display:block;position:absolute;top:0;left:0;z-index:-99}.picker_wrapper.popup .picker_arrow::before{width:100%;height:100%;-webkit-transform:skew(45deg);transform:skew(45deg);-webkit-transform-origin:0 100%;transform-origin:0 100%}.picker_wrapper.popup .picker_arrow::after{width:150%;height:150%;box-shadow:none}.popup.popup_top{bottom:100%;left:0}.popup.popup_top .picker_arrow{bottom:0;left:0;-webkit-transform:rotate(-90deg);transform:rotate(-90deg)}.popup.popup_bottom{top:100%;left:0}.popup.popup_bottom .picker_arrow{top:0;left:0;-webkit-transform:rotate(90deg) scale(1, -1);transform:rotate(90deg) scale(1, -1)}.popup.popup_left{top:0;right:100%}.popup.popup_left .picker_arrow{top:0;right:0;-webkit-transform:scale(-1, 1);transform:scale(-1, 1)}.popup.popup_right{top:0;left:100%}.popup.popup_right .picker_arrow{top:0;left:0}',document.documentElement.firstElementChild.appendChild(Li),Si.StyleElement=Li;class Pi extends ai{state;scale;values;defaultPalette=["#440154","#365C8D","#1FA187","#9FDA3A"];constructor(t,e={}){if(super(),!e.scaleType)throw new Error("scaleType is required");if(void 0===e.default)throw new Error("default is required");this.values=t,this.state={scaleType:void 0,default:void 0,isCategorical:void 0,outputValues:null,outputRegex:null,colorPalette:this.defaultPalette,colorPositions:this.defaultPalette.map((t,e)=>e/(this.defaultPalette.length-1)),outputRange:null,inputUnits:null,title:null,maxCategories:7,otherCategory:"#888888",otherLabel:"Other",transformMin:0,transformMax:1,transformFn:null,nullValue:"#808080",showNullInLegend:!0,...e},this.updateScale(!1)}getValue(t){return this.scale.getValue(t)}updateScale(t=!0){const e=this.values,{scaleType:n,isCategorical:i}=this.state;let a,o=!0;if(i&&(this.state.outputValues||this.state.outputRegex)){if(this.state.outputValues)for(let t=0;t<e.length;t++)if(e[t]&&!this.state.outputValues.includes(e[t])){o=!1;break}if(this.state.outputRegex)for(let t=0;t<e.length;t++)if(e[t]&&!this.state.outputRegex.test(e[t])){o=!1;break}}else o=!1;if("null"===n)a=new si(this.state),this.scale=a;else if("identity"===n||o)a=new ri(this.state),this.scale=a;else if("text"===n){if(!i)throw new Error("Text scales can only be used with categorical data");a=new li(e,this.state),this.scale=a}else if("size"===n){if(i)throw new Error("Size scales can only be used with continuous data");const t=e.map(t=>Number(t)).filter(t=>!isNaN(t));if(0===t.length)console.warn("No numeric values found for size scale, using NullScale"),a=new si(this.state);else{const e=Math.min(...t),n=Math.max(...t);a=new hi(e,n,this.state)}this.scale=a}else{if("color"!==n)throw new Error(`Unknown scale type: ${n}`);if(i)a=new ui(e,this.state);else{const t=e.map(t=>Number(t)).filter(t=>!isNaN(t));if(0===t.length)console.warn("No numeric values found for color scale, using NullScale"),a=new si(this.state);else{const e=Math.min(...t),n=Math.max(...t);a=new ci(e,n,this.state)}}this.scale=a}t&&this.notify("aestheticChange",this)}updateState(t){Object.assign(this.state,t),this.updateScale(this.values)}createSettingsWidget(t={}){const{controlHeight:e=24}=t;return"color"===this.state.scaleType?this.createColorPaletteEditor(e):null}createColorPaletteEditor(t){if(!this.scale)return null;const e=document.createElement("div");e.className="ht-color-palette-editor";const n=document.createElement("div");n.className="ht-gradient-container";const i=document.createElement("div");i.className="ht-gradient-column";const a=document.createElement("div");a.className="ht-color-squares-container";const o=document.createElement("div");o.className="ht-gradient-box";const s=()=>{const t=this.state.colorPalette.map((t,e)=>`${t} ${100*this.state.colorPositions[e]}%`).join(", ");o.style.background=`linear-gradient(to right, ${t})`};s();let r=null;const l=document.createElement("div");l.style.position="fixed",l.style.zIndex="999999",l.style.pointerEvents="auto",document.body.appendChild(l);const h=document.createElement("div");h.style.position="fixed",h.style.zIndex="999999",h.style.pointerEvents="auto",document.body.appendChild(h);const c=()=>{l.style.display="none",r=null},u=()=>{h.style.display="none"},d=document.createElement("div");d.className="ht-null-color-column";const p=document.createElement("div");p.className="ht-null-color-square-container";const f=document.createElement("div");f.style.display="flex",f.style.flexDirection="column",f.style.alignItems="center";const g=document.createElement("div");g.className="ht-null-color-square",g.style.backgroundColor=this.state.nullValue,g.title="Click to edit missing data color";const m=document.createElement("div");m.className="ht-null-color-square-tick",f.appendChild(g),f.appendChild(m),p.appendChild(f);const y=document.createElement("div");y.className="ht-null-color-box",y.style.backgroundColor=this.state.nullValue;const b=new Si({parent:l,popup:!1,alpha:!1,editor:!0,color:this.state.colorPalette[0],onChange:t=>{if(!r)return;const e=parseInt(r.getAttribute("data-color-index")),n=t.hex.substring(0,7);this.state.colorPalette[e]=n,r.style.backgroundColor=n,s();const i=Ti(this.state.colorPalette,this.state.colorPositions,this.state.transformMin);k.style.backgroundColor=i;const a=Ti(this.state.colorPalette,this.state.colorPositions,this.state.transformMax);P.style.backgroundColor=a,this.updateScale()},onDone:()=>{c()}});l.style.display="none";const x=t=>{l.contains(t.target)||t.target.closest(".ht-color-square")||c()};document.addEventListener("click",x);const v=new Si({parent:h,popup:!1,alpha:!1,editor:!0,color:this.state.nullValue,onChange:t=>{const e=t.hex.substring(0,7);this.state.nullValue=e,g.style.backgroundColor=e,y.style.backgroundColor=e,this.updateScale()},onDone:()=>{u()}});h.style.display="none";const w=t=>{h.contains(t.target)||t.target===g||u()};document.addEventListener("click",w),e.dataset.pickerCleanup="cleanup",e.cleanupFunction=()=>{document.removeEventListener("click",x),document.removeEventListener("click",w),l.parentElement&&l.parentElement.removeChild(l),h.parentElement&&h.parentElement.removeChild(h)};const _=()=>{a.innerHTML="",this.state.colorPalette.forEach((t,e)=>{const n=function(t,e,n,i){const a=document.createElement("div");a.className="ht-color-square-wrapper";const o=document.createElement("div");o.className="ht-color-square",o.style.backgroundColor=e,o.title="Click to edit color",o.setAttribute("data-color-index",n),o.addEventListener("click",i);const s=document.createElement("div");return s.className="ht-color-square-tick",a.appendChild(o),a.appendChild(s),t.appendChild(a),a}(a,t,e,t=>{t.preventDefault(),t.stopPropagation();const e=t.currentTarget,n=parseInt(e.getAttribute("data-color-index"));u(),r=e;const i=e.getBoundingClientRect();b.setColor(this.state.colorPalette[n],!0),l.style.left=`${i.left}px`,l.style.top=`${i.bottom+5}px`,l.style.display="block"});n.style.left=100*this.state.colorPositions[e]+"%"})};_();const C=document.createElement("div");C.className="ht-range-slider-container";const k=document.createElement("div");k.className="ht-range-handle",k.style.left=100*this.state.transformMin+"%",k.title="Drag to adjust minimum";let S=Ti(this.state.colorPalette,this.state.colorPositions,this.state.transformMin);k.style.backgroundColor=S;const L=document.createElement("div");L.className="ht-range-handle-indicator",k.appendChild(L);const P=document.createElement("div");P.className="ht-range-handle",P.style.left=100*this.state.transformMax+"%",P.title="Drag to adjust maximum";let M=Ti(this.state.colorPalette,this.state.colorPositions,this.state.transformMax);P.style.backgroundColor=M;const T=document.createElement("div");T.className="ht-range-handle-indicator",P.appendChild(T);let E=!1;k.addEventListener("mousedown",t=>{E=!0,t.preventDefault()});let z=!1;P.addEventListener("mousedown",t=>{z=!0,t.preventDefault()});document.addEventListener("mousemove",t=>{if(!E&&!z)return;const e=C.getBoundingClientRect(),n=t.clientX-e.left,i=e.width;let a=Math.max(0,Math.min(1,n/i));E?(a=Math.min(a,this.state.transformMax-.01),this.state.transformMin=a,k.style.left=100*a+"%",S=Ti(this.state.colorPalette,this.state.colorPositions,a),k.style.backgroundColor=S,this.updateScale()):z&&(a=Math.max(a,this.state.transformMin+.01),this.state.transformMax=a,P.style.left=100*a+"%",M=Ti(this.state.colorPalette,this.state.colorPositions,a),P.style.backgroundColor=M,this.updateScale())}),document.addEventListener("mouseup",()=>{E=!1,z=!1}),C.appendChild(k),C.appendChild(P),i.appendChild(a),i.appendChild(o),i.appendChild(C),g.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),c();const e=g.getBoundingClientRect();v.setColor(this.state.nullValue,!0),h.style.left=`${e.left}px`,h.style.top=`${e.bottom+5}px`,h.style.display="block"});const $=document.createElement("div");$.className="missing-data-x-container";const N=document.createElement("div");N.className="missing-data-x-container-triangle";const A=document.createElement("div");A.className="missing-data-x",A.textContent="",$.appendChild(N),$.appendChild(A),d.appendChild(p),d.appendChild(y),d.appendChild($),n.appendChild(i),n.appendChild(d);const R=document.createElement("div");R.className="ht-palette-buttons-container";const H=Mi("+","Add color to left");H.addEventListener("click",()=>{const t=this.state.colorPalette[0];this.state.colorPalette.unshift(t),this.state.colorPositions=this.state.colorPalette.map((t,e)=>e/(this.state.colorPalette.length-1)),s(),_(),S=Ti(this.state.colorPalette,this.state.colorPositions,this.state.transformMin),k.style.backgroundColor=S,M=Ti(this.state.colorPalette,this.state.colorPositions,this.state.transformMax),P.style.backgroundColor=M,this.updateScale()});const B=Mi("-","Remove color from left");B.addEventListener("click",()=>{this.state.colorPalette.length<=2?console.warn("Cannot remove color: minimum 2 colors required"):(this.state.colorPalette.shift(),this.state.colorPositions=this.state.colorPalette.map((t,e)=>e/(this.state.colorPalette.length-1)),s(),_(),S=Ti(this.state.colorPalette,this.state.colorPositions,this.state.transformMin),k.style.backgroundColor=S,M=Ti(this.state.colorPalette,this.state.colorPositions,this.state.transformMax),P.style.backgroundColor=M,this.updateScale())}),R.appendChild(H),R.appendChild(B);const D=document.createElement("div");D.className="ht-palette-buttons-container";const F=Mi("+","Add color to right");F.addEventListener("click",()=>{const t=this.state.colorPalette[this.state.colorPalette.length-1];this.state.colorPalette.push(t),this.state.colorPositions=this.state.colorPalette.map((t,e)=>e/(this.state.colorPalette.length-1)),s(),_(),S=Ti(this.state.colorPalette,this.state.colorPositions,this.state.transformMin),k.style.backgroundColor=S,M=Ti(this.state.colorPalette,this.state.colorPositions,this.state.transformMax),P.style.backgroundColor=M,this.updateScale()});const I=Mi("-","Remove color from right");return I.addEventListener("click",()=>{this.state.colorPalette.length<=2?console.warn("Cannot remove color: minimum 2 colors required"):(this.state.colorPalette.pop(),this.state.colorPositions=this.state.colorPalette.map((t,e)=>e/(this.state.colorPalette.length-1)),s(),_(),S=Ti(this.state.colorPalette,this.state.colorPositions,this.state.transformMin),k.style.backgroundColor=S,M=Ti(this.state.colorPalette,this.state.colorPositions,this.state.transformMax),P.style.backgroundColor=M,this.updateScale())}),D.appendChild(F),D.appendChild(I),e.appendChild(R),e.appendChild(n),e.appendChild(D),e}}function Mi(t,e){const n=document.createElement("button");return n.className="ht-palette-button",n.textContent=t,n.title=e,n}function Ti(t,e,n){if(n=Math.max(0,Math.min(1,n)),1===t.length)return t[0];let i=0;for(;i<e.length-1&&n>e[i+1];)i++;if(n===e[i])return t[i];if(i===e.length-1)return t[i];const a=e[i],o=(n-a)/(e[i+1]-a),s=Ei(t[i]),r=Ei(t[i+1]);return function(t,e,n){return"#"+[t,e,n].map(t=>{const e=t.toString(16);return 1===e.length?"0"+e:e}).join("")}(Math.round(s.r+(r.r-s.r)*o),Math.round(s.g+(r.g-s.g)*o),Math.round(s.b+(r.b-s.b)*o))}function Ei(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:{r:0,g:0,b:0}}class zi extends ai{tree;metadata=new Map;metadataTableNames=new Map;columnType=new Map;columnName=new Map;columnDisplayName=new Map;columnAesthetic=new Map;nodeIdColumn=new Map;validIdColumns=new Map;#t=0;constructor(t,e=[],n=[]){super(),this.tree=this.parseTree(t),Array.isArray(e)&&e.forEach((t,e)=>{this.addTable(t,n[e])})}parseTree(t){const e=function(t){";"===(t=t.trim())[t.length-1]&&(t=t.slice(0,-1));let e=0;const n=function n(){let i={};if("("===t[e])for(e++,i.children=[];;){let a=n();if(i.children.push(a),","!==t[e]){if(")"===t[e]){e++;break}break}e++}let a="";for(;e<t.length&&","!==t[e]&&")"!==t[e];)a+=t[e++];if(a=a.trim(),a){let t=a.split(":");i.name=t[0]||"",t.length>1&&(i.length=parseFloat(t[1]))}return i}();if(e!==t.length)throw new Error(`Unexpected character at position ${e}: '${t[e]}'`);return n}(t),n=Ln(e,t=>t.children).sum(t=>t.children?0:1).each(function(t){t.leafCount=t.value,delete t.value,delete t.data.children}).sort((t,e)=>t.leafCount-e.leafCount||function(t,e){return null==t||null==e?NaN:t<e?-1:t>e?1:t>=e?0:NaN}(t.data.length,e.data.length));let i=0;return n.each(t=>{t.id=++i}),n}setTree(t){this.tree=this.parseTree(t),this.metadata.keys().forEach(t=>this.#e(t)),this.notify("treeUpdated",this)}getMetadataTableNames(){return Array.from(this.metadataTableNames.values())}getTreeNodeNames(){const t=new Set;return this.tree.each(e=>{e.data.name&&t.add(e.data.name)}),t}#n(t){const e=this.metadata.get(t),n=this.nodeIdColumn.get(t);if(!e||!n)return new Map;const i=new Map;for(const a of e){const t=a[n];t&&i.set(t,a)}return i}addTable(t,e=null,n="\t"){let{metadataMap:i,columnTypes:a,idColumns:o}=function(t,e,n="\t"){let i=new Map,a=new Map,o=[],s=[];const r=t.trim().split("\n");if(0==r.length)console.error("Empty metadata table");else{const t=r[0].split(n),l=new Map;t.forEach(t=>l.set(t,[]));for(let e=1;e<r.length;e++){const a=r[e].split(n),o={};for(let e=0;e<t.length;e++){const n=t[e],i=""===a[e]?void 0:a[e];o[n]=i,l.get(n).push(i)}i.set(e-1,o)}t.forEach(t=>{const n=l.get(t),i=n.map(t=>parseFloat(t)).filter(t=>!isNaN(t)),s=i.length>0&&i.length===n.filter(t=>void 0!==t).length;a.set(t,s?"continuous":"categorical");let r=0;for(const a of n)a&&e.has(a)&&r++;r>0&&o.push({col:t,matchCount:r})}),o=o.sort((t,e)=>e.matchCount-t.matchCount),s=o.map(t=>t.col)}return{metadataMap:i,columnTypes:a,idColumns:s}}(t,this.getTreeNodeNames(),n);const s="table_"+this.#t++;e||(e=`Metadata ${this.#t}`),this.metadataTableNames.set(s,e);const r=new Map;for(const[c,u]of a){const t=`${s}_${c}`;r.set(c,t),this.columnType.set(t,u),this.columnName.set(t,c),this.columnDisplayName.set(t,ei(c))}o=o.map(t=>r.get(t));let l=null;o.length>0?l=o[0]:console.warn(`No valid node ID column found in table ${e}`);const h=[];for(const c of i.values()){const t={};for(const[e,n]of Object.entries(c)){const i=r.get(e);i&&(t[i]=n)}h.push(t)}return this.validIdColumns.set(s,o),this.nodeIdColumn.set(s,l),this.metadata.set(s,h),this.#e(s),this.notify("metadataAdded",{tableId:s,columnIds:Array.from(r.values())}),s}getValidIdColumns(t){return this.validIdColumns.get(t)||[]}getNodeIdColumn(t){return this.nodeIdColumn.get(t)}getTableColumnIds(t){const e=this.metadata.get(t);return e&&0!==e.length?Object.keys(e[0]):[]}setNodeIdColumn(t,e){if(!this.metadata.get(t))return void console.warn(`Table ${t} does not exist`);if(!this.validIdColumns.get(t).includes(e))return void console.warn(`Column ${e} is not a valid ID column for table ${t}`);const n=this.nodeIdColumn.get(t);if(n===e)return;const i=this.getTableColumnIds(t);for(const a of i)this.columnAesthetic.delete(a);this.#i(t),this.nodeIdColumn.set(t,e),this.#e(t),this.notify("metadataChanged",{tableId:t,oldIdColumn:n,newIdColumn:e,columnIds:i,requiresAestheticRefresh:!0})}deleteTable(t){const e=this.metadata.get(t);if(!e)return void console.warn(`Table ${t} does not exist`);const n=e.length>0?Object.keys(e[0]):[];for(const i of n)this.columnType.delete(i),this.columnName.delete(i),this.columnDisplayName.delete(i),this.columnAesthetic.delete(i);this.#i(t),this.metadata.delete(t),this.metadataTableNames.delete(t),this.nodeIdColumn.delete(t),this.validIdColumns.delete(t),this.notify("metadataChanged",{tableId:t,columnIds:n})}getAesthetic(t,e,n={}){this.columnAesthetic.has(t)||this.columnAesthetic.set(t,new Map);const i=this.columnAesthetic.get(t);if(i.has(e))return i.get(e);const a=this.#a(t,n);return i.set(e,a),a}setAesthetic(t,e,n){this.columnAesthetic.has(t)||this.columnAesthetic.set(t,new Map),this.columnAesthetic.get(t).set(e,n)}#a(t,e={}){const n=this.columnType.get(t),i="categorical"===n;n||console.error(`Column ${t} not found`);let a=[];this.tree.each(n=>{"tips"==e.subset&&n.children||(n.metadata?a.push(n.metadata[t]):a.push(void 0))}),0===a.length&&console.error(`No values found for column ${t}`);const o=this.columnDisplayName.get(t)||t;return new Pi(a,{isCategorical:i,inputUnits:o,...e})}#e(t){const e=this.#n(t);this.tree.each(t=>{const n=t.data.name;if(n&&e.has(n)){const i=e.get(n);t.metadata={...t.metadata,...i}}})}#i(t){const e=this.metadata.get(t);if(!e||0===e.length)return;const n=Object.keys(e[0]);this.tree.each(t=>{t.metadata&&n.forEach(e=>{delete t.metadata[e]})})}}function $i(t,e){const n=t.leaves().map((t,n)=>({radius:t.radius,angle:t.angle,cos:t.cos,sin:t.sin,width:(t.tipLabelBounds.width+e.nodeLabelOffset)*t.tipLabelSize,height:t.tipLabelBounds.height*t.tipLabelSize,labelScale:t.tipLabelSize}));let i=0,a=1/0,o=0,s=1/0;function r(t){t>i&&(i=t>a?a:t)}function l(t){t<s&&(s=t<o?o:t)}function h(t){t>o&&(o=t>s?s:t)}const c=Math.min(...n.map(t=>t.labelScale)),u=Math.max(...n.map(t=>t.radius)),d=Math.min(...n.map(t=>t.radius)),p=t.descendants().filter(t=>t.data.length>0&&t.children),f=p.length>0?Math.min(...p.map(t=>t.data.length)):1/0;function g(){const t=Math.min(...n.filter(t=>t.cos>0).map(t=>(e.viewWidth/2-t.width*t.cos*o)/(t.radius*t.cos))),s=Math.min(...n.filter(t=>t.cos<0).map(t=>(e.viewWidth/2-t.width*-t.cos*o)/(t.radius*-t.cos))),r=Math.min(...n.filter(t=>t.sin>0).map(t=>(e.viewHeight/2-t.width*t.sin*o)/(t.radius*t.sin))),l=Math.min(...n.filter(t=>t.sin<0).map(t=>(e.viewHeight/2-t.width*-t.sin*o)/(t.radius*-t.sin)));var h;(h=Math.min((t+s)/2,(l+r)/2))<a&&(a=h<i?i:h)}function m(){const t=Math.min(...n.filter(t=>t.cos>0).map(t=>(e.viewWidth/2-t.radius*t.cos*i)/(t.width*t.cos))),a=Math.min(...n.filter(t=>t.cos<0).map(t=>(e.viewWidth/2-t.radius*-t.cos*i)/(t.width*-t.cos))),o=Math.min(...n.filter(t=>t.sin>0).map(t=>(e.viewHeight/2-t.radius*t.sin*i)/(t.width*t.sin))),s=Math.min(...n.filter(t=>t.sin<0).map(t=>(e.viewHeight/2-t.radius*-t.sin*i)/(t.width*-t.sin)));l(Math.min((t+a)/2,(s+o)/2))}h(e.minFontPx/c),i!==a&&r(Math.max(...n.map(t=>t.width*o/(u/e.minBranchLenProp-t.radius)))),g(),m();const y=n.reduce((t,e)=>t+e.height,0);return y>0&&d>0&&(i!==a&&r(y*o/(2*d*Math.PI)),o!==s&&l(u*a*2*Math.PI/y)),o!==s&&m(),o!==s&&h(e.idealFontPx/c),i!==a&&g(),isFinite(f)&&f>0&&i!==a&&r(e.minBranchThicknessPx/f),o!==s&&m(),o!==s&&l(e.maxFontPx/c),{branchLenToPxFactor_min:i,branchLenToPxFactor_max:a,labelSizeToPxFactor_min:o,labelSizeToPxFactor_max:s}}class Ni{constructor(){this.metricsCache=new Map,this.setupHiddenEnvironment()}setupHiddenEnvironment(){this.hiddenContainer=document.createElement("div"),this.hiddenContainer.style.cssText="\n      position: absolute;\n      top: -9999px;\n      left: -9999px;\n      visibility: hidden;\n      width: 5000px;\n      height: 5000px;\n      overflow: hidden;\n    ",this.hiddenSVG=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.hiddenSVG.setAttribute("width","5000"),this.hiddenSVG.setAttribute("height","5000"),this.hiddenSVG.setAttribute("viewBox","0 0 5000 5000"),this.hiddenContainer.appendChild(this.hiddenSVG),document.body.appendChild(this.hiddenContainer),this.hiddenD3SVG=bt(this.hiddenSVG),this.textGroup=this.hiddenD3SVG.append("g").attr("id","text-measurement-group")}getRelativeTextSize(t,e={}){const n=`${t}-${JSON.stringify(e)}`;if(this.metricsCache.has(n))return this.metricsCache.get(n);const i=this.textGroup.append("text").attr("x",1e3).attr("y",2500).text(t);Object.keys(e).forEach(t=>{i.style(t,e[t])}),this.hiddenSVG.getBoundingClientRect();const a=i.node().getBBox(),o=window.getComputedStyle(i.node()),s=parseFloat(o.fontSize);i.remove();const r={width:a.width/s,height:a.height/s};return this.metricsCache.set(n,r),r}getTextSize(t,e,n={}){const i=this.getRelativeTextSize(t,n);return{width:i.width,height:i.height,widthPx:i.width*e,heightPx:i.height*e}}clearCache(){this.metricsCache.clear()}destroy(){this.hiddenContainer&&this.hiddenContainer.parentNode&&this.hiddenContainer.parentNode.removeChild(this.hiddenContainer),this.metricsCache.clear()}}class Ai extends ai{#o={tipLabelText:{title:"Tip label text",scaleType:"identity",default:"",nullValue:"",downstream:["updateTipLabelText","updateCoordinates"],hasLegend:!1,subset:"tips"},tipLabelColor:{title:"Tip label color",scaleType:"color",default:"#000000",nullValue:"#808080",otherCategory:"#555555",downstream:[],hasLegend:!0,subset:"tips"},tipLabelSize:{title:"Tip label size",scaleType:"size",default:1,nullValue:1,isCategorical:!1,outputRange:[.5,2],downstream:["updateCoordinates"],hasLegend:!0,subset:"tips"},tipLabelFont:{title:"Tip label font",scaleType:"identity",default:"sans-serif",nullValue:"sans-serif",downstream:["updateCoordinates"],hasLegend:!1,subset:"tips"},tipLabelStyle:{title:"Tip label font style",scaleType:"text",outputValues:["normal","bold","italic","bold italic"],default:"normal",nullValue:"normal",otherCategory:"italic",downstream:["updateCoordinates"],hasLegend:!1,subset:"tips"},nodeLabelText:{title:"Node label text",scaleType:"identity",default:"",nullValue:"",downstream:["updateNodeLabelText"],hasLegend:!1,subset:"all"},nodeLabelSize:{title:"Node label size",scaleType:"size",default:1,nullValue:1,isCategorical:!1,outputRange:[.5,2],downstream:["updateCoordinates"],hasLegend:!1,subset:"all"}};state={treeData:null,layout:"rectangular",aesthetics:Object.fromEntries(Object.keys(this.#o).map(t=>[t,void 0])),viewWidth:800,viewHeight:600,labelSpacing:.1,nodeLabelSizeScale:.67,nodeLabelOffset:.3,maxLabelWidthProportion:.03,branchThicknessProp:.15,minFontPx:12,idealFontPx:18,maxFontPx:32,minBranchThicknessPx:1,minBranchLenProp:.5,collapsedRootLineProp:.05,branchLengthScale:1,treeHeightScale:1};textSizeEstimator;displayedRoot;occupiedWidth;occupiedHeight;branchLenToPxFactor;labelSizeToPxFactor;aestheticsScales={};legends=[];constructor(t={},e=new Ni){super(),t.treeData&&t.treeData.tree?e?(t.aesthetics={...this.state.aesthetics,...t.aesthetics},this.state={...this.state,...t},this.textSizeEstimator=e,this.#s(),this.state.treeData.subscribe("treeUpdate",()=>{this.#s()}),this.state.treeData.subscribe("metadataChanged",t=>{if(t.columnIds&&Array.isArray(t.columnIds))if(t.requiresAestheticRefresh){const e={};for(const[n,i]of Object.entries(this.state.aesthetics))i&&t.columnIds.includes(i)&&(e[n]=i);Object.keys(e).length>0&&this.setAesthetics(e,!0)}else this.setAesthetics(Object.fromEntries(t.columnIds.map(t=>[t,void 0])))})):console.error("TreeState initialized without textSizeEstimator"):console.error("TreeState initialized without valid tree data")}#s(){this.displayedRoot=this.state.treeData.tree,this.updateLayout(),this.setAesthetics(this.state.aesthetics,!0)}setLayout(t,e=!1){["circular","rectangular"].includes(t)?(e||this.state.layout!==t)&&(this.state.layout=t,this.update(),this.notify("layoutChange",{layout:t})):console.warn(`Invalid layout type: ${t}`)}setBranchLengthScale(t){t<.01||t>100?console.warn(`Branch length scale out of range: ${t}`):(this.state.branchLengthScale=t,this.updateCoordinates(),this.notify("branchLengthScaleChange",{scale:t}))}setTreeHeightScale(t){t<.1||t>10?console.warn(`Tree height scale out of range: ${t}`):(this.state.treeHeightScale=t,this.updateCoordinates(),this.notify("treeHeightScaleChange",{scale:t}))}setAesthetics(t,e=!1){const n=new Set;let i=!1;for(const[a,o]of Object.entries(t)){const t=this.#o[a];if(t){if(e||o!==this.state.aesthetics[a]){this.state.aesthetics[a]=o,o?(this.aestheticsScales[a]=this.state.treeData.getAesthetic(o,a,t),this.aestheticsScales[a].subscribe("aestheticChange",()=>{this.#r(a,o),this.#l(),this.notify(`${a}Change`)})):this.aestheticsScales[a]=new si({default:t.default}),this.#r(a,o);for(const e of t.downstream)n.add(e);t.hasLegend&&(i=!0)}this.notify(`${a}Change`)}else console.warn(`Unknown aesthetic: ${a}`)}i&&this.#l();for(const a of n)this[a]()}#r(t,e){const n=this.#o[t];this.state.treeData.tree.each(i=>{e&&null!=e?i.metadata?i[t]=this.aestheticsScales[t].getValue(i.metadata[e]):i[t]=n.default:i[t]=this.aestheticsScales[t].getValue()})}#l(){this.legends=[];for(const[t,e]of Object.entries(this.state.aesthetics)){const n=this.#o[t];if(!n.hasLegend||!e)continue;const i=this.aestheticsScales[t];i&&this.legends.push({aestheticId:t,aesthetic:i,type:n.scaleType})}this.notify("legendsChange")}setTargetTreeDimensions(t,e){this.state.viewWidth=t,this.state.viewHeight=e,this.updateCoordinates()}collapseSubtree(t){t?t.children?(t.collapsedChildren=t.children,delete t.children,this.update()):console.warn("Tried to collapse node with no children"):console.warn("Tried to collapse non-existant node")}expandSubtree(t){t&&t.collapsedChildren&&(t.children=t.collapsedChildren,delete t.collapsedChildren,this.update())}rotateSubtree(t){if(!t)return void console.warn("Tried to rotate non-existent node");if(!t.children||t.children.length<2)return void console.warn("Tried to rotate node with fewer than 2 children");const e=t.children.shift();t.children.push(e),this.update()}hideSubtree(t){if(!t)return void console.warn("Tried to hide non-existent node");if(!t.parent)return void console.warn("Cannot hide the root node");t.hidden=!0;const e=t.parent;e.children&&(e.hiddenChildren=e.hiddenChildren||[],e.hiddenChildren.push(t),e.children=e.children.filter(e=>e!==t),0===e.children.length&&(delete e.children,this.hideSubtree(e))),this.update()}showSubtree(t){if(!t||!t.hidden)return;const e=t.parent;e&&e.hiddenChildren&&(e.hiddenChildren=e.hiddenChildren.filter(e=>e!==t),0===e.hiddenChildren.length&&delete e.hiddenChildren,e.children||(e.children=[]),e.children.push(t),e.children.sort((t,n)=>(e.data.children?e.data.children.indexOf(t.data):0)-(e.data.children?e.data.children.indexOf(n.data):0)),delete t.hidden,this.update())}showAllHidden(){const t=[];this.state.treeData.tree.each(e=>{e.hiddenChildren&&t.push(...e.hiddenChildren)});for(const e of t)this.showSubtree(e)}collapseRoot(t){t&&t!==this.displayedRoot&&(this.displayedRoot=t,this.displayedRoot.collapsedParent=this.displayedRoot.parent,delete this.displayedRoot.parent,this.update())}expandRoot(){if(!this.displayedRoot||!this.displayedRoot.collapsedParent)return;this.displayedRoot.parent=this.displayedRoot.collapsedParent,delete this.displayedRoot.collapsedParent;let t=this.displayedRoot;for(;t.parent&&!t.collapsedParent;)t=t.parent;this.displayedRoot=t,this.update()}updateTipLabelText(){this.state.treeData.tree.each(t=>{null===this.state.aesthetics.tipLabelText?t.tipLabelText="":!t.children&&!t.collapsedChildren||void 0!==this.state.aesthetics.tipLabelText&&t.tipLabelText?t.tipLabelText||(t.tipLabelText=t.data.name||""):t.tipLabelText=`Clade with ${t.leafCount} tips`})}updateNodeLabelText(){this.state.treeData.tree.each(t=>{t.children||t.collapsedChildren?t.nodeLabelText=t.data.name||"":t.nodeLabelText||(t.tipLabel=t.data.name||"")})}update(){this.updateLayout(),this.updateCoordinates()}updateLayout(){kn().separation((t,e)=>1)(this.displayedRoot),this.displayedRoot.each(t=>{t.parent?(t.branchLen=t.data.length?t.data.length:0,t.y=t.parent.y+t.branchLen):t.y=0}),this.displayedRoot.each(t=>{const e=t.x,n=t.y;t.x=n,t.y=e,t.angle=t.y*Math.PI*2+Math.PI,t.cos=Math.cos(t.angle),t.sin=Math.sin(t.angle),t.radius=t.x}),this.displayedRoot.eachAfter(t=>{t.x=t.x-this.displayedRoot.x,t.y=t.y-this.displayedRoot.y})}getCollapsedTriangleHeight(t){return t.tipLabelSizePx+1.1}getCollapsedTriangleOffset(t){return.52*this.getCollapsedTriangleHeight(t)}updateCoordinates(){let t;this.displayedRoot.each(t=>{t.tipLabelBounds=this.textSizeEstimator.getRelativeTextSize(t.tipLabelText,{"font-family":t.tipLabelFont,"font-style":t.tipLabelStyle}),t.nodeLabelBounds=this.textSizeEstimator.getRelativeTextSize(t.nodeLabelText,{"font-family":t.nodeLabelFont,"font-style":t.nodeLabelStyle})}),t="circular"===this.state.layout?$i(this.displayedRoot,this.state):function(t,e){const n=t.leaves().map(t=>({x:t.x,width:(t.tipLabelBounds.width+e.nodeLabelOffset)*t.tipLabelSize,height:t.tipLabelBounds.height*t.tipLabelSize,labelScale:t.tipLabelSize}));let i=0,a=1/0,o=0,s=1/0;function r(t){t<a&&(a=t<i?i:t)}function l(t){t>i&&(i=t>a?a:t)}function h(t){t<s&&(s=t<o?o:t)}function c(t){t>o&&(o=t>s?s:t)}const u=Math.min(...n.map(t=>t.labelScale)),d=Math.max(...n.map(t=>t.x)),p=t.descendants().filter(t=>t.data.length>0&&t.children),f=p.length>0?Math.min(...p.map(t=>t.data.length)):1/0;return c(e.minFontPx/u),l(Math.max(...n.map(t=>t.width*o/(d/e.minBranchLenProp-t.x)))),r(Math.min(...n.map(t=>(e.viewWidth-t.width*o)/t.x))),h(Math.min(...n.map(t=>(e.viewWidth-t.x*i)/t.width))),o!=s&&h(e.viewHeight/n.reduce((t,e)=>t+e.height,0)),o!=s&&c(e.idealFontPx/u),i!=a&&r(Math.min(...n.map(t=>(e.viewWidth-t.width*o)/t.x))),isFinite(f)&&(i!=a&&l(e.minBranchThicknessPx/f),o!=s&&h(Math.min(...n.map(t=>(e.viewWidth-t.x*i)/t.width)))),o!=s&&h(e.maxFontPx/u),{branchLenToPxFactor_min:i,branchLenToPxFactor_max:a,labelSizeToPxFactor_min:o,labelSizeToPxFactor_max:s}}(this.displayedRoot,this.state),this.branchLenToPxFactor=t.branchLenToPxFactor_max*this.state.branchLengthScale,this.labelSizeToPxFactor=t.labelSizeToPxFactor_min,this.displayedRoot.each(t=>{t.branchLenPx=t.branchLen*this.branchLenToPxFactor,t.tipLabelSizePx=t.tipLabelSize*this.labelSizeToPxFactor,t.nodeLabelSizePx=t.nodeLabelSize*this.labelSizeToPxFactor*this.state.nodeLabelSizeScale;let e=t.tipLabelSizePx*this.state.nodeLabelOffset;t.collapsedChildren&&(e+=1.3*this.getCollapsedTriangleOffset(t)),t.tipLabelXOffsetPx=e,t.nodeLabelXOffsetPx=t.nodeLabelSizePx*this.state.nodeLabelOffset,t.tipLabelYOffsetPx=t.tipLabelSizePx*t.tipLabelBounds.height/2,t.nodeLabelYOffsetPx=t.nodeLabelSizePx*t.nodeLabelBounds.height/2,t.tipLabelBounds.widthPx=t.tipLabelBounds.width*t.tipLabelSizePx,t.tipLabelBounds.heightPx=t.tipLabelBounds.height*t.tipLabelSizePx}),"circular"===this.state.layout?this.displayedRoot.each(t=>{t.radiusPx=t.radius*this.branchLenToPxFactor,t.xPx=t.radiusPx*t.cos,t.yPx=t.radiusPx*t.sin}):this.displayedRoot.each(t=>{t.xPx=t.x*this.branchLenToPxFactor,t.yPx=t.y*this.displayedRoot.leaves().length*this.labelSizeToPxFactor*(1+this.state.labelSpacing)*this.state.treeHeightScale}),"circular"===this.state.layout?this.state.treeData.tree.eachAfter(t=>{if(t.children)t.bounds={minRadius:t.radiusPx,maxRadius:Math.max(...t.children.map(t=>t.bounds.maxRadius)),minAngle:Math.min(...t.children.map(t=>t.bounds.minAngle)),maxAngle:Math.max(...t.children.map(t=>t.bounds.maxAngle)),minX:Math.min(...t.children.map(t=>t.bounds.minX)),maxX:Math.max(...t.children.map(t=>t.bounds.maxX)),minY:Math.min(...t.children.map(t=>t.bounds.minY)),maxY:Math.max(...t.children.map(t=>t.bounds.maxY))};else{const e=t.radiusPx,n=e+t.tipLabelXOffsetPx+t.tipLabelBounds.widthPx,i=Math.atan(t.tipLabelYOffsetPx/t.radiusPx),a=t.angle-i,o=t.angle+i,s=[e*Math.cos(a),e*Math.cos(o),n*Math.cos(o),n*Math.cos(a)],r=[e*Math.sin(a),e*Math.sin(o),n*Math.sin(o),n*Math.sin(a)];t.bounds={minRadius:e,maxRadius:n,minAngle:a,maxAngle:o,minX:Math.min(...s),maxX:Math.max(...s),minY:Math.min(...r),maxY:Math.max(...r)}}}):this.state.treeData.tree.eachAfter(t=>{t.children?t.bounds={minX:t.xPx,maxX:Math.max(...t.children.map(t=>t.bounds.maxX)),minY:Math.min(...t.children.map(t=>t.bounds.minY)),maxY:Math.max(...t.children.map(t=>t.bounds.maxY))}:t.bounds={minX:t.xPx,maxX:t.xPx+t.tipLabelXOffsetPx+t.tipLabelBounds.widthPx,minY:t.yPx-t.tipLabelYOffsetPx,maxY:t.yPx+t.tipLabelYOffsetPx}}),this.notify("coordinateChange")}}const Ri={refresh:["m 16,7 h 5 V 2","M 22,12 A 10,10 0 0 1 13.58,21.9 10,10 0 0 1 2.5,15.2 10,10 0 0 1 7.4,3.14 10,10 0 0 1 20,6"],outwardArrows:["m 9,19 3,3 3,-3","M 12,22 V 15","m 9,5 3,-3 3,3","M 12,2 V 9","m 5,9 -3,3 3,3","M 2,12 H 9","M 19,15 22,12 19,9","M 22,12 H 15"],compress:["M 5,12 H 19","m 9,18 3,-3 3,3","m 12,15 v 7","m 9,6 3,3 3,-3","M 12,9 V 2"],expand:["M 5,2 H 19","M 5,22 H 19","m 9,8 3,-3 3,3","m 9,16 3,3 3,-3","M 12,5 V 19"],circle:["M 12,2 A 10,10 0 1 1 12,22 A 10,10 0 1 1 12,2"],trash:["M 3,6 H 21","M 19,6 V 20 A 2,2 0 0 1 17,22 H 7 A 2,2 0 0 1 5,20 V 6","M 8,6 V 4 A 2,2 0 0 1 10,2 H 14 A 2,2 0 0 1 16,4 V 6","M 10,11 V 17","M 14,11 V 17"],rotate:["M 3,12 H 8","M 13,6 H 8 v 12 h 5","m 17,4 c 0,0 9,8 0,16","M 17,8 V 4 h 4","M 21,20 H 17 V 16"],edit:["m 12,8 -8,8 -1,5 5,-1 8,-8 z","M 21,7 18,10 14,6 17,3 Z"]};class Hi{constructor(t={}){this.state={aesthetic:null,x:0,y:0,origin:"top left",maxX:1/0,maxY:1/0,titleFontSize:16,labelFontSize:14,...t},this.coordinates={},this.group=null,this.textSizeEstimator=this.state.treeState.textSizeEstimator}render(t){this.group=t.append("g").attr("class","ht-legend"),this.updateCoordinates(),this.updatePosition()}updateCoordinates(){throw new Error("updateCoordinates must be implemented by subclass")}updatePosition(){if(!this.group)return;let t=this.state.x,e=this.state.y;const{width:n,height:i}=this.coordinates;this.state.origin.includes("right")&&(t-=n),this.state.origin.includes("bottom")&&(e-=i),this.group.attr("transform",`translate(${t}, ${e})`)}renderTitle(t){return this.group.append("text").attr("class","legend-title").attr("x",0).attr("y",0).attr("text-anchor","start").style("font-size",`${this.state.titleFontSize}px`).style("text-decoration","underline").text(t)}}class Bi extends Hi{constructor(t={}){super(t),this.scaleBarEdgeHeight=6,this.titleSpacing=10,this.unitLabelSpacing=2,this.minBarLength=80,this.maxBarLength=160,this.lineThickness=2,this.showTitle=!1,this.title="Branch length"}updateCoordinates(){let t=Jn(1),e=t*this.state.treeState.branchLenToPxFactor;for((e<this.minBarLength||e>this.maxBarLength)&&(t=Jn(this.minBarLength/this.state.treeState.branchLenToPxFactor),e=t*this.state.treeState.branchLenToPxFactor);e<this.minBarLength;)t*=2,e=t*this.state.treeState.branchLenToPxFactor;for(;e>this.maxBarLength;)t/=2,e=t*this.state.treeState.branchLenToPxFactor;t=t.toPrecision(3);const n=this.textSizeEstimator.getTextSize(t,this.state.labelFontSize);this.textSizeEstimator.getTextSize(this.title,this.state.titleFontSize);let i=0;this.showTitle&&(i=this.state.titleFontSize+this.titleSpacing);const a=i+this.unitLabelSpacing+n.heightPx+10;this.coordinates={width:e+this.lineThickness,height:a+this.scaleBarEdgeHeight,title:{x:0,y:this.state.titleFontSize,text:"Branch Length"},bar:{x1:0,y1:a,x2:e,y2:a},leftTick:{x1:0,y1:a-this.scaleBarEdgeHeight,x2:0,y2:a+this.scaleBarEdgeHeight},rightTick:{x1:e,y1:a-this.scaleBarEdgeHeight,x2:e,y2:a+this.scaleBarEdgeHeight},label:{x:e/2,y:a-this.unitLabelSpacing,text:t}}}render(t){super.render(t),this.showTitle&&this.renderTitle(this.coordinates.title.text).attr("x",this.coordinates.title.x).attr("y",this.coordinates.title.y),this.group.append("line").attr("class","bar").attr("x1",this.coordinates.bar.x1).attr("y1",this.coordinates.bar.y1).attr("x2",this.coordinates.bar.x2).attr("y2",this.coordinates.bar.y2).attr("stroke","#000").attr("stroke-width",this.lineThickness),this.group.append("line").attr("class","left-tick").attr("x1",this.coordinates.leftTick.x1).attr("y1",this.coordinates.leftTick.y1).attr("x2",this.coordinates.leftTick.x2).attr("y2",this.coordinates.leftTick.y2).attr("stroke","#000").attr("stroke-width",this.lineThickness),this.group.append("line").attr("class","right-tick").attr("x1",this.coordinates.rightTick.x1).attr("y1",this.coordinates.rightTick.y1).attr("x2",this.coordinates.rightTick.x2).attr("y2",this.coordinates.rightTick.y2).attr("stroke","#000").attr("stroke-width",this.lineThickness),this.group.append("text").attr("class","label").attr("x",this.coordinates.label.x).attr("y",this.coordinates.label.y).attr("text-anchor","middle").attr("dominant-baseline","ideographic").style("font-size",`${this.state.labelFontSize}px`).text(this.coordinates.label.text)}}class Di extends Hi{constructor(t={}){super(t),this.padding=10,this.exampleLetter="A",this.tickHeight=5,this.verticalSpacing=5,this.showTitle=!0}updateCoordinates(){const t=this.state.aesthetic.scale.dataMin,e=this.state.aesthetic.scale.dataMax,n=this.state.aesthetic.state.outputRange[0],i=this.state.aesthetic.state.outputRange[1],a=ni(t,e,5),o=i*this.state.treeState.labelSizeToPxFactor*.7,s=n*this.state.treeState.labelSizeToPxFactor*.7;this.textSizeEstimator.getTextSize(this.state.aesthetic.state.title,this.state.titleFontSize);const r=Math.max(30*a.length,100),l=a.map(t=>{const e=ii(t,a);return this.textSizeEstimator.getTextSize(e,this.state.labelFontSize)}),h=l[0].widthPx/2,c=l[l.length-1].widthPx/2,u=r+h+c;let d=0;this.showTitle&&(d=this.state.titleFontSize+this.verticalSpacing);const p=d+o,f=this.textSizeEstimator.getTextSize(this.state.aesthetic.state.inputUnits||"",this.state.labelFontSize),g=p+this.tickHeight+this.state.labelFontSize+f.heightPx;if(this.coordinates={width:u,height:g,leftOverhang:h,title:{x:h,y:this.state.titleFontSize,text:this.state.aesthetic.state.title},polygon:[],ticks:[],labels:[],units:{x:u/2,y:g,text:this.state.aesthetic.state.inputUnits||""}},t===e){const e=h+r/2;this.coordinates.ticks.push({x1:e,y1:p,x2:e,y2:p+this.tickHeight}),this.coordinates.labels.push({x:e,y:p+this.tickHeight,text:ii(t,a)});const n=(s+o)/2;this.coordinates.polygon=[{x:h,y:p},{x:h,y:p-n},{x:h+r,y:p-n},{x:h+r,y:p}]}else a.forEach((t,e)=>{const n=h+e/(a.length-1)*r;this.coordinates.ticks.push({x1:n,y1:p,x2:n,y2:p+this.tickHeight}),this.coordinates.labels.push({x:n,y:p+this.tickHeight,text:ii(t,a)})}),this.coordinates.polygon=[{x:h,y:p},{x:h,y:p-s},{x:h+r,y:p-o},{x:h+r,y:p}]}render(t){super.render(t),this.showTitle&&this.renderTitle(this.coordinates.title.text).attr("x",this.coordinates.title.x).attr("y",this.coordinates.title.y);const e=this.coordinates.polygon.map(t=>`${t.x},${t.y}`).join(" ");this.group.append("polygon").attr("points",e).attr("fill","#f0f0f0").attr("stroke","#ccc").attr("stroke-width",1),this.coordinates.ticks.forEach(t=>{this.group.append("line").attr("x1",t.x1).attr("y1",t.y1).attr("x2",t.x2).attr("y2",t.y2).attr("stroke","#000").attr("stroke-width",1)}),this.coordinates.labels.forEach(t=>{this.group.append("text").attr("x",t.x).attr("y",t.y).attr("text-anchor","middle").attr("dominant-baseline","hanging").style("font-size",`${this.state.labelFontSize}px`).text(t.text)}),this.coordinates.units.text&&this.group.append("text").attr("x",this.coordinates.units.x).attr("y",this.coordinates.units.y).attr("text-anchor","middle").attr("dominant-baseline","ideographic").style("font-size",`${this.state.labelFontSize}px`).style("font-style","italic").text(this.coordinates.units.text)}}class Fi extends Hi{constructor(t={}){super(t),this.exampleLetter="A",this.verticalSpacing=5,this.horizontalSpacing=10,this.showTitle=!0,this.squareSize=12,this.itemLabelGap=5,this.itemGap=15,this.maxCategoriesPerRow=5,this.gradientHeight=20,this.tickHeight=5,this.numGradientStops=20}updateCoordinates(){const t=this.state.aesthetic,e=t.state.isCategorical,n=this.textSizeEstimator.getTextSize(t.state.title,this.state.titleFontSize);let i=0;this.showTitle&&(i=this.state.titleFontSize+this.verticalSpacing),e?this.#h(i,n):this.#c(i,n)}#h(t,e){const n=this.state.aesthetic,i=n.scale.categories,a=this.state.maxX-this.state.x;this.coordinates={width:0,height:t,title:{x:0,y:this.state.titleFontSize,text:n.state.title},items:[],isCategorical:!0};let o=0,s=t+this.verticalSpacing+this.squareSize/2,r=this.squareSize;i.slice(0,n.state.maxCategories).forEach((t,e)=>{const l=n.scale.getValue(t),h=""===t?"No data":t,c=this.textSizeEstimator.getTextSize(h,this.state.labelFontSize),u=this.squareSize+this.itemLabelGap+c.widthPx;o>0&&o+u>a&&(o=0,s+=r+this.verticalSpacing,r=this.squareSize),this.coordinates.items.push({x:o,y:s,color:l,label:e<n.state.maxCategories-1||e==i.length-1?h:n.state.otherLabel,squareX:o,squareY:s-this.squareSize/2,labelX:o+this.squareSize+this.itemLabelGap,labelY:s}),o+=u+this.itemGap,this.coordinates.width=Math.max(this.coordinates.width,o-this.itemGap)});const l=n.values.some(t=>null==t);if(n.state.showNullInLegend&&l){const t=n.state.nullValue,e="No Data",i=this.textSizeEstimator.getTextSize(e,this.state.labelFontSize),l=this.squareSize+this.itemLabelGap+i.widthPx;o>0&&o+l>a&&(o=0,s+=r+this.verticalSpacing,r=this.squareSize),this.coordinates.items.push({x:o,y:s,color:t,label:e,squareX:o,squareY:s-this.squareSize/2,labelX:o+this.squareSize+this.itemLabelGap,labelY:s}),o+=l+this.itemGap,this.coordinates.width=Math.max(this.coordinates.width,o-this.itemGap)}this.coordinates.height=s+this.squareSize/2}#c(t,e){const n=this.state.aesthetic,i=n.scale.dataMin,a=n.scale.dataMax,o=ni(i,a,5),s=Math.max(30*o.length,120),r=o.map(t=>{const e=ii(t,o);return this.textSizeEstimator.getTextSize(e,this.state.labelFontSize)}),l=r[0].widthPx/2,h=r[r.length-1].widthPx/2,c=s+l+h,u=t+this.verticalSpacing,d=u+this.gradientHeight,p=d+this.tickHeight,f=this.textSizeEstimator.getTextSize(n.state.inputUnits||"",this.state.labelFontSize);let g=p+this.state.labelFontSize+f.heightPx;if(this.coordinates={width:c,height:g,leftOverhang:l,isCategorical:!1,title:{x:l,y:this.state.titleFontSize,text:n.state.title},gradient:{x:l,y:u,width:s,height:this.gradientHeight},ticks:[],labels:[],units:{x:c/2,y:g,text:n.state.inputUnits||""},nullItem:null},i===a){const t=l+s/2;this.coordinates.ticks.push({x1:t,y1:d,x2:t,y2:d+this.tickHeight}),this.coordinates.labels.push({x:t,y:p,text:ii(i,o)})}else o.forEach((t,e)=>{const n=l+e/(o.length-1)*s;this.coordinates.ticks.push({x1:n,y1:d,x2:n,y2:d+this.tickHeight}),this.coordinates.labels.push({x:n,y:p,text:ii(t,o)})});if(n.state.showNullInLegend){const t=n.state.nullValue,e="No Data";this.textSizeEstimator.getTextSize(e,this.state.labelFontSize);const i=g+this.verticalSpacing;this.coordinates.nullItem={x:l,y:i+this.squareSize/2,color:t,label:e,squareX:l,squareY:i,labelX:l+this.squareSize+this.itemLabelGap,labelY:i+this.squareSize/2},this.coordinates.height=i+this.squareSize}}render(t){super.render(t),this.showTitle&&this.renderTitle(this.coordinates.title.text).attr("x",this.coordinates.title.x).attr("y",this.coordinates.title.y),this.coordinates.isCategorical?this.#u():this.#d()}#u(){this.coordinates.items.forEach(t=>{this.group.append("rect").attr("x",t.squareX).attr("y",t.squareY).attr("width",this.squareSize).attr("height",this.squareSize).attr("fill",t.color).attr("stroke","#000").attr("stroke-width",1),this.group.append("text").attr("x",t.labelX).attr("y",t.labelY).attr("text-anchor","start").attr("dominant-baseline","central").style("font-size",`${this.state.labelFontSize}px`).text(t.label)})}#d(){const t=this.state.aesthetic,e=t.scale.dataMin,n=t.scale.dataMax,i=`color-gradient-${Math.random().toString(36).substr(2,9)}`,a=this.group.append("defs").append("linearGradient").attr("id",i).attr("x1","0%").attr("x2","100%").attr("y1","0%").attr("y2","0%");if(e===n){const n=t.scale.getValue(e);a.append("stop").attr("offset","0%").attr("stop-color",n),a.append("stop").attr("offset","100%").attr("stop-color",n)}else for(let o=0;o<=this.numGradientStops;o++){const i=o/this.numGradientStops,s=e+i*(n-e),r=t.scale.getValue(s);a.append("stop").attr("offset",100*i+"%").attr("stop-color",r)}this.group.append("rect").attr("x",this.coordinates.gradient.x).attr("y",this.coordinates.gradient.y).attr("width",this.coordinates.gradient.width).attr("height",this.coordinates.gradient.height).style("fill",`url(#${i})`).style("stroke","#000").style("stroke-width",1),this.coordinates.ticks.forEach(t=>{this.group.append("line").attr("x1",t.x1).attr("y1",t.y1).attr("x2",t.x2).attr("y2",t.y2).attr("stroke","#000").attr("stroke-width",1)}),this.coordinates.labels.forEach(t=>{this.group.append("text").attr("x",t.x).attr("y",t.y).attr("text-anchor","middle").attr("dominant-baseline","hanging").style("font-size",`${this.state.labelFontSize}px`).text(t.text)}),this.coordinates.units.text&&this.group.append("text").attr("x",this.coordinates.units.x).attr("y",this.coordinates.units.y).attr("text-anchor","middle").attr("dominant-baseline","ideographic").style("font-size",`${this.state.labelFontSize}px`).style("font-style","italic").text(this.coordinates.units.text)}}class Ii{constructor(t,e,n={}){if(!t)throw new Error("TreeView requires a TreeState instance");if(!e)throw new Error("TreeView requires an SVG container element");this.treeState=t,this.svg=bt(e),this.options={buttonSize:25,controlsMargin:3,buttonPadding:2,manualZoomAndPanEnabled:!0,autoZoom:"Default",autoPan:"Default",transitionDuration:500,legendSpacing:10,legendPadding:10,...n},this.layers={},this.selections={},this.legendInstances=[],this.currentTransform={x:0,y:0,k:1},this.isTransitioning=!1,this.isExpanding=!1,this.activeTransitions=new Set,this.selectedNode=null,this.selectionButtons=[{id:"collapse-subtree",icon:"compress",isVisible:t=>t&&t!==this.treeState.displayedRoot&&(t.children||t.collapsedChildren),onClick:t=>{t&&t!==this.treeState.displayedRoot&&t.children&&(this.treeState.collapseSubtree(t),this.#p())}},{id:"collapse-root",icon:"expand",isVisible:t=>t&&t!==this.treeState.displayedRoot&&(t.children||t.collapsedChildren),onClick:t=>{t&&t!==this.treeState.displayedRoot&&t.children&&(this.treeState.collapseRoot(t),this.#p())}},{id:"hide",icon:"trash",isVisible:t=>t&&t!==this.treeState.displayedRoot,onClick:t=>{t&&t!==this.treeState.displayedRoot&&(this.treeState.hideSubtree(t),this.#p())}},{id:"rotate-subtree",icon:"rotate",isVisible:t=>{if(!t||!t.children)return!1;return t.children.filter(t=>!t.hidden).length>1},onClick:t=>{if(t&&t.children){t.children.filter(t=>!t.hidden).length>1&&this.treeState.rotateSubtree(t)}}}],this.#f(),this.initializeZoom(),this.#g(),this.#m()}destroy(){this.svg.selectAll("*").remove(),this.layers={},this.selections={},this.selectedNode=null,this.legendInstances=[]}reattach(t){this.svg=bt(t),this.#f(),this.initializeZoom(),this.#y(!1),this.#b(!1),this.#x(!1),this.#l(!1),this.fitToView({transition:!1,forcePanToTop:!0})}#f(){const t=this.svg.append("g").attr("class","tree-elements");this.layers.branchLayer=t.append("g").attr("class","branch-layer"),this.layers.nodeLayer=t.append("g").attr("class","node-layer"),this.layers.hitLayer=t.append("g").attr("class","hit-layer"),this.layers.legendLayer=t.append("g").attr("class","legend-layer"),this.layers.treeGroup=t,this.layers.selectionRect=t.append("path").attr("class","selection-rect").attr("fill","none").attr("stroke","grey").attr("stroke-width",2).attr("stroke-dasharray","5,5").attr("pointer-events","none").style("display","none"),this.layers.selectionBtns=this.svg.append("g").attr("class","selection-btns").style("display","none"),this.#v()}#p(){this.selectedNode=null,this.layers.selectionRect.style("display","none"),this.layers.selectionBtns.style("display","none")}#v(){const t=this.layers.selectionBtns;this.selectionButtons.forEach(e=>{const n=t.append("g").attr("class",`btn-${e.id}`).style("cursor","pointer").on("click",()=>{e.onClick(this.selectedNode)});!function(t,e,n,i=2){const a=Ri[e],o=(n-2*i)/24,s=t.append("rect").attr("width",n).attr("height",n).attr("rx","5px").attr("ry","5px").attr("fill","#CCC"),r=t.append("g").attr("transform",`translate(${i}, ${i}) scale(${o})`).attr("stroke","#555").attr("fill","none").attr("stroke-linecap","round").attr("stroke-linejoin","round").attr("stroke-width",2);a.forEach(t=>{r.append("path").attr("d",t)})}(n,e.icon,this.options.buttonSize),e.element=n})}initializeZoom(){this.treeZoom=Qn().filter(t=>!!this.options.manualZoomAndPanEnabled&&"dblclick"!==t.type).on("zoom",t=>{this.currentTransform=t.transform,this.layers.treeGroup.attr("transform",t.transform),this.#w(null===t.sourceEvent)}),this.svg.call(this.treeZoom)}#g(){this.treeState.subscribe("coordinateChange",()=>{this.#_()}),this.treeState.subscribe("layoutChange",()=>{this.#_()}),this.treeState.subscribe("legendsChange",()=>{this.#l(!0)}),this.treeState.subscribe("tipLabelTextChange",()=>{this.#C()}),this.treeState.subscribe("tipLabelColorChange",()=>{this.#k()}),this.treeState.subscribe("tipLabelSizeChange",()=>{this.#S(),this.#l(!0)}),this.treeState.subscribe("tipLabelFontChange",()=>{this.#L()}),this.treeState.subscribe("tipLabelStyleChange",()=>{this.#P()}),this.treeState.subscribe("nodeLabelTextChange",()=>{this.#M()})}#m(){this.#y(!1),this.#b(!1),this.#x(!1),this.#l(!1),this.fitToView({transition:!1,forcePanToTop:!0})}#_(){const t=this.#y(!0),e=this.#b(!0);this.#x(!0),this.#l(!0),this.selectedNode&&this.#T(!0),this.isExpanding&&t&&e?setTimeout(()=>{t.transition("branch group fade in").duration(150).attr("opacity",1),e.transition("node group fade in").duration(150).attr("opacity",1),this.layers.selectionBtns.attr("opacity",0).transition("fade in selection buttons").duration(150).attr("opacity",1),setTimeout(()=>{this.isExpanding=!1},150)},this.options.transitionDuration):this.selectedNode&&setTimeout(()=>{this.#w(!1)},this.options.transitionDuration),this.fitToView()}#C(){this.selections.nodes&&this.selections.nodes.selectAll(".tip-label").text(t=>t.tipLabelText||"")}#k(){this.selections.nodes&&this.selections.nodes.selectAll(".tip-label").style("fill",t=>t.tipLabelColor||"#000")}#S(){this.selections.nodes&&this.selections.nodes.selectAll(".tip-label").style("font-size",t=>`${t.tipLabelSizePx||12}px`)}#L(){this.selections.nodes&&this.selections.nodes.selectAll(".tip-label").style("font-family",t=>t.tipLabelFont||"sans-serif")}#P(){this.selections.nodes&&this.selections.nodes.selectAll(".tip-label").style("font-style",t=>t.tipLabelStyle.includes("italic")?"italic":"normal").style("font-weight",t=>t.tipLabelStyle.includes("bold")?"bold":"normal")}#M(){this.selections.nodes&&this.selections.nodes.selectAll(".node-label").text(t=>t.nodeLabelText||"")}#l(t=!0){this.layers.legendLayer.selectAll("*").remove(),this.legendInstances=[];const e=this.#E();if(!e)return;e.maxX,e.minX;let n=e.minX,i=e.maxY+this.options.legendSpacing;const a=new Bi({treeState:this.treeState,x:n,y:i,origin:"top left",maxX:e.maxX,maxY:1/0});a.render(this.layers.legendLayer),this.legendInstances.push(a),n+=a.coordinates.width+this.options.legendSpacing;for(const o of this.treeState.legends){let t;"size"===o.type?t=new Di({treeState:this.treeState,aesthetic:o.aesthetic,x:n,y:i,origin:"top left",maxX:e.maxX,maxY:1/0}):"color"===o.type&&(t=new Fi({treeState:this.treeState,aesthetic:o.aesthetic,x:n,y:i,origin:"top left",maxX:e.maxX,maxY:1/0})),n+t.coordinates.width+this.options.legendSpacing>e.maxX&&(n=e.minX,i+=Math.max(...this.legendInstances.map(t=>t.coordinates.height))),t&&(t.render(this.layers.legendLayer),this.legendInstances.push(t),n+=t.coordinates.width+this.options.legendSpacing)}this.fitToView({transition:t})}fitToView(t){if(!((t={transition:!0,padding:5,autoZoom:this.options.autoZoom,autoPan:this.options.autoPan,forcePanToTop:!1,...t}).autoZoom&&"None"!=t.autoZoom||t.autoPan&&"None"!=t.autoPan))return;const{width:e,height:n}=this.svg.node().getBoundingClientRect(),i=this.getCurrentBoundsWithLegends();if(!i)return;i.minX-=t.padding,i.maxX+=t.padding,i.minY-=t.padding,i.maxY+=t.padding;const a=i.maxX-i.minX,o=i.maxY-i.minY,s=e-0,r=n;let l=this.currentTransform.k,h=this.currentTransform.x,c=this.currentTransform.y;const u=s/a,d=r/o;if("Default"==t.autoZoom&&("circular"!=this.treeState.state.layout&&this.options.manualZoomAndPanEnabled?t.autoZoom="X":t.autoZoom="Both"),t.autoZoom&&"None"!=t.autoZoom&&("X"==t.autoZoom?l=Math.min(1,u):"Y"==t.autoZoom?l=Math.min(1,d):"Both"==t.autoZoom?l=Math.min(u,d):console.error(`Value of ${t.autoZoom} is invalid for input.autoZoom.`)),"Default"==t.autoPan&&(t.autoPan="Both"),t.autoPan&&"None"!=t.autoPan){if("Both"==t.autoPan||"X"==t.autoPan){const t=a*l;if(t<=s)h=0+(s-t)/2-i.minX*l;else{const t=-i.minX*l-0,n=e-i.maxX*l;h=t>0?0-i.minX*l:n>0?e-i.maxX*l:0+s/2-(i.minX+i.maxX)/2*l}}if("Both"==t.autoPan||"Y"==t.autoPan){const e=o*l;if(e<=r)c=(r-e)/2-i.minY*l;else{const e=-i.minY*l,a=n-i.maxY*l;c>e||t.forcePanToTop?c=e:c<a&&(c=a)}}}const p=Xn.translate(h,c).scale(l);t.transition?this.svg.transition("zoom").duration(this.options.transitionDuration).call(this.treeZoom.transform,p):this.svg.call(this.treeZoom.transform,p)}#E(){const t=this.treeState.displayedRoot;return{minX:t.bounds.minX,maxX:t.bounds.maxX,minY:t.bounds.minY,maxY:t.bounds.maxY}}getCurrentBoundsWithLegends(){const t=this.#E();if(!t)return null;let e=t.maxY,n=t.minX;for(const i of this.legendInstances)i.coordinates&&(e=Math.max(e,i.state.y+i.coordinates.height));return"circular"!==this.treeState.state.layout&&this.treeState.displayedRoot.collapsedParent&&(n-=this.#z()),{minX:n,maxX:t.maxX,minY:t.minY,maxY:e}}#$(t){this.selectedNode===t?this.#p():(this.selectedNode=t,this.layers.selectionRect.attr("d",this.#N(t)).style("display","block"),this.#w(!1))}#T(t=!1){this.selectedNode&&(t?this.layers.selectionRect.transition("update selection rect").duration(this.options.transitionDuration).attr("d",this.#N(this.selectedNode)):this.layers.selectionRect.attr("d",this.#N(this.selectedNode)))}#N(t){if(!t)return"";let e,n,i,a,o,s;if("circular"===this.treeState.state.layout)e={x:t.bounds.minRadius*Math.cos(t.bounds.minAngle),y:t.bounds.minRadius*Math.sin(t.bounds.minAngle)},i={x:t.bounds.maxRadius*Math.cos(t.bounds.maxAngle),y:t.bounds.maxRadius*Math.sin(t.bounds.maxAngle)},s=this.#A(i.x,i.y,t.bounds.maxRadius,t.bounds.maxAngle,t.bounds.minAngle,!1),o=this.#A(e.x,e.y,t.bounds.minRadius,t.bounds.minAngle,t.bounds.maxAngle,!0);else{e={x:t.bounds.minX,y:t.bounds.minY},n={x:t.bounds.minX,y:t.bounds.maxY},i={x:t.bounds.maxX,y:t.bounds.maxY},a={x:t.bounds.maxX,y:t.bounds.minY};const r=this.treeState.displayedRoot,l=r.bounds.maxY-r.bounds.minY,h=Math.abs(n.y-e.y)/l,c=Math.max(1,Math.ceil(h/.25));o=this.#R(e,n,c),s=this.#R(i,a,c)}return`M${e.x},${e.y} ${o} L${i.x},${i.y} ${s} Z`}#R(t,e,n=1){let i="";for(let a=0;a<n;a++){const o=a/n,s=(a+1)/n,r=t.x+(e.x-t.x)*o,l=t.y+(e.y-t.y)*o,h=t.x+(e.x-t.x)*s,c=t.y+(e.y-t.y)*s;i+=`C${r},${l+(c-l)/3} ${h},${c-(c-l)/3} ${h},${c}`,a<n-1&&(i+=" ")}return i}#w(t=!0,e=1.1){if(!this.selectedNode)return void this.layers.selectionBtns.style("display","none");let n,i;if("circular"===this.treeState.state.layout){const t=this.selectedNode.bounds.minAngle,e=this.selectedNode.bounds.maxAngle,a=this.selectedNode.bounds.minRadius,o=this.selectedNode.bounds.maxRadius,s=20;let r=1/0,l=0;for(let n=0;n<=s;n++){const i=t+(e-t)*n/s,h=a*Math.cos(i),c=a*Math.sin(i),u=o*Math.cos(i),d=o*Math.sin(i);h<r&&(r=h,l=c),u<r&&(r=u,l=d)}n=r,i=l}else n=this.selectedNode.bounds.minX,i=this.selectedNode.bounds.minY;let a=0;this.selectionButtons.forEach(t=>{if(t.isVisible(this.selectedNode)){const n=a*(this.options.buttonSize*e);t.element.style("display","block").attr("transform",`translate(0, ${n})`),a++}else t.element.style("display","none")});const o=a*this.options.buttonSize+(a-1)*this.options.buttonSize*(e-1);let s=n*this.currentTransform.k+this.currentTransform.x-this.options.buttonSize*e,r=i*this.currentTransform.k+this.currentTransform.y-this.options.buttonSize*(e-1);const{width:l,height:h}=this.svg.node().getBoundingClientRect();s=Math.max(s,0),s=Math.min(s,l-this.options.buttonSize),r=Math.max(r,0),r=Math.min(r,h-o),t?this.layers.selectionBtns.attr("opacity",0).attr("transform",`translate(${s},${r})`):this.layers.selectionBtns.attr("transform",`translate(${s},${r})`).attr("opacity",1).style("display","block")}#x(){const t=this.treeState.displayedRoot;if(!t)return;const e="circular"===this.treeState.state.layout,n=this.treeState.labelSizeToPxFactor*this.treeState.state.branchThicknessProp,i=this.#z(),a=this.layers.hitLayer.selectAll(".hit").data(t.descendants().filter(t=>{if(!t.children)return!1;return t.children.filter(t=>!t.hidden).length>1}),t=>t.id);a.exit().remove();a.enter().append("path").attr("class","hit").attr("fill","transparent").style("cursor","pointer").on("click",(t,e)=>{this.#$(e),t.stopPropagation()}).merge(a).attr("d",t=>this.#N(t)),this.layers.hitLayer.selectAll(".hit").sort((t,e)=>t.depth-e.depth);const o=this.layers.hitLayer.selectAll(".tip-hit").data(t.descendants().filter(t=>!t.children&&!t.collapsedChildren),t=>t.id);o.exit().remove();o.enter().append("path").attr("class","tip-hit").attr("fill","transparent").style("cursor","pointer").on("click",(t,e)=>{this.#$(e),t.stopPropagation()}).merge(o).attr("d",t=>this.#N(t));const s=this.layers.hitLayer.selectAll(".collapsed-hit").data(t.descendants().filter(t=>t.collapsedChildren),t=>t.id);s.exit().remove();s.enter().append("rect").attr("class","collapsed-hit").attr("fill","transparent").style("cursor","pointer").on("click",(t,e)=>{e.collapsedChildren&&(this.isExpanding=!0,this.treeState.expandSubtree(e)),t.stopPropagation()}).merge(s).attr("transform",t=>`translate(${t.xPx}, ${t.yPx}) rotate(${this.#H(t)})`).attr("y",t=>-t.tipLabelSizePx/2.5).attr("width",t=>this.treeState.getCollapsedTriangleHeight(t)+t.tipLabelBounds.width*this.treeState.labelSizeToPxFactor).attr("height",t=>Math.max(t.tipLabelSizePx,this.treeState.getCollapsedTriangleHeight(t)));const r=this.layers.hitLayer.selectAll(".collapsed-root-hit").data(t.collapsedParent?[t]:[],t=>t.id);r.exit().remove();r.enter().append("rect").attr("class","collapsed-root-hit").attr("fill","transparent").style("cursor","pointer").on("click",(t,e)=>{e.collapsedParent&&(this.isExpanding=!0,this.treeState.expandRoot()),t.stopPropagation()}).merge(r).attr("transform",t=>{if(!t.collapsedParent)return`translate(${t.xPx}, ${t.yPx})`;let n=0;if(e){const e=t.children||[];if(e.length>0){n=e.reduce((t,e)=>t+e.angle,0)/e.length*(180/Math.PI)}}return`translate(${t.xPx}, ${t.yPx}) rotate(${n})`}).attr("x",-i).attr("y",5*-n).attr("width",i).attr("height",10*n)}#y(t=!0){const e=this.treeState.displayedRoot;if(!e)return;const n=e.links(),i=this.treeState.labelSizeToPxFactor*this.treeState.state.branchThicknessProp,a=this.layers.branchLayer.selectAll(".branch-group").data(n,t=>t.target.id);t?a.exit().attr("opacity",0).remove():a.exit().remove();const o=a.enter().append("g").attr("class","branch-group");this.#B(o),this.isExpanding&&t&&o.attr("opacity",0);const s=o.merge(a);return this.#D(s,t,i),this.selections.branches=s,o}#B(t){t.append("path").attr("class","offset").attr("fill","none").attr("stroke","#000").attr("stroke-opacity",1).attr("stroke-linecap","round"),t.append("path").attr("class","extension").attr("fill","none").attr("stroke","#000").attr("stroke-opacity",1).attr("stroke-linecap","round")}#D(t,e,n){this.treeState.state.layout;const i=t.select(".offset"),a=t.select(".extension");e?(i.transition().duration(this.options.transitionDuration).attr("stroke-width",n).attr("d",t=>this.#F(t,"offset")),a.transition().duration(this.options.transitionDuration).attr("stroke-width",n).attr("d",t=>this.#F(t,"extension"))):(i.attr("stroke-width",n).attr("d",t=>this.#F(t,"offset")),a.attr("stroke-width",n).attr("d",t=>this.#F(t,"extension")))}#A(t,e,n,i,a,o){let s=a-i;o&&s<0?s+=2*Math.PI:!o&&s>0&&(s-=2*Math.PI);const r=Math.abs(s),l=Math.max(1,Math.ceil(r/(Math.PI/2))),h=s/l,c=4/3*Math.tan(h/4);let u="",d=i,p=t,f=e;for(let g=0;g<l;g++){const t=d+h,e=n*Math.cos(t),i=n*Math.sin(t);u+=` C${p-c*n*Math.sin(d)},${f+c*n*Math.cos(d)} ${e+c*n*Math.sin(t)},${i-c*n*Math.cos(t)} ${e},${i}`,d=t,p=e,f=i}return u}#F(t,e){const n="circular"===this.treeState.state.layout;if("offset"===e){if(n){t.source.radiusPx,t.target.cos,t.source.radiusPx,t.target.sin;const e=t.target.angle>t.source.angle,n=this.#A(t.source.xPx,t.source.yPx,t.source.radiusPx,t.source.angle,t.target.angle,e);return`M${t.source.xPx},${t.source.yPx}${n}`}{const e=t.source.xPx,n=t.source.yPx,i=t.source.xPx,a=t.target.yPx;return`M${e},${n} C${e},${n+(a-n)/3} ${i},${a-(a-n)/3} ${i},${a}`}}if(n){const e={x:t.source.radiusPx*t.target.cos,y:t.source.radiusPx*t.target.sin};return`M${e.x},${e.y} L${t.target.xPx},${t.target.yPx}`}return`M${t.source.xPx},${t.target.yPx} L${t.target.xPx},${t.target.yPx}`}#I(t){const e=.4330127*(n=this.treeState.getCollapsedTriangleHeight(t))*n;var n;return Fn().type(Dn).size(e)()}#b(t=!0){const e=this.treeState.displayedRoot;if(!e)return;this.treeState.state.layout;const n=e.descendants().filter(t=>!t.hidden),i=this.treeState.labelSizeToPxFactor*this.treeState.state.branchThicknessProp,a=this.#z(),o=this.layers.nodeLayer.selectAll(".node").data(n,t=>t.id);t?o.exit().attr("opacity",0).remove():o.exit().remove();const s=o.enter().append("g").attr("class","node").attr("transform",t=>`translate(${t.xPx}, ${t.yPx})`);this.#V(s,i),this.isExpanding&&t&&s.attr("opacity",0);const r=s.merge(o);return this.#q(r,t),this.#X(r,t),this.#O(r,t),this.#Y(r,t,i,a),this.selections.nodes=r,s}#V(t,e){t.append("path").attr("class","node-shape").attr("d",t=>t.collapsedChildren?this.#I(t):null).attr("fill","#000").style("display",t=>t.collapsedChildren?null:"none"),t.append("line").attr("class","collapsed-root-line").attr("stroke","#000").attr("stroke-width",e).style("display",t=>t.collapsedParent?null:"none"),t.filter(t=>t.tipLabelText&&""!==t.tipLabelText.trim()).append("text").attr("class","tip-label").style("text-anchor",t=>this.#j(t)).style("font-size",t=>`${t.tipLabelSizePx}px`).style("font-family",t=>t.tipLabelFont||"sans-serif").style("font-style",t=>t.tipLabelStyle||"normal").style("font-weight",t=>"bold"===t.tipLabelStyle?"bold":"normal").style("fill",t=>t.tipLabelColor||"#000").style("display",t=>t.children?"none":null).text(t=>t.tipLabelText||""),t.filter(t=>{if(!t.nodeLabelText||""===t.nodeLabelText.trim())return!1;if(!t.children)return!1;return t.children.filter(t=>!t.hidden).length>1}).append("text").attr("class","node-label").style("text-anchor",t=>this.#G(t)).style("font-size",t=>`${t.nodeLabelSizePx}px`).style("fill","#000").style("display",t=>t.children||t.collapsedChildren?null:"none").text(t=>t.nodeLabelText||"")}#q(t,e){e?t.transition("update node positions").duration(this.options.transitionDuration).attr("transform",t=>`translate(${t.xPx}, ${t.yPx}) rotate(${this.#H(t)})`):t.attr("transform",t=>`translate(${t.xPx}, ${t.yPx}) rotate(${this.#H(t)})`)}#X(t,e){const n="circular"===this.treeState.state.layout,i=t.selectAll(".tip-label");i.attr("x",t=>this.#Z(t)&&n?-t.tipLabelXOffsetPx:t.tipLabelXOffsetPx).style("text-anchor",t=>this.#j(t)).attr("transform",t=>`rotate(${this.#Z(t)&&n?180:0})`).text(t=>t.tipLabelText||"").style("fill",t=>t.tipLabelColor||"#000").style("font-family",t=>t.tipLabelFont||"sans-serif").style("font-style",t=>t.tipLabelStyle||"normal").style("display",t=>t.children?"none":null),e?i.transition("update tip labels").duration(this.options.transitionDuration).attr("dy",t=>t.tipLabelSizePx/2.5).style("font-size",t=>`${t.tipLabelSizePx}px`):i.attr("dy",t=>t.tipLabelSizePx/2.5).style("font-size",t=>`${t.tipLabelSizePx}px`);const a=t.selectAll(".node-label");a.attr("x",t=>this.#Z(t)&&n?t.nodeLabelXOffsetPx:-t.nodeLabelXOffsetPx).attr("transform",t=>`rotate(${this.#Z(t)&&n?180:0})`).style("text-anchor",t=>this.#G(t)).text(t=>t.nodeLabelText||"").style("display",t=>{if(!t.children&&!t.collapsedChildren)return"none";if(t.children){if(t.children.filter(t=>!t.hidden).length<=1)return"none"}return null}),e?a.transition("update node labels").duration(this.options.transitionDuration).attr("dy",t=>this.#U(t)).style("font-size",t=>`${t.nodeLabelSizePx}px`):a.attr("dy",t=>this.#U(t)).style("font-size",t=>`${t.nodeLabelSizePx}px`)}#O(t,e){const n=t.selectAll(".node-shape");n.attr("transform",t=>`rotate(-90) translate(0, ${this.treeState.getCollapsedTriangleOffset(t)})`).style("display",t=>t.collapsedChildren?null:"none"),e?n.transition().duration(this.options.transitionDuration).attr("d",t=>t.collapsedChildren?this.#I(t):null):n.attr("d",t=>t.collapsedChildren?this.#I(t):null)}#Y(t,e,n,i){const a=t.selectAll(".collapsed-root-line");e?a.transition().duration(this.options.transitionDuration).attr("x2",-i).attr("y2",0).attr("stroke-width",n).attr("stroke-dasharray",t=>t.collapsedParent?ti(i,n,4):null):a.attr("x2",-i).attr("y2",0).attr("stroke-width",n).attr("stroke-dasharray",t=>t.collapsedParent?ti(i,n,4):null),a.attr("x1",0).attr("y1",0).style("display",t=>t.collapsedParent?null:"none")}#H(t){if(!("circular"===this.treeState.state.layout))return 0;return t.angle*(180/Math.PI)}#j(t){return"circular"===this.treeState.state.layout&&this.#Z(t)?t.children?"start":"end":t.children?"end":"start"}#G(t){return"circular"===this.treeState.state.layout&&this.#Z(t)?t.children||t.collapsedChildren?"start":"end":t.children||t.collapsedChildren?"end":"start"}#U(t){const e=t.parent&&t.parent.yPx>t.yPx,n=t.nodeLabelSizePx;return e?.3*-n:1*n}#Z(t){return t.angle<1.5*Math.PI||t.angle>2.5*Math.PI}#z(){const t=this.treeState.displayedRoot;if(!t)return 0;if("circular"===this.treeState.state.layout){return Math.max(...t.leaves().map(t=>t.radiusPx))*this.treeState.state.collapsedRootLineProp*2}return Math.max(...t.leaves().map(t=>t.xPx))*this.treeState.state.collapsedRootLineProp}}function Vi(t,e,n){const i=t.getCurrentBoundsWithLegends(),a=i.maxX-i.minX,o=i.maxY-i.minY,s=e.width/a,r=e.height/o,l=Math.min(s,r),h=e.width+2*e.margin,c=e.height+2*e.margin,u=e.margin-i.minX*l,d=e.margin-i.minY*l,p=document.createElementNS("http://www.w3.org/2000/svg","svg");p.setAttribute("width",h),p.setAttribute("height",c),p.setAttribute("xmlns","http://www.w3.org/2000/svg");const f=document.createElementNS("http://www.w3.org/2000/svg","g");f.setAttribute("transform",`translate(${u}, ${d}) scale(${l})`);const g=t.layers.treeGroup.node().cloneNode(!0);g.removeAttribute("transform");const m=g.querySelector(".selection-rect");m&&m.remove(),f.appendChild(g),p.appendChild(f);const y=(new XMLSerializer).serializeToString(p);"svg"===e.format?function(t,e,n){const i=new Blob([t],{type:n}),a=URL.createObjectURL(i),o=document.createElement("a");o.href=a,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a)}(y,n,"image/svg+xml"):"png"===e.format&&function(t,e,n,i){const a=document.createElement("canvas");a.width=e,a.height=n;const o=a.getContext("2d"),s=new Image,r=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),l=URL.createObjectURL(r);s.onload=()=>{o.fillStyle="white",o.fillRect(0,0,e,n),o.drawImage(s,0,0),a.toBlob(t=>{const e=URL.createObjectURL(t),n=document.createElement("a");n.href=e,n.download=i,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(e),URL.revokeObjectURL(l)})},s.src=l}(y,h,c,n)}function qi(){const t=document.createElement("div");return t.className="ht-control-group",t}function Xi(t,e){const n=document.createElement("label");return n.className="ht-control-label",n.textContent=t,n.style.height=`${e}px`,n}function Oi(t,e="",n){const i=document.createElement("button");return i.className="ht-button",i.textContent=t,i.title=e,i.style.height=`${n}px`,i}function Yi(t,e,n,i,a){const o=document.createElement("input");return o.type="range",o.className="ht-slider",o.min=t,o.max=e,o.value=n,o.step=i,o.style.height=`${a}px`,o}function ji(t,e){const n=Math.min(24,e-4),i=n-4,a=document.createElement("div");a.className=t?"ht-toggle active":"ht-toggle",a.style.height=`${n}px`;const o=document.createElement("div");return o.className="ht-toggle-knob",o.style.width=`${i}px`,o.style.height=`${i}px`,a.appendChild(o),a}function Gi(t,e,n,i,a){const o=document.createElement("input");return o.type="number",o.className="ht-number-input",o.value=t,o.min=e,o.max=n,o.step=i,o.style.height=`${a}px`,o}function Zi(t,e,n,i,a,o,s){const r=24;let l=null,h=null,c=null,u=null,d=null,p=null,f=null,g=!0;const m=document.createElement("div");m.className="ht-toggle-container";const y=document.createElement("button");y.className="ht-control-panel-toggle",y.innerHTML='\n    <svg width="16" height="16" viewBox="0 0 16 16" class="ht-toggle-arrow">\n      <path d="M8 4 L12 8 L8 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" transform="rotate(-90 8 8)"/>\n    </svg>\n    <svg width="16" height="16" viewBox="0 0 16 16" class="ht-hamburger-icon">\n      <line x1="2" y1="4" x2="14" y2="4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n      <line x1="2" y1="8" x2="14" y2="8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n      <line x1="2" y1="12" x2="14" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n    </svg>\n  ',y.title="Toggle control panel",m.appendChild(y);const b=document.createElement("div");b.className="ht-collapsible-panel";const x=document.createElement("div");x.className="ht-tabs";const v=document.createElement("div");v.className="ht-controls hidden";const w=document.createElement("div");w.className="ht-aesthetic-settings hidden";const _=[{id:"data",label:"Data",requiresTree:!1},{id:"controls",label:"Controls",requiresTree:!0},{id:"tree-manipulation",label:"Tree",requiresTree:!0},{id:"tip-label-settings",label:"Tip Labels",requiresTree:!0},{id:"export",label:"Export",requiresTree:!0}],C={};function k(){const t=null!==n();if(_.forEach(e=>{const n=C[e.id];e.requiresTree&&!t?n.classList.add("disabled"):n.classList.remove("disabled")}),l){const e=_.find(t=>t.id===l);e&&e.requiresTree&&!t&&A("data")}}function S(){const t=n();return t&&t.state.treeData?t.state.treeData.getMetadataTableNames():[]}function L(){return h}function P(t){S().includes(t)?h=t:console.warn(`Metadata table not found: ${t}`)}function M(){const t=S();h=t.length>0?t[0]:null}function T(){const t=n();if(t){if(u){let e=!1;t.displayedRoot.each(n=>{n!==t.displayedRoot&&n.collapsedChildren&&(e=!0)}),u.disabled=!e}if(d&&(d.disabled=!t.displayedRoot.collapsedParent),p){let e=!1;t.state.treeData.tree.each(t=>{t.hiddenChildren&&t.hiddenChildren.length>0&&(e=!0)}),p.disabled=!e}}}function E(){const t=n();if(!t)return"tree";for(const[n,i]of e.entries())if(i===t.state.treeData)return n;return"tree"}function z(t,e){c!==t?($(),c=t,e.classList.add("ht-aesthetic-editing"),w.classList.remove("hidden"),N(t)):$()}function $(){if(!c)return;w.querySelectorAll(".ht-color-palette-editor").forEach(t=>{t.cleanupFunction&&"function"==typeof t.cleanupFunction&&t.cleanupFunction()});v.querySelectorAll(".ht-control-group").forEach(t=>t.classList.remove("ht-aesthetic-editing")),w.classList.add("hidden"),w.innerHTML="",c=null}function N(t){w.innerHTML="";const e=n();if(!e)return;if("tipLabelColor"===t)return void function(t,e,n){const i=e.state.aesthetics.tipLabelColor;if(!i){const e=document.createElement("div");return e.textContent="Select a metadata column for tip label color to edit its settings",e.style.padding="10px",e.style.color="#666",void t.appendChild(e)}const a=e.aestheticsScales.tipLabelColor;if(!a){const e=document.createElement("div");return e.textContent="Error: Could not find color aesthetic",e.style.padding="10px",e.style.color="#d00",void t.appendChild(e)}const o=a.createSettingsWidget({controlHeight:n});if(!o){const e=document.createElement("div");return e.textContent="No settings available for this aesthetic",e.style.padding="10px",e.style.color="#666",void t.appendChild(e)}t.appendChild(o);if(a.state.isCategorical){const o=qi(),s=Xi("Max colors:",n);o.appendChild(s);const r=Gi(a.state.maxCategories||7,2,100,1,n);r.addEventListener("input",t=>{const n=parseInt(t.target.value);isNaN(n)||n<1||(a.updateState({maxCategories:n}),a.updateScale(a.values),e.state.treeData.tree.each(t=>{const e=t[i];null!=e&&(t.tipLabelColor=a.getValue(e))}),e.updateCoordinates(),e.notify("legendsChange"))}),o.appendChild(r),t.appendChild(o)}const s=qi(),r=Xi("Legend title:",n);s.appendChild(r);const l=document.createElement("input");if(l.type="text",l.className="ht-text-input",l.style.height=`${n}px`,l.style.flex="1",l.value=a.state.title||"",l.placeholder="Enter legend title",l.addEventListener("input",t=>{a.updateState({title:t.target.value}),e.notify("legendsChange")}),s.appendChild(l),t.appendChild(s),!a.state.isCategorical){const i=qi(),o=Xi("Units label:",n);i.appendChild(o);const s=document.createElement("input");s.type="text",s.className="ht-text-input",s.style.height=`${n}px`,s.style.flex="1",s.value=a.state.inputUnits||"",s.placeholder="Enter units (e.g., C, km)",s.addEventListener("input",t=>{a.updateState({inputUnits:t.target.value}),e.notify("legendsChange")}),i.appendChild(s),t.appendChild(i)}}(w,e,r);const i=document.createElement("div");i.textContent=`Settings for ${t} (coming soon)`,i.style.padding="10px",w.appendChild(i)}function A(t){const e=_.find(e=>e.id===t);e&&e.requiresTree&&!n()||(l=t,Object.keys(C).forEach(e=>{e===t?C[e].classList.add("active"):C[e].classList.remove("active")}),v.classList.remove("hidden"),R(t))}function R(t){switch(v.innerHTML="",$(),t){case"data":!function(t,e,n,i,a,o,s,r,l,h,c,u){t.innerHTML="";const d=qi(),p=Xi("Select tree:",u);d.appendChild(p);const f=document.createElement("select");f.className="ht-select",f.style.height=`${u}px`;const g=Array.from(e.keys()),m=n(),y=m?Array.from(e.entries()).find(([t,e])=>e===m.state.treeData)?.[0]:null;if(0===g.length){const t=document.createElement("option");t.textContent="No trees loaded",t.value="",f.appendChild(t),f.disabled=!0}else g.forEach(t=>{const e=document.createElement("option");e.value=t,e.textContent=t,t===y&&(e.selected=!0),f.appendChild(e)}),f.addEventListener("change",t=>{i(t.target.value)});d.appendChild(f),t.appendChild(d);const b=document.createElement("input");b.type="file",b.accept=".nwk,.newick,.tree,.tre,.treefile",b.style.display="none",b.addEventListener("change",async t=>{const n=t.target.files[0];if(n)try{const t=await n.text();let o=n.name.replace(/\.(nwk|newick|tree|tre)$/i,""),s=o,r=1;for(;e.has(s);)s=`${o} (${r})`,r++;a(s,t),b.value="",h(),i(s)}catch(o){console.error("Error loading tree file:",o),alert(`Error loading tree file: ${o.message}`)}}),t.appendChild(b);const x=Oi("+","Add tree from Newick file",u);if(x.addEventListener("click",()=>{b.click()}),t.appendChild(x),!m)return;const v=qi(),w=Xi("Available metadata:",u);v.appendChild(w);const _=document.createElement("select");_.className="ht-select",_.style.height=`${u}px`;const C=o(),k=s();if(0===C.length){const t=document.createElement("option");t.textContent="No metadata",t.value="",_.appendChild(t),_.disabled=!0}else C.forEach(t=>{const e=document.createElement("option");e.value=t,e.textContent=t,t===k&&(e.selected=!0),_.appendChild(e)}),_.addEventListener("change",t=>{r(t.target.value),h()});v.appendChild(_),t.appendChild(v);const S=document.createElement("input");S.type="file",S.accept=".tsv,.csv,.txt",S.style.display="none",S.addEventListener("change",async t=>{const e=t.target.files[0];if(!e)return;const i=n();if(!i||!i.state.treeData)return alert("No tree selected. Please select a tree first."),void(S.value="");try{const t=await e.text();let n=e.name.replace(/\.(tsv|csv|txt)$/i,""),a="\t";e.name.toLowerCase().endsWith(".csv")&&(a=",");const o=i.state.treeData.addTable(t,n,a),s=i.state.treeData.metadataTableNames.get(o);S.value="",r(s),h()}catch(a){console.error("Error loading metadata file:",a),alert(`Error loading metadata file: ${a.message}`),S.value=""}}),t.appendChild(S);const L=Oi("+","Add metadata table",u);if(L.addEventListener("click",()=>{const t=n();t&&t.state.treeData?S.click():alert("No tree selected. Please select a tree first.")}),t.appendChild(L),k){const e=m.state.treeData;let n=null;for(const[t,i]of e.metadataTableNames.entries())if(i===k){n=t;break}if(n){const i=e.getValidIdColumns(n),a=e.getNodeIdColumn(n),o=qi(),s=Xi("Node/Tip ID Column:",u);o.appendChild(s);const r=document.createElement("select");if(r.className="ht-select",r.style.height=`${u}px`,0===i.length){const t=document.createElement("option");t.textContent="No ID column found",t.value="",r.appendChild(t),r.disabled=!0}else i.forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=e.columnName.get(t),t===a&&(n.selected=!0),r.appendChild(n)}),r.addEventListener("change",t=>{const i=t.target.value;e.setNodeIdColumn(n,i),m.updateCoordinates(),h()});o.appendChild(r),t.appendChild(o)}}}(v,e,n,a,o,S,L,P,0,H,0,r);break;case"controls":!function(t,e,n,i,a){t.innerHTML="";const o=e(),s=n();if(!o||!s)return void(t.textContent="No tree selected");const r=Oi("Fit to view","Fit the tree to the current view window",a);r.addEventListener("click",()=>{s.fitToView({transition:!0,autoPan:"Both",autoZoom:"Both"})}),t.appendChild(r);const l=qi(),h=Xi("Manual zoom/pan:",a);l.appendChild(h);const c=ji(s.options.manualZoomAndPanEnabled,a);c.addEventListener("click",()=>{s.options.manualZoomAndPanEnabled=!s.options.manualZoomAndPanEnabled,s.options.manualZoomAndPanEnabled?c.classList.add("active"):(c.classList.remove("active"),s.fitToView()),s.initializeZoom()}),l.appendChild(c),t.appendChild(l);const u=qi(),d=Xi("Auto-zoom:",a);u.appendChild(d);const p=document.createElement("select");p.className="ht-select",p.style.height=`${a}px`;["Default","Both","X","Y","None"].forEach(t=>{const e=document.createElement("option");e.value=t,e.textContent=t,t===s.options.autoZoom&&(e.selected=!0),p.appendChild(e)}),p.addEventListener("change",t=>{s.options.autoZoom=t.target.value}),u.appendChild(p),t.appendChild(u);const f=qi(),g=Xi("Auto-pan:",a);f.appendChild(g);const m=document.createElement("select");m.className="ht-select",m.style.height=`${a}px`;["Default","Both","X","Y","None"].forEach(t=>{const e=document.createElement("option");e.value=t,e.textContent=t,t===s.options.autoPan&&(e.selected=!0),m.appendChild(e)}),m.addEventListener("change",t=>{s.options.autoPan=t.target.value}),f.appendChild(m),t.appendChild(f)}(v,n,i,0,r);break;case"tree-manipulation":!function(t,e,n,i,a,o,s,r,l){t.innerHTML="";const h=e();if(!h)return void(t.textContent="No tree selected");const c=Oi("Expand subtrees","Expand all collapsed subtrees",o),u=()=>{let t=!1;return h.displayedRoot.each(e=>{e!==h.displayedRoot&&e.collapsedChildren&&(t=!0)}),t};c.disabled=!u(),c.addEventListener("click",()=>{const t=[];h.displayedRoot.each(e=>{if(e!==h.displayedRoot&&e.collapsedChildren){let n=!0,i=e.parent;for(;i&&i!==h.displayedRoot;){if(i.collapsedChildren){n=!1;break}i=i.parent}n&&t.push(e)}}),t.forEach(t=>{h.expandSubtree(t)}),i()}),s(c),t.appendChild(c);const d=Oi("Expand root","Expand the collapsed root",o);d.disabled=!h.displayedRoot.collapsedParent,d.addEventListener("click",()=>{h.displayedRoot.collapsedParent&&(h.expandRoot(),i())}),r(d),t.appendChild(d);const p=Oi("Show hidden","Show all hidden nodes",o),f=()=>{let t=!1;return h.state.treeData.tree.each(e=>{e.hiddenChildren&&e.hiddenChildren.length>0&&(t=!0)}),t};p.disabled=!f(),p.addEventListener("click",()=>{h.showAllHidden(),i()}),l(p),t.appendChild(p);const g=qi(),m=Xi("Branch length:",o);g.appendChild(m);const y=(t,e=10)=>{const n=Math.log10(1/e),i=Math.log10(e);return(Math.log10(t)-n)/(i-n)*100},b=(t,e=10)=>{const n=Math.log10(1/e),i=n+t/100*(Math.log10(e)-n);return Math.pow(10,i)},x=Yi(0,100,y(h.state.branchLengthScale),.1,o);x.addEventListener("input",t=>{const e=parseFloat(t.target.value),n=b(e);h.setBranchLengthScale(n)}),g.appendChild(x),t.appendChild(g);const v=qi(),w=Xi("Tree height:",o);v.appendChild(w);const _=Yi(0,100,y(h.state.treeHeightScale),.1,o);_.addEventListener("input",t=>{const e=parseFloat(t.target.value),n=b(e);h.setTreeHeightScale(n)}),v.appendChild(_),t.appendChild(v);const C=qi(),k=Xi("Radial layout:",o);C.appendChild(k);const S=ji("circular"===h.state.layout,o),L=()=>{"circular"===h.state.layout?S.classList.add("active"):S.classList.remove("active")};h.subscribe("layoutChange",L),S.addEventListener("click",()=>{const t=h.state.layout;h.setLayout("circular"===t?"rectangular":"circular")}),C.appendChild(S),t.appendChild(C)}(v,n,0,T,0,r,t=>{u=t},t=>{d=t},t=>{p=t});break;case"tip-label-settings":!function(t,e,n,i,a,o,s,r){t.innerHTML="";const l=e();if(!l)return void(t.textContent="No tree selected");const h='\n    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n      <path d="M11.5 1.5L14.5 4.5L5 14H2V11L11.5 1.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>\n      <path d="M10 3L13 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>\n    </svg>\n  ',c=qi(),u=Xi("Text:",i);c.appendChild(u);const d=Ui(l,"tipLabelText","Default",i,!0,null,r,s);c.appendChild(d),t.appendChild(c);const p=qi(),f=Xi("Color:",i);p.appendChild(f);const g=function(t,e="",n){const i=document.createElement("button");return i.className="ht-icon-button",i.innerHTML=t,i.title=e,i.style.height=`${n}px`,i.style.width=`${n}px`,i}(h,"Edit color settings",i);g.addEventListener("click",t=>{t.stopPropagation(),a("tipLabelColor",p)}),p.appendChild(g);const m=Ui(l,"tipLabelColor","Default",i,!1,null,r,s);p.appendChild(m),t.appendChild(p);const y=qi(),b=Xi("Size:",i);y.appendChild(b);const x=Ui(l,"tipLabelSize","Default",i,!1,!0,r,s);y.appendChild(x),t.appendChild(y);const v=qi(),w=Xi("Style:",i);v.appendChild(w);const _=Ui(l,"tipLabelStyle","Default",i,!1,!1,r,s);v.appendChild(_),t.appendChild(v);const C=qi(),k=Xi("Font:",i);C.appendChild(k);const S=document.createElement("select");S.className="ht-select",S.style.height=`${i}px`;const L=["sans-serif","serif","monospace"],P=void 0!==l.state.aesthetics.tipLabelFont?l.aestheticsScales.tipLabelFont.getValue():"sans-serif";L.forEach(t=>{const e=document.createElement("option");e.value=t,e.textContent=t,t===P&&(e.selected=!0),S.appendChild(e)}),S.addEventListener("change",t=>{const e=t.target.value;l.setAesthetics({tipLabelFont:void 0}),l.state.treeData.tree.each(t=>{t.tipLabelFont=e}),l.updateCoordinates()}),C.appendChild(S),t.appendChild(C)}(v,n,0,r,z,0,N,()=>c);break;case"export":!function(t,e,n,i,a,o){t.innerHTML="";const s=e(),r=n();if(!s||!r)return void(t.textContent="No tree selected");const l=r.getCurrentBoundsWithLegends(),h=l.maxX-l.minX,c=l.maxY-l.minY,u={format:"svg",width:h,height:c,margin:18},d=h/c,p=300,f=2.54,g=t=>t/p*f,m=t=>t/f*p,y=(t,e)=>"png"===e?Math.round(t):Math.round(100*g(t))/100,b=(t,e)=>"png"===e?t:m(t),x=()=>{const t=r.getCurrentBoundsWithLegends(),e=t.maxX-t.minX,n=t.maxY-t.minY;u.width=e,u.height=n,M.value=y(e,u.format),z.value=y(n,u.format)},v=s.subscribe("coordinateChange",x),w=s.subscribe("legendsChange",x);t.dataset.cleanup=()=>{v(),w()};const _=Oi("Export","Export the tree to a file",o);_.classList.add("primary"),_.addEventListener("click",()=>{const t=i().replace(/[^a-z0-9_-]/gi,"_"),e="svg"===u.format?"svg":"png";Vi(r,u,`${t}.${e}`)}),t.appendChild(_);const C=qi(),k=Xi("Output format:",o);C.appendChild(k);const S=document.createElement("select");S.className="ht-select",S.style.height=`${o}px`,["SVG","PNG"].forEach(t=>{const e=document.createElement("option");e.value=t.toLowerCase(),e.textContent=t,t.toLowerCase()===u.format&&(e.selected=!0),S.appendChild(e)}),S.addEventListener("change",t=>{u.format=t.target.value,M.value=y(u.width,u.format),z.value=y(u.height,u.format),A.value=y(u.margin,u.format);const e="png"===u.format?"px":"cm";P.textContent=`Width (${e}):`,E.textContent=`Height (${e}):`,N.textContent=`Margin (${e}):`}),C.appendChild(S),t.appendChild(C);const L=qi(),P=Xi(`Width (${"png"===u.format?"px":"cm"}):`,o);L.appendChild(P);const M=Gi(y(u.width,u.format),.1,1e4,.1,o);M.addEventListener("input",t=>{const e=parseFloat(t.target.value);isNaN(e)||e<=0||(u.width=b(e,u.format),u.height=u.width/d,z.value=y(u.height,u.format))}),L.appendChild(M),t.appendChild(L);const T=qi(),E=Xi(`Height (${"png"===u.format?"px":"cm"}):`,o);T.appendChild(E);const z=Gi(y(u.height,u.format),.1,1e4,.1,o);z.addEventListener("input",t=>{const e=parseFloat(t.target.value);isNaN(e)||e<=0||(u.height=b(e,u.format),u.width=u.height*d,M.value=y(u.width,u.format))}),T.appendChild(z),t.appendChild(T);const $=qi(),N=Xi(`Margin (${"png"===u.format?"px":"cm"}):`,o);$.appendChild(N);const A=Gi(y(u.margin,u.format),0,100,.1,o);A.addEventListener("input",t=>{const e=parseFloat(t.target.value);isNaN(e)||e<0||(u.margin=b(e,u.format))}),$.appendChild(A),t.appendChild($)}(v,n,i,E,0,r)}}function H(){M(),f&&(f(),f=null),u=null,d=null,p=null;const t=n();t&&(f=t.subscribe("coordinateChange",T)),k(),l&&R(l)}return _.forEach(t=>{const e=document.createElement("div");e.className="ht-tab",e.textContent=t.label,e.addEventListener("click",()=>{e.classList.contains("disabled")||($(),l===t.id?(l=null,Object.keys(C).forEach(t=>{C[t].classList.remove("active")}),v.classList.add("hidden"),v.innerHTML="",$()):A(t.id))}),C[t.id]=e,x.appendChild(e)}),v.addEventListener("click",t=>{const e=t.target.closest(".ht-icon-button"),n=t.target.closest(".ht-control-group.ht-aesthetic-editing");e||n||$()}),y.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),g=!g,g?(b.classList.remove("ht-panel-collapsed"),y.classList.remove("collapsed")):($(),b.classList.add("ht-panel-collapsed"),y.classList.add("collapsed"))}),b.appendChild(x),b.appendChild(v),b.appendChild(w),t.appendChild(m),t.appendChild(b),k(),A(_[0].id),M(),H}function Ui(t,e,n,i,a=!1,o=null,s=null,r=null){const l=document.createElement("select");if(l.className="ht-select",l.style.height=`${i}px`,l.style.flex="1",a){const t=document.createElement("option");t.value="none",t.textContent="None",l.appendChild(t)}const h=document.createElement("option");h.value="",h.textContent=n,l.appendChild(h);const c=t.state.treeData,u=Array.from(c.columnDisplayName.keys());let d=u;null!==o&&(d=o?u.filter(t=>"continuous"===c.columnType.get(t)):u.filter(t=>"categorical"===c.columnType.get(t))),d.forEach(n=>{const i=document.createElement("option");i.value=n,i.textContent=c.columnDisplayName.get(n),t.state.aesthetics[e]===n&&(i.selected=!0),l.appendChild(i)});const p=t.state.aesthetics[e];return l.value=null===p?"none":void 0===p||""===p?"":p,l.addEventListener("change",n=>{let i;i="none"===n.target.value?null:""===n.target.value?void 0:n.target.value;const a={};if(a[e]=i,t.setAesthetics(a),s&&r){s()===e&&r(e)}}),l}t.heatTree=function(t,e=[],n={}){e&&!Array.isArray(e)&&(e=[e]),null==e&&(e=[]),function(){const t="heat-tree-styles";if(!document.getElementById(t)){const e=document.createElement("style");e.id=t,e.textContent=".ht-widget{display:flex;flex-direction:column;width:100%;height:100%}.ht-toolbar{flex:0 0 auto;margin-bottom:4px;display:flex;flex-direction:column;position:relative}.ht-toggle-container{position:absolute;top:0;right:0;padding:4px 8px;z-index:10}.ht-control-panel-toggle{background-color:transparent;border:none;cursor:pointer;padding:4px;display:flex;align-items:center;gap:4px;transition:opacity .2s}.ht-control-panel-toggle:hover{opacity:.7}.ht-control-panel-toggle .ht-toggle-arrow{transition:transform .3s}.ht-control-panel-toggle.collapsed .ht-toggle-arrow{transform:rotate(180deg)}.ht-control-panel-toggle .ht-hamburger-icon{color:#333}.ht-collapsible-panel{max-height:1000px;overflow:hidden;transition:max-height .3s ease-in-out}.ht-collapsible-panel.ht-panel-collapsed{max-height:0}.ht-tabs{display:flex;gap:20px;padding:4px 8px;background-color:#f5f5f5;border-bottom:2px solid #ddd;-webkit-user-select:none;user-select:none}.ht-tab{cursor:pointer;padding:2px 4px;font-family:sans-serif;font-size:14px;color:#333;border-bottom:2px solid transparent;transition:all .2s}.ht-tab:hover{color:#666}.ht-tab.active{color:#000;font-weight:700;border-bottom-color:#007bff}.ht-tab.active:hover{color:#000}.ht-tab.disabled{color:#999;cursor:not-allowed;opacity:.5}.ht-tab.disabled:hover{color:#999}.ht-controls{padding:2px 8px;background-color:#fafafa;border-bottom:1px solid #ddd;display:flex;flex-wrap:wrap;column-gap:8px;row-gap:2px;align-items:center;min-height:26px}.ht-controls.hidden{display:none}.ht-control-group{display:flex;align-items:center;gap:4px;white-space:nowrap;padding:2px 0;border-bottom:2px solid transparent;transition:border-bottom-color .2s}.ht-control-group.ht-aesthetic-editing{border-bottom-color:#007bff}.ht-control-label{font-family:sans-serif;font-size:14px;color:#333;white-space:nowrap;display:flex;align-items:center}.ht-button{font-size:14px;font-family:sans-serif;background-color:#e0e0e0;border:1px solid #ccc;border-radius:4px;cursor:pointer;transition:background-color .2s;white-space:nowrap}.ht-button:hover{background-color:#d0d0d0}.ht-button:disabled{background-color:#f0f0f0;color:#999;cursor:not-allowed}.ht-button.primary{background-color:#007bff;color:#fff;font-weight:700}.ht-button.primary:hover{background-color:#0056b3}.ht-icon-button{font-size:14px;font-family:sans-serif;background-color:#e0e0e0;border:1px solid #ccc;border-radius:4px;cursor:pointer;transition:background-color .2s;display:flex;align-items:center;justify-content:center;padding:2px}.ht-icon-button:hover{background-color:#d0d0d0}.ht-icon-button svg{display:block}.ht-select{padding:1px 2px;font-size:14px;border:1px solid #ccc;border-radius:4px}.ht-slider{cursor:pointer;width:150px}.ht-toggle{width:50px;background-color:#ccc;border-radius:12px;position:relative;cursor:pointer;transition:background-color .3s;flex-shrink:0}.ht-toggle.active{background-color:#007bff}.ht-toggle-knob{background-color:#fff;border-radius:50%;position:absolute;top:2px;left:2px;transition:left .3s}.ht-toggle.active .ht-toggle-knob{left:calc(100% - 2px);transform:translate(-100%)}.ht-number-input{font-size:14px;border:1px solid #ccc;border-radius:4px;width:80px}.ht-text-input{font-size:14px;border:1px solid #ccc;border-radius:4px;padding:2px 4px;width:100px}.ht-aesthetic-settings{padding:2px 8px;background-color:#f0f0f0;border-bottom:1px solid #ddd;display:flex;flex-wrap:wrap;column-gap:8px;row-gap:2px;align-items:center;max-height:1000px;overflow:hidden;transition:max-height .3s ease-in-out,padding .3s ease-in-out}.ht-aesthetic-settings.hidden{max-height:0;padding-top:0;padding-bottom:0;border-bottom:none}.ht-color-palette-editor{display:flex;gap:8px;align-items:center}.ht-palette-buttons-container{display:flex;flex-direction:column;gap:2px}.ht-palette-button{width:24px;height:24px;font-size:14px;font-weight:700;background-color:#e0e0e0;border:1px solid #ccc;border-radius:4px;cursor:pointer;transition:background-color .2s}.ht-palette-button:hover{background-color:#d0d0d0}.ht-gradient-container{display:flex;gap:8px}.ht-gradient-column{display:flex;flex-direction:column;gap:4px}.ht-color-squares-container{display:flex;position:relative;height:16px;width:200px}.ht-color-square-wrapper{position:absolute;display:flex;flex-direction:column;align-items:center;transform:translate(-50%)}.ht-color-square{width:12px;height:12px;border:2px solid #333;border-radius:4px;cursor:pointer}.ht-color-square-tick{width:2px;height:8px;background-color:#333}.ht-gradient-box{width:200px;height:24px;border:1px solid #ccc;border-radius:4px;position:relative}.ht-range-slider-container{width:200px;height:12px;position:relative;border:1px solid #ccc;border-radius:4px;background:#f0f0f0;display:flex;align-items:center}.ht-range-handle{position:absolute;width:12px;height:12px;border:2px solid #333;border-radius:4px;cursor:ew-resize;transform:translate(-50%)}.ht-range-handle-indicator{position:absolute;bottom:90%;left:50%;transform:translate(-50%) rotate(180deg);width:0;height:0;border-left:4px solid transparent;border-right:4px solid transparent;border-top:6px solid #333;border-radius:2px;margin-bottom:2px}.ht-null-color-column{display:flex;flex-direction:column;gap:4px}.ht-null-color-square-container{display:flex;position:relative;height:16px;justify-content:center}.ht-null-color-square{width:12px;height:12px;border:2px solid #333;border-radius:4px;cursor:pointer}.ht-null-color-square-tick{width:2px;height:6px;background-color:#333;position:absolute;bottom:-6px;left:50%;transform:translate(-50%)}.ht-null-color-box{width:16px;height:24px;border:1px solid #ccc;border-radius:4px;position:relative}.missing-data-x-container{position:relative;display:flex;align-items:center;justify-content:center}.missing-data-x-container-triangle{position:absolute;bottom:85%;left:50%;transform:translate(-50%) rotate(180deg);width:0;height:0;border-left:4px solid transparent;border-right:4px solid transparent;border-top:6px solid #333;border-radius:2px;margin-bottom:2px}.missing-data-x{font-size:16px;color:#d00;font-weight:700;line-height:1;-webkit-user-select:none;user-select:none;cursor:pointer}.ht-tree{flex:1 1 auto;min-height:0;position:relative}.ht-tree svg{display:block}.picker_wrapper,.picker_wrapper.popup{z-index:999999!important;position:fixed!important}.picker_wrapper *,.picker_selector,.picker_slider,.picker_editor,.picker_sample,.picker_done,.picker_cancel{pointer-events:auto!important}",document.head.appendChild(e)}}(),n={buttonSize:25,transitionDuration:500,manualZoomAndPanEnabled:!0,autoZoom:"Default",autoPan:"Default",...n};const i=new Ni,a=new Map,o=new Map;e.forEach((t,e)=>{if(!t.newick)throw new Error(`Tree at index ${e} is missing newick string`);const n=t.name||`Tree ${e+1}`;let i=[],s=[];if(t.metadata){(Array.isArray(t.metadata)?t.metadata:[t.metadata]).forEach((t,e)=>{t.name&&t.data?(i.push(t.data),s.push(t.name)):(i.push(t),s.push(`Metadata ${e+1}`))})}const r=new zi(t.newick,i,s);let l;l=t.aesthetics?Object.fromEntries(Object.entries(t.aesthetics).map(([t,e])=>{for(const[n,i]of r.columnName.entries())if(i===e)return[t,n]})):void 0,a.set(n,r),o.set(n,l)});const s=new Map,r=new Map,l=document.querySelector(t);if(!l)throw new Error(`Container element not found: ${t}`);const h=document.createElement("div");h.className="ht-widget";const c=document.createElement("div");c.className="ht-toolbar";const u=document.createElement("div");u.className="ht-tree";const d=document.createElementNS("http://www.w3.org/2000/svg","svg");d.setAttribute("width","100%"),d.setAttribute("height","100%"),u.appendChild(d),h.appendChild(c),h.appendChild(u),l.appendChild(h);let p=null,f=null,g=null,m=null;function y(t,e,n=[],i=[]){let o=t,s=1;for(;a.has(o);)o=`${t} (${s})`,s++;const r=new zi(e,n,i);return a.set(o,r),o}function b(t){if(a.has(t)){if(p!==t||!g){for(;d.firstChild;)d.removeChild(d.firstChild);if(!s.has(t)){const e=new Ai({treeData:a.get(t),aesthetics:o.get(t),...n},i);s.set(t,e)}if(r.has(t)){r.get(t).reattach(d)}else{const e=s.get(t),i=new Ii(e,d,n);r.set(t,i)}p=t,f=s.get(t),g=r.get(t),m&&m()}}else console.error(`Tree not found: ${t}`)}if(new oi(u,t=>{g&&g.fitToView()},{debounce:100,immediate:!0}),m=Zi(c,a,()=>f,()=>g,b,y),a.size>0){b(Array.from(a.keys())[0])}return{treeDataInstances:a,treeStateCache:s,treeViewCache:r,getCurrentTreeState:()=>f,getCurrentTreeView:()=>g,getCurrentTreeName:()=>p,switchToTree:b,addNewTree:y,container:h}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=heat-tree.umd.min.js.map
